{
  if (deleteDelay == -1) {
    deleteDelay=defaultDeleteDelaySeconds;
  }
  ReadWriteLock dagLock=getDagLock(dagName);
  dagLock.writeLock().lock();
  try {
    rememberCompletedDag(dagName);
    LOG.info("Processing queryComplete for dagName={} with deleteDelay={} seconds",dagName,deleteDelay);
    QueryInfo queryInfo=queryInfoMap.remove(dagName);
    if (queryInfo == null) {
      LOG.warn("Ignoring query complete for unknown dag: {}",dagName);
      return Collections.emptyList();
    }
    String[] localDirs=queryInfo.getLocalDirsNoCreate();
    if (localDirs != null) {
      for (      String localDir : localDirs) {
        cleanupDir(localDir,deleteDelay);
        ShuffleHandler.get().unregisterDag(localDir,dagName,queryInfo.getDagIdentifier());
      }
    }
    sourceCompletionMap.remove(dagName);
    String savedQueryId=dagNameToQueryId.remove(dagName);
    queryId=queryId == null ? savedQueryId : queryId;
    dagSpecificLocks.remove(dagName);
    if (queryId != null) {
      ObjectCacheFactory.removeLlapQueryCache(queryId);
    }
    return queryInfo.getRegisteredFragments();
  }
  finally {
    dagLock.writeLock().unlock();
  }
}
