{
  if (!isEnabled) {
    return FORWARD;
  }
 else   if (topN == 0) {
    return EXCLUDE;
  }
  if (usage > threshold) {
    int excluded=this.excluded;
    LOG.info("Top-N hash is flushing rows");
    flushInternal();
    if (excluded == 0) {
      LOG.info("Top-N hash has been disabled");
      isEnabled=false;
      return FORWARD;
    }
  }
  batchSize=size;
  if (batchIndexToResult == null || batchIndexToResult.length < batchSize) {
    batchIndexToResult=new int[Math.max(batchSize,VectorizedRowBatch.DEFAULT_SIZE)];
  }
  if (indexToBatchIndex == null) {
    indexToBatchIndex=new int[topN + 1];
  }
  Arrays.fill(indexToBatchIndex,-1);
  batchNumForwards=0;
  return 0;
}
