{
  String dbName="default";
  String tblName="cws";
  List<String> colNames=Arrays.asList("a","b");
  String columnNamesProperty="a,b";
  String columnTypesProperty="int:string";
  executeStatementOnDriver("drop table if exists " + tblName,driver);
  executeStatementOnDriver("CREATE TABLE " + tblName + "(a INT, b STRING) "+ " CLUSTERED BY(a) INTO 1 BUCKETS"+ " STORED AS ORC  TBLPROPERTIES ('transactional'='true',"+ "'transactional_properties'='default')",driver);
  HiveEndPoint endPt=new HiveEndPoint(null,dbName,tblName,null);
  DelimitedInputWriter writer=new DelimitedInputWriter(new String[]{"a","b"},",",endPt);
  StreamingConnection connection=endPt.newConnection(false,"UT_" + Thread.currentThread().getName());
  try {
    for (int i=0; i < 2; i++) {
      writeBatch(connection,writer,false);
    }
    writeBatch(connection,writer,true);
    TxnStore txnHandler=TxnUtils.getTxnStore(conf);
    txnHandler.compact(new CompactionRequest(dbName,tblName,CompactionType.MINOR));
    Worker t=new Worker();
    t.setThreadId((int)t.getId());
    t.setHiveConf(conf);
    AtomicBoolean stop=new AtomicBoolean(true);
    AtomicBoolean looped=new AtomicBoolean();
    t.init(stop,looped);
    t.run();
    IMetaStoreClient msClient=new HiveMetaStoreClient(conf);
    Table table=msClient.getTable(dbName,tblName);
    FileSystem fs=FileSystem.get(conf);
    FileStatus[] stat=fs.listStatus(new Path(table.getSd().getLocation()),AcidUtils.deltaFileFilter);
    String[] names=new String[stat.length];
    Path resultFile=null;
    for (int i=0; i < names.length; i++) {
      names[i]=stat[i].getPath().getName();
      if (names[i].equals("delta_0000001_0000004")) {
        resultFile=stat[i].getPath();
      }
    }
    Arrays.sort(names);
    String[] expected=new String[]{"delta_0000001_0000002","delta_0000001_0000004","delta_0000003_0000004","delta_0000005_0000006"};
    if (!Arrays.deepEquals(expected,names)) {
      Assert.fail("Expected: " + Arrays.toString(expected) + ", found: "+ Arrays.toString(names));
    }
    checkExpectedTxnsPresent(null,new Path[]{resultFile},columnNamesProperty,columnTypesProperty,0,1L,4L);
    FileStatus[] deleteDeltaStat=fs.listStatus(new Path(table.getSd().getLocation()),AcidUtils.deleteEventDeltaDirFilter);
    String[] deleteDeltas=new String[deleteDeltaStat.length];
    Path minorCompactedDeleteDelta=null;
    for (int i=0; i < deleteDeltas.length; i++) {
      deleteDeltas[i]=deleteDeltaStat[i].getPath().getName();
      if (deleteDeltas[i].equals("delete_delta_0000001_0000004")) {
        minorCompactedDeleteDelta=deleteDeltaStat[i].getPath();
      }
    }
    Arrays.sort(deleteDeltas);
    String[] expectedDeleteDeltas=new String[]{"delete_delta_0000001_0000004"};
    if (!Arrays.deepEquals(expectedDeleteDeltas,deleteDeltas)) {
      Assert.fail("Expected: " + Arrays.toString(expectedDeleteDeltas) + ", found: "+ Arrays.toString(deleteDeltas));
    }
    checkExpectedTxnsPresent(null,new Path[]{minorCompactedDeleteDelta},columnNamesProperty,columnTypesProperty,0,0L,0L);
  }
  finally {
    connection.close();
  }
}
