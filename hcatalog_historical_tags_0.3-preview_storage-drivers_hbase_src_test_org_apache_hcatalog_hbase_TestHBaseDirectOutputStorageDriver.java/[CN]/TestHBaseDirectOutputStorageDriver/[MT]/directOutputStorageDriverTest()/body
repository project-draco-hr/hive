{
  String testName="directOutputStorageDriverTest";
  Path methodTestDir=new Path(getTestDir(),testName);
  String databaseName="default";
  String dbDir=new Path(methodTestDir,"DB_" + testName).toString();
  String tableName=newTableName(testName).toLowerCase();
  byte[] tableNameBytes=Bytes.toBytes(tableName);
  String familyName="my_family";
  byte[] familyNameBytes=Bytes.toBytes(familyName);
  Configuration conf=new Configuration(allConf);
  conf.set(HCatConstants.HCAT_KEY_HIVE_CONF,HCatUtil.serialize(allConf.getAllProperties()));
  String dbquery="CREATE DATABASE IF NOT EXISTS " + databaseName + " LOCATION '"+ dbDir+ "'";
  String tableQuery="CREATE TABLE " + databaseName + "."+ tableName+ "(key int, english string, spanish string) STORED BY "+ "'org.apache.hcatalog.hbase.HBaseHCatStorageHandler'"+ "TBLPROPERTIES ('"+ HBaseConstants.PROPERTY_OSD_BULK_MODE_KEY+ "'='false',"+ "'hbase.columns.mapping'=':key,"+ familyName+ ":english,"+ familyName+ ":spanish')";
  assertEquals(0,hcatDriver.run(dbquery).getResponseCode());
  assertEquals(0,hcatDriver.run(tableQuery).getResponseCode());
  String data[]={"1,english:ONE,spanish:UNO","2,english:ONE,spanish:DOS","3,english:ONE,spanish:TRES"};
  Path inputPath=new Path(methodTestDir,"mr_input");
  getFileSystem().mkdirs(inputPath);
  for (int i=0; i < data.length; i++) {
    FSDataOutputStream os=getFileSystem().create(new Path(inputPath,"inputFile" + i + ".txt"));
    os.write(Bytes.toBytes(data[i] + "\n"));
    os.close();
  }
  Job job=new Job(conf,testName);
  job.setWorkingDirectory(new Path(methodTestDir,"mr_work"));
  job.setJarByClass(this.getClass());
  job.setMapperClass(MapHCatWrite.class);
  job.setInputFormatClass(TextInputFormat.class);
  TextInputFormat.setInputPaths(job,inputPath);
  job.setOutputFormatClass(HCatOutputFormat.class);
  OutputJobInfo outputJobInfo=OutputJobInfo.create(databaseName,tableName,null,null,null);
  long lbTimestamp=System.currentTimeMillis();
  HCatOutputFormat.setOutput(job,outputJobInfo);
  job.setMapOutputKeyClass(BytesWritable.class);
  job.setMapOutputValueClass(HCatRecord.class);
  job.setOutputKeyClass(BytesWritable.class);
  job.setOutputValueClass(Put.class);
  job.setNumReduceTasks(0);
  assertTrue(job.waitForCompletion(true));
  long ubTimestamp=System.currentTimeMillis();
  HTable table=new HTable(conf,tableName);
  Scan scan=new Scan();
  scan.addFamily(familyNameBytes);
  ResultScanner scanner=table.getScanner(scan);
  int index=0;
  long prevTimestamp=-1;
  for (  Result result : scanner) {
    String vals[]=data[index].toString().split(",");
    for (int i=1; i < vals.length; i++) {
      String pair[]=vals[i].split(":");
      assertTrue(result.containsColumn(familyNameBytes,Bytes.toBytes(pair[0])));
      assertEquals(pair[1],Bytes.toString(result.getValue(familyNameBytes,Bytes.toBytes(pair[0]))));
      long timestamp=result.getColumn(familyNameBytes,Bytes.toBytes(pair[0])).get(0).getTimestamp();
      if (prevTimestamp < 1)       prevTimestamp=timestamp;
 else       assertEquals(prevTimestamp + "=" + timestamp,prevTimestamp,timestamp);
      assertTrue(lbTimestamp + "<=" + timestamp+ "<="+ ubTimestamp,timestamp >= lbTimestamp && timestamp <= ubTimestamp);
    }
    index++;
  }
  assertEquals(data.length,index);
}
