{
  while (true) {
    lock.lock();
    try {
      while (!shouldRun) {
        triggerRunCondition.await();
      }
      shouldRun=false;
    }
  finally {
      lock.unlock();
    }
    TaskInfo taskInfo=delayedTaskQueue.peek();
    if (taskInfo == null) {
      LOG.info("Triggered getTask but the queue is empty");
      lastState=STATE_NULL_FOUND;
      signalRunComplete();
      continue;
    }
    if (taskInfo.shouldDelayForLocality(LlapTaskSchedulerServiceForTestControlled.this.clock.getTime())) {
      LOG.info("Triggered getTask but the first element is not ready to execute");
      lastState=STATE_TIMEOUT_NOT_EXPIRED;
      signalRunComplete();
      continue;
    }
 else {
      delayedTaskQueue.poll();
      lastState=STATE_RETURNED_TASK;
      return taskInfo;
    }
  }
}
