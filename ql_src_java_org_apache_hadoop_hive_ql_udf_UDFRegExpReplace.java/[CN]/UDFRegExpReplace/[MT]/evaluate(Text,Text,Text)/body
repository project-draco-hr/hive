{
  if (s == null || regex == null || replacement == null) {
    return null;
  }
  if (!regex.equals(lastRegex) || p == null) {
    lastRegex.set(regex);
    p=Pattern.compile(regex.toString());
  }
  Matcher m=p.matcher(s.toString());
  if (!replacement.equals(lastReplacement)) {
    lastReplacement.set(replacement);
    replacementString=replacement.toString();
  }
  StringBuffer sb=new StringBuffer();
  while (m.find()) {
    m.appendReplacement(sb,replacementString);
  }
  m.appendTail(sb);
  result.set(sb.toString());
  return result;
}
