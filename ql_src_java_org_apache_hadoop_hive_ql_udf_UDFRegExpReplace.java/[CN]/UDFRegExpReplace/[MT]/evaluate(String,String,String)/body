{
  if (s == null || regex == null || replacement == null) {
    return null;
  }
  if (!regex.equals(lastRegex)) {
    lastRegex=regex;
    p=Pattern.compile(regex);
  }
  Matcher m=p.matcher(s);
  StringBuffer sb=new StringBuffer();
  while (m.find()) {
    m.appendReplacement(sb,replacement);
  }
  m.appendTail(sb);
  return sb.toString();
}
