{
  HiveServerHandler.LOG.info("Running the query: " + cmd);
  SessionState session=SessionState.get();
  String cmd_trimmed=cmd.trim();
  String[] tokens=cmd_trimmed.split("\\s");
  String cmd_1=cmd_trimmed.substring(tokens[0].length()).trim();
  int ret=0;
  String errorMessage="";
  String SQLState=null;
  try {
    if (driver != null) {
      driver.close();
      driver=null;
    }
    CommandProcessor proc=CommandProcessorFactory.get(tokens[0]);
    if (proc != null) {
      if (proc instanceof Driver) {
        isHiveQuery=true;
        driver=(Driver)proc;
        driver.setTryCount(Integer.MAX_VALUE);
        response=driver.run(cmd);
      }
 else {
        isHiveQuery=false;
        driver=null;
        setupSessionIO(session);
        response=proc.run(cmd_1);
      }
      ret=response.getResponseCode();
      SQLState=response.getSQLState();
      errorMessage=response.getErrorMessage();
    }
  }
 catch (  Exception e) {
    HiveServerException ex=new HiveServerException();
    ex.setMessage("Error running query: " + e.toString());
    ex.setErrorCode(ret == 0 ? -10000 : ret);
    throw ex;
  }
  if (ret != 0) {
    throw new HiveServerException("Query returned non-zero code: " + ret + ", cause: "+ errorMessage,ret,SQLState);
  }
}
