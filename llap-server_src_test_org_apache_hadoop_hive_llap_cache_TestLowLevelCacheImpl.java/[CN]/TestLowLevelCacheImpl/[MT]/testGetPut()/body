{
  Configuration conf=createConf();
  LowLevelCacheImpl cache=new LowLevelCacheImpl(conf,new DummyCachePolicy(10),new DummyAllocator(),-1);
  String fn1="file1".intern(), fn2="file2".intern();
  LlapMemoryBuffer[] fakes=new LlapMemoryBuffer[]{fb(),fb(),fb(),fb(),fb(),fb()};
  verifyRefcount(fakes,1,1,1,1,1,1);
  assertNull(cache.putFileData(fn1,drs(1,2),fbs(fakes,0,1)));
  assertNull(cache.putFileData(fn2,drs(1,2),fbs(fakes,2,3)));
  verifyCacheGet(cache,fn1,1,3,fakes[0],fakes[1]);
  verifyCacheGet(cache,fn2,1,3,fakes[2],fakes[3]);
  verifyCacheGet(cache,fn1,2,4,fakes[1],dr(3,4));
  verifyRefcount(fakes,2,3,2,2,1,1);
  LlapMemoryBuffer[] bufsDiff=fbs(fakes,4,5);
  long[] mask=cache.putFileData(fn1,drs(3,1),bufsDiff);
  assertEquals(1,mask.length);
  assertEquals(2,mask[0]);
  assertSame(fakes[0],bufsDiff[1]);
  verifyRefcount(fakes,3,3,2,2,1,0);
  verifyCacheGet(cache,fn1,1,4,fakes[0],fakes[1],fakes[4]);
  verifyRefcount(fakes,4,4,2,2,2,0);
}
