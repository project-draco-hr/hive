{
  int tag=GenericData.get().resolveUnion(recordSchema,datum);
  Schema schema=recordSchema.getTypes().get(tag);
  if (schema.getType().equals(Schema.Type.NULL)) {
    return null;
  }
  Schema currentFileSchema=null;
  if (fileSchema != null) {
    if (fileSchema.getType() == Type.UNION) {
      try {
        tag=GenericData.get().resolveUnion(fileSchema,datum);
        currentFileSchema=fileSchema.getTypes().get(tag);
      }
 catch (      UnresolvedUnionException e) {
        if (LOG.isDebugEnabled()) {
          String datumClazz=null;
          if (datum != null) {
            datumClazz=datum.getClass().getName();
          }
          String msg="File schema union could not resolve union. fileSchema = " + fileSchema + ", recordSchema = "+ recordSchema+ ", datum class = "+ datumClazz+ ": "+ e;
          LOG.debug(msg,e);
        }
        currentFileSchema=schema;
      }
    }
 else {
      currentFileSchema=fileSchema;
    }
  }
  return worker(datum,currentFileSchema,schema,SchemaToTypeInfo.generateTypeInfo(schema,null));
}
