{
  boolean doTrace=LOG.isDebugEnabled();
  boolean doUseDirectSql=(maxParts < 0) && HiveConf.getBoolVar(getConf(),ConfVars.METASTORE_TRY_DIRECT_SQL);
  dbName=dbName.toLowerCase();
  tblName=tblName.toLowerCase();
  List<Partition> results=null;
  FilterParser parser=null;
  if (filter != null && filter.length() != 0) {
    LOG.debug("Filter specified is " + filter);
    parser=getFilterParser(filter);
  }
  boolean success=false;
  try {
    long start=doTrace ? System.nanoTime() : 0;
    openTransaction();
    MTable mtable=ensureGetMTable(dbName,tblName);
    if (doUseDirectSql) {
      try {
        Table table=convertToTable(mtable);
        results=directSql.getPartitionsViaSqlFilter(table,dbName,tblName,parser);
      }
 catch (      Exception ex) {
        LOG.error("Direct SQL failed, falling back to ORM",ex);
        doUseDirectSql=false;
        rollbackTransaction();
        start=doTrace ? System.nanoTime() : 0;
        openTransaction();
        mtable=ensureGetMTable(dbName,tblName);
      }
    }
    if (!doUseDirectSql) {
      results=convertToParts(listMPartitionsByFilterNoTxn(mtable,dbName,tblName,parser,maxParts));
    }
    success=commitTransaction();
    LOG.info(results.size() + " partitions retrieved using " + (doUseDirectSql ? "SQL" : "ORM")+ (doTrace ? (" in " + ((System.nanoTime() - start) / 1000000.0) + "ms") : ""));
    return results;
  }
  finally {
    if (!success) {
      rollbackTransaction();
    }
  }
}
