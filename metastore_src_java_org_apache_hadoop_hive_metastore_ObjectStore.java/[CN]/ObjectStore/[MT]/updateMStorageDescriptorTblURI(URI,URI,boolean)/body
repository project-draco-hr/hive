{
  boolean committed=false;
  Map<String,String> updateLocations=new HashMap<String,String>();
  List<String> badRecords=new ArrayList<String>();
  UpdateMStorageDescriptorTblURIRetVal retVal=null;
  try {
    openTransaction();
    Query query=pm.newQuery(MStorageDescriptor.class);
    List<MStorageDescriptor> mSDSs=(List<MStorageDescriptor>)query.execute();
    pm.retrieveAll(mSDSs);
    for (    MStorageDescriptor mSDS : mSDSs) {
      URI locationURI=null;
      String location=mSDS.getLocation();
      try {
        locationURI=new URI(location);
      }
 catch (      URISyntaxException e) {
        badRecords.add(location);
      }
      if (locationURI == null) {
        badRecords.add(location);
      }
 else {
        if (shouldUpdateURI(locationURI,oldLoc)) {
          String tblLoc=mSDS.getLocation().replaceAll(oldLoc.toString(),newLoc.toString());
          updateLocations.put(locationURI.toString(),tblLoc);
          if (!isDryRun) {
            mSDS.setLocation(tblLoc);
          }
        }
      }
    }
    committed=commitTransaction();
    if (committed) {
      retVal=new UpdateMStorageDescriptorTblURIRetVal(badRecords,updateLocations);
    }
    return retVal;
  }
  finally {
    if (!committed) {
      rollbackTransaction();
    }
  }
}
