{
  boolean doTrace=LOG.isDebugEnabled();
  List<Partition> results=null;
  boolean doUseDirectSql=HiveConf.getBoolVar(getConf(),ConfVars.METASTORE_TRY_DIRECT_SQL);
  boolean success=false;
  try {
    long start=doTrace ? System.nanoTime() : 0;
    openTransaction();
    if (doUseDirectSql) {
      try {
        results=directSql.getPartitionsViaSqlFilter(dbName,tblName,partNames);
      }
 catch (      Exception ex) {
        LOG.error("Direct SQL failed, falling back to ORM",ex);
        doUseDirectSql=false;
        rollbackTransaction();
        start=doTrace ? System.nanoTime() : 0;
        openTransaction();
      }
    }
    if (!doUseDirectSql) {
      results=getPartitionsViaOrm(dbName,tblName,partNames);
    }
    success=commitTransaction();
    if (doTrace) {
      LOG.debug(results.size() + " partition retrieved using " + (doUseDirectSql ? "SQL" : "ORM")+ " in "+ ((System.nanoTime() - start) / 1000000.0)+ "ms");
    }
    return results;
  }
  finally {
    if (!success) {
      rollbackTransaction();
    }
  }
}
