{
  boolean commited=false;
  PrincipalPrivilegeSet ret=new PrincipalPrivilegeSet();
  tableName=HiveStringUtils.normalizeIdentifier(tableName);
  dbName=HiveStringUtils.normalizeIdentifier(dbName);
  try {
    openTransaction();
    if (userName != null) {
      Map<String,List<PrivilegeGrantInfo>> partUserPriv=new HashMap<String,List<PrivilegeGrantInfo>>();
      partUserPriv.put(userName,getPartitionPrivilege(dbName,tableName,partition,userName,PrincipalType.USER));
      ret.setUserPrivileges(partUserPriv);
    }
    if (groupNames != null && groupNames.size() > 0) {
      Map<String,List<PrivilegeGrantInfo>> partGroupPriv=new HashMap<String,List<PrivilegeGrantInfo>>();
      for (      String groupName : groupNames) {
        partGroupPriv.put(groupName,getPartitionPrivilege(dbName,tableName,partition,groupName,PrincipalType.GROUP));
      }
      ret.setGroupPrivileges(partGroupPriv);
    }
    Set<String> roleNames=listAllRolesInHierarchy(userName,groupNames);
    if (roleNames != null && roleNames.size() > 0) {
      Map<String,List<PrivilegeGrantInfo>> partRolePriv=new HashMap<String,List<PrivilegeGrantInfo>>();
      for (      String roleName : roleNames) {
        partRolePriv.put(roleName,getPartitionPrivilege(dbName,tableName,partition,roleName,PrincipalType.ROLE));
      }
      ret.setRolePrivileges(partRolePriv);
    }
    commited=commitTransaction();
  }
  finally {
    if (!commited) {
      rollbackTransaction();
    }
  }
  return ret;
}
