{
  ByteArrayOutputStream bytes=new ByteArrayOutputStream();
  Output kryoOut=new Output(bytes);
  kryos.get().writeClassAndObject(kryoOut,msg);
  kryoOut.flush();
  byte[] msgData=bytes.toByteArray();
  checkSize(msgData.length);
  buf.ensureWritable(msgData.length + 4);
  buf.writeInt(msgData.length);
  buf.writeBytes(msgData);
  LOG.debug("Encoded message of type {} ({} bytes)",msg.getClass().getName(),msgData.length);
}
