{
  if (encryptionHandler != null) {
    byte[] encrypted;
    int len=data.limit() - data.position();
    int offset;
    if (data.hasArray()) {
      encrypted=data.array();
      offset=data.position() + data.arrayOffset();
      data.position(data.limit());
    }
 else {
      encrypted=new byte[len];
      offset=0;
      data.get(encrypted);
    }
    return ByteBuffer.wrap(encryptionHandler.unwrap(encrypted,offset,len));
  }
 else {
    return data;
  }
}
