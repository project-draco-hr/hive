{
  if (closed) {
    throw new IOException("Already closed: " + id);
  }
  try {
    flush();
  }
 catch (  IOException err) {
    LOG.error("Error flushing stream before close",err);
  }
  closed=true;
  waitForWritesToFinish(0);
  try {
    chc.close().addListener(closeListener);
  }
  finally {
    buf.release();
    buf=null;
    chc=null;
    closed=true;
  }
}
