{
  if (closed) {
    throw new IOException("Already closed: " + id);
  }
  try {
    flush();
  }
 catch (  IOException err) {
    LOG.error("Error flushing stream before close",err);
  }
  try {
    chc.close().addListener(listener).sync();
  }
 catch (  InterruptedException err) {
    throw new IOException(err);
  }
 finally {
    buf.release();
    buf=null;
    chc=null;
    closed=true;
  }
}
