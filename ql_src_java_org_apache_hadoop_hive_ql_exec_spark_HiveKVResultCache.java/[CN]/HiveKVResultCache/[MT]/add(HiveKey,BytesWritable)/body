{
  if (writeCursor >= IN_MEMORY_NUM_ROWS) {
    if (!readBufferUsed) {
      switchBufferAndResetCursor();
    }
 else {
      try {
        if (output == null) {
          setupOutput();
        }
        for (int i=0; i < IN_MEMORY_NUM_ROWS; i++) {
          ObjectPair<HiveKey,BytesWritable> pair=writeBuffer[i];
          writeHiveKey(output,pair.getFirst());
          writeValue(output,pair.getSecond());
          pair.setFirst(null);
          pair.setSecond(null);
        }
        writeCursor=0;
      }
 catch (      Exception e) {
        clear();
        throw new RuntimeException("Failed to spill rows to disk",e);
      }
    }
  }
  ObjectPair<HiveKey,BytesWritable> pair=writeBuffer[writeCursor++];
  pair.setFirst(key);
  pair.setSecond(value);
}
