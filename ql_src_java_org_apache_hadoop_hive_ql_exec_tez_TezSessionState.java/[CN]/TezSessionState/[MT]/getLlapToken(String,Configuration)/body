{
  SessionState session=SessionState.get();
  boolean isInHs2=session != null && session.isHiveServerQuery();
  Token<LlapTokenIdentifier> token=null;
  if (isInHs2) {
    String clusterName=LlapUtil.generateClusterName(conf);
    final String clusterId=DaemonId.createClusterString(user,clusterName);
    try {
      token=localClientCache.get(clusterId,new Callable<LlapTokenLocalClient>(){
        @Override public LlapTokenLocalClient call() throws Exception {
          return new LlapTokenLocalClient(conf,clusterId);
        }
      }
).createToken(null,null,false);
    }
 catch (    ExecutionException e) {
      throw new IOException(e);
    }
  }
 else {
    token=new LlapTokenClient(conf).getDelegationToken(null);
  }
  if (LOG.isInfoEnabled()) {
    LOG.info("Obtained a LLAP token: " + token);
  }
  return token;
}
