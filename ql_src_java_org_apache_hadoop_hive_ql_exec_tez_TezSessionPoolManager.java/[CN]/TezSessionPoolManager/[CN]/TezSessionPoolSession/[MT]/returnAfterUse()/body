{
  int finalState=shouldExpire() ? STATE_EXPIRED : STATE_NONE;
  if (!sessionState.compareAndSet(STATE_IN_USE,finalState)) {
    throw new AssertionError("Unexpected state change; currently " + sessionState.get());
  }
  if (finalState == STATE_NONE)   return true;
  closeAndRestartExpiredSession(true);
  return false;
}
