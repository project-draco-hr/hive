{
  try {
    TableScanOperator tsOp=(TableScanOperator)stack.get(0);
    if (tsOp.getNumParent() > 0) {
      return null;
    }
    SelectOperator pselOp=(SelectOperator)stack.get(1);
    for (    ExprNodeDesc desc : pselOp.getConf().getColList()) {
      if (!((desc instanceof ExprNodeColumnDesc) || (desc instanceof ExprNodeConstantDesc))) {
        return null;
      }
    }
    Map<String,ExprNodeDesc> exprMap=pselOp.getColumnExprMap();
    GroupByOperator pgbyOp=(GroupByOperator)stack.get(2);
    if (pgbyOp.getConf().getOutputColumnNames().size() != pgbyOp.getConf().getAggregators().size()) {
      return null;
    }
    ReduceSinkOperator rsOp=(ReduceSinkOperator)stack.get(3);
    if (rsOp.getConf().getDistinctColumnIndices().size() > 0) {
      return null;
    }
    GroupByOperator cgbyOp=(GroupByOperator)stack.get(4);
    if (cgbyOp.getConf().getOutputColumnNames().size() != cgbyOp.getConf().getAggregators().size()) {
      return null;
    }
    Operator<?> last=(Operator<?>)stack.get(5);
    if (last instanceof SelectOperator) {
      SelectOperator cselOp=(SelectOperator)last;
      if (!cselOp.isIdentitySelect()) {
        return null;
      }
      last=(Operator<?>)stack.get(6);
    }
    FileSinkOperator fsOp=(FileSinkOperator)last;
    if (fsOp.getNumChild() > 0) {
      return null;
    }
    Table tbl=tsOp.getConf().getTableMetadata();
    List<Object> oneRow=new ArrayList<Object>();
    Hive hive=Hive.get(pctx.getConf());
    for (    AggregationDesc aggr : pgbyOp.getConf().getAggregators()) {
      if (aggr.getDistinct()) {
        return null;
      }
      GenericUDAFResolver udaf=FunctionRegistry.getGenericUDAFResolver(aggr.getGenericUDAFName());
      if (udaf instanceof GenericUDAFSum) {
        ExprNodeDesc desc=aggr.getParameters().get(0);
        PrimitiveCategory category=GenericUDAFSum.getReturnType(desc.getTypeInfo());
        if (category == null) {
          return null;
        }
        String constant;
        if (desc instanceof ExprNodeConstantDesc) {
          constant=((ExprNodeConstantDesc)desc).getValue().toString();
        }
 else         if (desc instanceof ExprNodeColumnDesc && exprMap.get(((ExprNodeColumnDesc)desc).getColumn()) instanceof ExprNodeConstantDesc) {
          constant=((ExprNodeConstantDesc)exprMap.get(((ExprNodeColumnDesc)desc).getColumn())).getValue().toString();
        }
 else {
          return null;
        }
        Long rowCnt=getRowCnt(pctx,tsOp,tbl);
        if (rowCnt == null) {
          return null;
        }
switch (category) {
case LONG:
          oneRow.add(Long.valueOf(constant) * rowCnt);
        break;
case DOUBLE:
      oneRow.add(Double.valueOf(constant) * rowCnt);
    break;
case DECIMAL:
  oneRow.add(HiveDecimal.create(constant).multiply(HiveDecimal.create(rowCnt)));
break;
default :
throw new IllegalStateException("never");
}
}
 else if (udaf instanceof GenericUDAFCount) {
Long rowCnt=0L;
if (aggr.getParameters().isEmpty() || aggr.getParameters().get(0) instanceof ExprNodeConstantDesc || ((aggr.getParameters().get(0) instanceof ExprNodeColumnDesc) && exprMap.get(((ExprNodeColumnDesc)aggr.getParameters().get(0)).getColumn()) instanceof ExprNodeConstantDesc)) {
rowCnt=getRowCnt(pctx,tsOp,tbl);
if (rowCnt == null) {
return null;
}
}
 else {
ExprNodeColumnDesc desc=(ExprNodeColumnDesc)exprMap.get(((ExprNodeColumnDesc)aggr.getParameters().get(0)).getColumn());
String colName=desc.getColumn();
StatType type=getType(desc.getTypeString());
if (!tbl.isPartitioned()) {
if (!StatsSetupConst.areStatsUptoDate(tbl.getParameters())) {
Log.debug("Stats for table : " + tbl.getTableName() + " are not upto date.");
return null;
}
rowCnt=Long.parseLong(tbl.getProperty(StatsSetupConst.ROW_COUNT));
if (rowCnt < 1) {
Log.debug("Table doesn't have upto date stats " + tbl.getTableName());
return null;
}
List<ColumnStatisticsObj> stats=hive.getMSC().getTableColumnStatistics(tbl.getDbName(),tbl.getTableName(),Lists.newArrayList(colName));
if (stats.isEmpty()) {
Log.debug("No stats for " + tbl.getTableName() + " column "+ colName);
return null;
}
Long nullCnt=getNullcountFor(type,stats.get(0).getStatsData());
if (null == nullCnt) {
Log.debug("Unsupported type: " + desc.getTypeString() + " encountered in "+ "metadata optimizer for column : "+ colName);
return null;
}
 else {
rowCnt-=nullCnt;
}
}
 else {
Set<Partition> parts=pctx.getPrunedPartitions(tsOp.getConf().getAlias(),tsOp).getPartitions();
for (Partition part : parts) {
if (!StatsSetupConst.areStatsUptoDate(part.getParameters())) {
  Log.debug("Stats for part : " + part.getSpec() + " are not upto date.");
  return null;
}
Long partRowCnt=Long.parseLong(part.getParameters().get(StatsSetupConst.ROW_COUNT));
if (partRowCnt < 1) {
  Log.debug("Partition doesn't have upto date stats " + part.getSpec());
  return null;
}
rowCnt+=partRowCnt;
}
Collection<List<ColumnStatisticsObj>> result=verifyAndGetPartStats(hive,tbl,colName,parts);
if (result == null) {
return null;
}
for (List<ColumnStatisticsObj> statObj : result) {
ColumnStatisticsData statData=validateSingleColStat(statObj);
if (statData == null) return null;
Long nullCnt=getNullcountFor(type,statData);
if (nullCnt == null) {
  Log.debug("Unsupported type: " + desc.getTypeString() + " encountered in "+ "metadata optimizer for column : "+ colName);
  return null;
}
 else {
  rowCnt-=nullCnt;
}
}
}
}
oneRow.add(rowCnt);
}
 else if (udaf instanceof GenericUDAFMax) {
ExprNodeColumnDesc colDesc=(ExprNodeColumnDesc)exprMap.get(((ExprNodeColumnDesc)aggr.getParameters().get(0)).getColumn());
String colName=colDesc.getColumn();
StatType type=getType(colDesc.getTypeString());
if (!tbl.isPartitioned()) {
if (!StatsSetupConst.areStatsUptoDate(tbl.getParameters())) {
Log.debug("Stats for table : " + tbl.getTableName() + " are not upto date.");
return null;
}
List<ColumnStatisticsObj> stats=hive.getMSC().getTableColumnStatistics(tbl.getDbName(),tbl.getTableName(),Lists.newArrayList(colName));
if (stats.isEmpty()) {
Log.debug("No stats for " + tbl.getTableName() + " column "+ colName);
return null;
}
ColumnStatisticsData statData=stats.get(0).getStatsData();
String name=colDesc.getTypeString().toUpperCase();
switch (type) {
case Integeral:
{
LongSubType subType=LongSubType.valueOf(name);
LongColumnStatsData lstats=statData.getLongStats();
if (lstats.isSetHighValue()) {
  oneRow.add(subType.cast(lstats.getHighValue()));
}
 else {
  oneRow.add(null);
}
break;
}
case Double:
{
DoubleSubType subType=DoubleSubType.valueOf(name);
DoubleColumnStatsData dstats=statData.getDoubleStats();
if (dstats.isSetHighValue()) {
oneRow.add(subType.cast(dstats.getHighValue()));
}
 else {
oneRow.add(null);
}
break;
}
default :
Log.debug("Unsupported type: " + colDesc.getTypeString() + " encountered in "+ "metadata optimizer for column : "+ colName);
return null;
}
}
 else {
Set<Partition> parts=pctx.getPrunedPartitions(tsOp.getConf().getAlias(),tsOp).getPartitions();
String name=colDesc.getTypeString().toUpperCase();
switch (type) {
case Integeral:
{
LongSubType subType=LongSubType.valueOf(name);
Long maxVal=null;
Collection<List<ColumnStatisticsObj>> result=verifyAndGetPartStats(hive,tbl,colName,parts);
if (result == null) {
return null;
}
for (List<ColumnStatisticsObj> statObj : result) {
ColumnStatisticsData statData=validateSingleColStat(statObj);
if (statData == null) return null;
LongColumnStatsData lstats=statData.getLongStats();
if (!lstats.isSetHighValue()) {
continue;
}
long curVal=lstats.getHighValue();
maxVal=maxVal == null ? curVal : Math.max(maxVal,curVal);
}
if (maxVal != null) {
oneRow.add(subType.cast(maxVal));
}
 else {
oneRow.add(maxVal);
}
break;
}
case Double:
{
DoubleSubType subType=DoubleSubType.valueOf(name);
Double maxVal=null;
Collection<List<ColumnStatisticsObj>> result=verifyAndGetPartStats(hive,tbl,colName,parts);
if (result == null) {
return null;
}
for (List<ColumnStatisticsObj> statObj : result) {
ColumnStatisticsData statData=validateSingleColStat(statObj);
if (statData == null) return null;
DoubleColumnStatsData dstats=statData.getDoubleStats();
if (!dstats.isSetHighValue()) {
continue;
}
double curVal=statData.getDoubleStats().getHighValue();
maxVal=maxVal == null ? curVal : Math.max(maxVal,curVal);
}
if (maxVal != null) {
oneRow.add(subType.cast(maxVal));
}
 else {
oneRow.add(null);
}
break;
}
default :
Log.debug("Unsupported type: " + colDesc.getTypeString() + " encountered in "+ "metadata optimizer for column : "+ colName);
return null;
}
}
}
 else if (udaf instanceof GenericUDAFMin) {
ExprNodeColumnDesc colDesc=(ExprNodeColumnDesc)exprMap.get(((ExprNodeColumnDesc)aggr.getParameters().get(0)).getColumn());
String colName=colDesc.getColumn();
StatType type=getType(colDesc.getTypeString());
if (!tbl.isPartitioned()) {
if (!StatsSetupConst.areStatsUptoDate(tbl.getParameters())) {
Log.debug("Stats for table : " + tbl.getTableName() + " are not upto date.");
return null;
}
ColumnStatisticsData statData=hive.getMSC().getTableColumnStatistics(tbl.getDbName(),tbl.getTableName(),Lists.newArrayList(colName)).get(0).getStatsData();
String name=colDesc.getTypeString().toUpperCase();
switch (type) {
case Integeral:
{
LongSubType subType=LongSubType.valueOf(name);
LongColumnStatsData lstats=statData.getLongStats();
if (lstats.isSetLowValue()) {
oneRow.add(subType.cast(lstats.getLowValue()));
}
 else {
oneRow.add(null);
}
break;
}
case Double:
{
DoubleSubType subType=DoubleSubType.valueOf(name);
DoubleColumnStatsData dstats=statData.getDoubleStats();
if (dstats.isSetLowValue()) {
oneRow.add(subType.cast(dstats.getLowValue()));
}
 else {
oneRow.add(null);
}
break;
}
default :
Log.debug("Unsupported type: " + colDesc.getTypeString() + " encountered in "+ "metadata optimizer for column : "+ colName);
return null;
}
}
 else {
Set<Partition> parts=pctx.getPrunedPartitions(tsOp.getConf().getAlias(),tsOp).getPartitions();
String name=colDesc.getTypeString().toUpperCase();
switch (type) {
case Integeral:
{
LongSubType subType=LongSubType.valueOf(name);
Long minVal=null;
Collection<List<ColumnStatisticsObj>> result=verifyAndGetPartStats(hive,tbl,colName,parts);
if (result == null) {
return null;
}
for (List<ColumnStatisticsObj> statObj : result) {
ColumnStatisticsData statData=validateSingleColStat(statObj);
if (statData == null) return null;
LongColumnStatsData lstats=statData.getLongStats();
if (!lstats.isSetLowValue()) {
continue;
}
long curVal=lstats.getLowValue();
minVal=minVal == null ? curVal : Math.min(minVal,curVal);
}
if (minVal != null) {
oneRow.add(subType.cast(minVal));
}
 else {
oneRow.add(minVal);
}
break;
}
case Double:
{
DoubleSubType subType=DoubleSubType.valueOf(name);
Double minVal=null;
Collection<List<ColumnStatisticsObj>> result=verifyAndGetPartStats(hive,tbl,colName,parts);
if (result == null) {
return null;
}
for (List<ColumnStatisticsObj> statObj : result) {
ColumnStatisticsData statData=validateSingleColStat(statObj);
if (statData == null) return null;
DoubleColumnStatsData dstats=statData.getDoubleStats();
if (!dstats.isSetLowValue()) {
continue;
}
double curVal=statData.getDoubleStats().getLowValue();
minVal=minVal == null ? curVal : Math.min(minVal,curVal);
}
if (minVal != null) {
oneRow.add(subType.cast(minVal));
}
 else {
oneRow.add(minVal);
}
break;
}
default :
Log.debug("Unsupported type: " + colDesc.getTypeString() + " encountered in "+ "metadata optimizer for column : "+ colName);
return null;
}
}
}
 else {
Log.debug("Unsupported aggregation for metadata optimizer: " + aggr.getGenericUDAFName());
return null;
}
}
List<List<Object>> allRows=new ArrayList<List<Object>>();
allRows.add(oneRow);
List<String> colNames=new ArrayList<String>();
List<ObjectInspector> ois=new ArrayList<ObjectInspector>();
for (ColumnInfo colInfo : cgbyOp.getSchema().getSignature()) {
colNames.add(colInfo.getInternalName());
ois.add(TypeInfoUtils.getStandardJavaObjectInspectorFromTypeInfo(colInfo.getType()));
}
StandardStructObjectInspector sOI=ObjectInspectorFactory.getStandardStructObjectInspector(colNames,ois);
FetchWork fWork=new FetchWork(allRows,sOI);
FetchTask fTask=(FetchTask)TaskFactory.get(fWork,pctx.getConf());
fWork.setLimit(allRows.size());
pctx.setFetchTask(fTask);
return null;
}
 catch (Exception e) {
Log.debug("Failed to optimize using metadata optimizer",e);
return null;
}
}
