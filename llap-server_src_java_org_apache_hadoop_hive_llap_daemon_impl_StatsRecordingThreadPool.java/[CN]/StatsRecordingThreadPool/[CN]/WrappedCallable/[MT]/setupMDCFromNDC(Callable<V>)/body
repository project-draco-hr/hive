{
  if (actualCallable instanceof CallableWithNdc) {
    CallableWithNdc callableWithNdc=(CallableWithNdc)actualCallable;
    try {
      Field field=callableWithNdc.getClass().getSuperclass().getDeclaredField("ndcStack");
      field.setAccessible(true);
      Stack ndcStack=(Stack)field.get(callableWithNdc);
      final Stack clonedStack=(Stack)ndcStack.clone();
      final String fragmentId=(String)clonedStack.pop();
      final String queryId=(String)clonedStack.pop();
      final String dagId=(String)clonedStack.pop();
      MDC.put("dagId",dagId);
      MDC.put("queryId",queryId);
      MDC.put("fragmentId",fragmentId);
      if (LOG.isDebugEnabled()) {
        LOG.debug("Received dagId: {} queryId: {} instanceType: {}",dagId,queryId,actualCallable.getClass().getSimpleName());
      }
    }
 catch (    Exception e) {
      LOG.warn("Not setting up MDC as NDC stack cannot be accessed reflectively for" + " instance type: {} exception type: {}",actualCallable.getClass().getSimpleName(),e.getClass().getSimpleName());
    }
  }
 else {
    LOG.warn("Not setting up MDC as unknown callable instance type received: {}",actualCallable.getClass().getSimpleName());
  }
}
