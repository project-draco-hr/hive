{
  boolean isExternal=MetaStoreUtils.isExternalTable(tbl);
  hbaseConf=getConf();
  if (tbl.getSd().getLocation() != null) {
    throw new MetaException("LOCATION may not be specified for HBase.");
  }
  try {
    String tableName=getFullyQualifiedHBaseTableName(tbl);
    String hbaseColumnsMapping=tbl.getParameters().get(HBaseSerDe.HBASE_COLUMNS_MAPPING);
    if (hbaseColumnsMapping == null) {
      throw new MetaException("No hbase.columns.mapping defined in table" + " properties.");
    }
    List<String> hbaseColumnFamilies=new ArrayList<String>();
    List<String> hbaseColumnQualifiers=new ArrayList<String>();
    List<byte[]> hbaseColumnFamiliesBytes=new ArrayList<byte[]>();
    int iKey=HBaseUtil.parseColumnMapping(hbaseColumnsMapping,hbaseColumnFamilies,hbaseColumnFamiliesBytes,hbaseColumnQualifiers,null);
    HTableDescriptor tableDesc;
    Set<String> uniqueColumnFamilies=new HashSet<String>();
    if (!getHBaseAdmin().tableExists(tableName)) {
      if (!isExternal) {
        tableDesc=new HTableDescriptor(tableName);
        uniqueColumnFamilies.addAll(hbaseColumnFamilies);
        uniqueColumnFamilies.remove(hbaseColumnFamilies.get(iKey));
        for (        String columnFamily : uniqueColumnFamilies) {
          HColumnDescriptor familyDesc=new HColumnDescriptor(Bytes.toBytes(columnFamily));
          familyDesc.setMaxVersions(Integer.MAX_VALUE);
          tableDesc.addFamily(familyDesc);
        }
        getHBaseAdmin().createTable(tableDesc);
      }
 else {
        throw new MetaException("HBase table " + tableName + " doesn't exist while the table is "+ "declared as an external table.");
      }
    }
 else {
      if (!isExternal) {
        throw new MetaException("Table " + tableName + " already exists within HBase."+ " Use CREATE EXTERNAL TABLE instead to"+ " register it in HCatalog.");
      }
      tableDesc=getHBaseAdmin().getTableDescriptor(Bytes.toBytes(tableName));
      for (int i=0; i < hbaseColumnFamilies.size(); i++) {
        if (i == iKey) {
          continue;
        }
        if (!tableDesc.hasFamily(hbaseColumnFamiliesBytes.get(i))) {
          throw new MetaException("Column Family " + hbaseColumnFamilies.get(i) + " is not defined in hbase table "+ tableName);
        }
      }
    }
    new HTable(hbaseConf,tableDesc.getName());
    RevisionManager rm=HBaseRevisionManagerUtil.getOpenedRevisionManager(hbaseConf);
    rm.createTable(tableName,new ArrayList<String>(uniqueColumnFamilies));
  }
 catch (  MasterNotRunningException mnre) {
    throw new MetaException(StringUtils.stringifyException(mnre));
  }
catch (  IOException ie) {
    throw new MetaException(StringUtils.stringifyException(ie));
  }
catch (  IllegalArgumentException iae) {
    throw new MetaException(StringUtils.stringifyException(iae));
  }
}
