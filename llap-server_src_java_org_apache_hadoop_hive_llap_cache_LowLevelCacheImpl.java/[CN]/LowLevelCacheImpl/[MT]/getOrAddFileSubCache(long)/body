{
  FileCache newSubCache=null;
  while (true) {
    FileCache subCache=cache.get(fileId);
    if (subCache != null) {
      if (subCache.incRef())       return subCache;
      if (newSubCache == null) {
        newSubCache=new FileCache();
        newSubCache.incRef();
      }
      if (cache.replace(fileId,subCache,newSubCache))       return newSubCache;
      continue;
    }
    if (newSubCache == null) {
      newSubCache=new FileCache();
      newSubCache.incRef();
    }
    FileCache oldSubCache=cache.putIfAbsent(fileId,newSubCache);
    if (oldSubCache == null)     return newSubCache;
    if (oldSubCache.incRef())     return oldSubCache;
    if (cache.replace(fileId,oldSubCache,newSubCache))     return newSubCache;
  }
}
