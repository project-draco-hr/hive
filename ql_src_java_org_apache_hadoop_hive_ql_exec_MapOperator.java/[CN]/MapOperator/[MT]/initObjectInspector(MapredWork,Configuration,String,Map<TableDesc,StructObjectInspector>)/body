{
  PartitionDesc pd=conf.getPathToPartitionInfo().get(onefile);
  LinkedHashMap<String,String> partSpec=pd.getPartSpec();
  Properties partProps=(pd.getPartSpec() == null || pd.getPartSpec().isEmpty()) ? pd.getTableDesc().getProperties() : pd.getProperties();
  Class serdeclass=pd.getDeserializerClass();
  if (serdeclass == null) {
    String className=pd.getSerdeClassName();
    if ((className == null) || (className.isEmpty())) {
      throw new HiveException("SerDe class or the SerDe class name is not set for table: " + pd.getProperties().getProperty("name"));
    }
    serdeclass=hconf.getClassByName(className);
  }
  String tableName=String.valueOf(partProps.getProperty("name"));
  String partName=String.valueOf(partSpec);
  Deserializer partDeserializer=(Deserializer)serdeclass.newInstance();
  partDeserializer.initialize(hconf,partProps);
  StructObjectInspector partRawRowObjectInspector=(StructObjectInspector)partDeserializer.getObjectInspector();
  StructObjectInspector tblRawRowObjectInspector=convertedOI.get(pd.getTableDesc());
  partTblObjectInspectorConverter=ObjectInspectorConverters.getConverter(partRawRowObjectInspector,tblRawRowObjectInspector);
  MapOpCtx opCtx=null;
  String pcols=partProps.getProperty(org.apache.hadoop.hive.metastore.api.hive_metastoreConstants.META_TABLE_PARTITION_COLUMNS);
  if (pcols != null && pcols.length() > 0) {
    String[] partKeys=pcols.trim().split("/");
    List<String> partNames=new ArrayList<String>(partKeys.length);
    Object[] partValues=new Object[partKeys.length];
    List<ObjectInspector> partObjectInspectors=new ArrayList<ObjectInspector>(partKeys.length);
    for (int i=0; i < partKeys.length; i++) {
      String key=partKeys[i];
      partNames.add(key);
      if (partSpec == null) {
        partValues[i]=null;
      }
 else {
        partValues[i]=new Text(partSpec.get(key));
      }
      partObjectInspectors.add(PrimitiveObjectInspectorFactory.writableStringObjectInspector);
    }
    StructObjectInspector partObjectInspector=ObjectInspectorFactory.getStandardStructObjectInspector(partNames,partObjectInspectors);
    Object[] rowWithPart=new Object[2];
    rowWithPart[1]=partValues;
    StructObjectInspector rowObjectInspector=ObjectInspectorFactory.getUnionStructObjectInspector(Arrays.asList(new StructObjectInspector[]{tblRawRowObjectInspector,partObjectInspector}));
    opCtx=new MapOpCtx(true,rowObjectInspector,tblRawRowObjectInspector,partObjectInspector,rowWithPart,null,partDeserializer,partTblObjectInspectorConverter);
  }
 else {
    opCtx=new MapOpCtx(false,tblRawRowObjectInspector,tblRawRowObjectInspector,null,null,null,partDeserializer,partTblObjectInspectorConverter);
  }
  opCtx.tableName=tableName;
  opCtx.partName=partName;
  return opCtx;
}
