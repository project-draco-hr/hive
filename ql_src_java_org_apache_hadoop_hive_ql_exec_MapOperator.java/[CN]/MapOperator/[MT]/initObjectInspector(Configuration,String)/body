{
  partitionDesc pd=conf.getPathToPartitionInfo().get(onefile);
  LinkedHashMap<String,String> partSpec=pd.getPartSpec();
  tableDesc td=pd.getTableDesc();
  Properties p=td.getProperties();
  HiveConf.setVar(hconf,HiveConf.ConfVars.HIVETABLENAME,String.valueOf(p.getProperty("name")));
  HiveConf.setVar(hconf,HiveConf.ConfVars.HIVEPARTITIONNAME,String.valueOf(partSpec));
  Class sdclass=td.getDeserializerClass();
  if (sdclass == null) {
    String className=td.getSerdeClassName();
    if ((className == "") || (className == null)) {
      throw new HiveException("SerDe class or the SerDe class name is not set for table: " + td.getProperties().getProperty("name"));
    }
    sdclass=hconf.getClassByName(className);
  }
  deserializer=(Deserializer)sdclass.newInstance();
  deserializer.initialize(hconf,p);
  rowObjectInspector=(StructObjectInspector)deserializer.getObjectInspector();
  String pcols=p.getProperty(org.apache.hadoop.hive.metastore.api.Constants.META_TABLE_PARTITION_COLUMNS);
  if (pcols != null && pcols.length() > 0) {
    String[] partKeys=pcols.trim().split("/");
    List<String> partNames=new ArrayList<String>(partKeys.length);
    Object[] partValues=new Object[partKeys.length];
    List<ObjectInspector> partObjectInspectors=new ArrayList<ObjectInspector>(partKeys.length);
    for (int i=0; i < partKeys.length; i++) {
      String key=partKeys[i];
      partNames.add(key);
      partValues[i]=new Text(partSpec.get(key));
      partObjectInspectors.add(PrimitiveObjectInspectorFactory.writableStringObjectInspector);
    }
    StructObjectInspector partObjectInspector=ObjectInspectorFactory.getStandardStructObjectInspector(partNames,partObjectInspectors);
    rowWithPart=new Object[2];
    rowWithPart[1]=partValues;
    rowObjectInspector=ObjectInspectorFactory.getUnionStructObjectInspector(Arrays.asList(new StructObjectInspector[]{rowObjectInspector,partObjectInspector}));
    return new MapOpCtx(true,rowObjectInspector,rowWithPart,deserializer);
  }
 else {
    return new MapOpCtx(false,rowObjectInspector,null,deserializer);
  }
}
