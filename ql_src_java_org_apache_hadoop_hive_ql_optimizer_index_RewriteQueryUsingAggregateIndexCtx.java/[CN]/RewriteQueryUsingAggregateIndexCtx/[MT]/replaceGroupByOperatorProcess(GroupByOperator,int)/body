{
  RewriteQueryUsingAggregateIndexCtx rewriteQueryCtx=this;
  if (index == 0) {
    String selReplacementCommand="select sum(`" + rewriteQueryCtx.getAggregateFunction() + "`)"+ " from "+ rewriteQueryCtx.getIndexName()+ " group by "+ rewriteQueryCtx.getIndexKey()+ " ";
    ParseContext newDAGContext=RewriteParseContextGenerator.generateOperatorTree(rewriteQueryCtx.getParseContext().getConf(),selReplacementCommand);
    Map<GroupByOperator,Set<String>> newGbyOpMap=newDAGContext.getGroupOpToInputTables();
    GroupByOperator newGbyOperator=newGbyOpMap.keySet().iterator().next();
    GroupByDesc oldConf=operator.getConf();
    ExprNodeColumnDesc aggrExprNode=null;
    GroupByDesc newConf=newGbyOperator.getConf();
    List<AggregationDesc> newAggrList=newConf.getAggregators();
    if (newAggrList != null && newAggrList.size() > 0) {
      for (      AggregationDesc aggregationDesc : newAggrList) {
        rewriteQueryCtx.setEval(aggregationDesc.getGenericUDAFEvaluator());
        aggrExprNode=(ExprNodeColumnDesc)aggregationDesc.getParameters().get(0);
        rewriteQueryCtx.setAggrExprNode(aggrExprNode);
      }
    }
    OpParseContext gbyOPC=rewriteQueryCtx.getOpc().get(operator);
    RowResolver gbyRR=newDAGContext.getOpParseCtx().get(newGbyOperator).getRowResolver();
    gbyOPC.setRowResolver(gbyRR);
    rewriteQueryCtx.getOpc().put(operator,gbyOPC);
    oldConf.setAggregators((ArrayList<AggregationDesc>)newAggrList);
    operator.setConf(oldConf);
  }
 else {
    GroupByDesc childConf=(GroupByDesc)operator.getConf();
    List<AggregationDesc> childAggrList=childConf.getAggregators();
    if (childAggrList != null && childAggrList.size() > 0) {
      for (      AggregationDesc aggregationDesc : childAggrList) {
        List<ExprNodeDesc> paraList=aggregationDesc.getParameters();
        List<ObjectInspector> parametersOIList=new ArrayList<ObjectInspector>();
        for (        ExprNodeDesc expr : paraList) {
          parametersOIList.add(expr.getWritableObjectInspector());
        }
        GenericUDAFEvaluator evaluator=FunctionRegistry.getGenericUDAFEvaluator("sum",parametersOIList,false,false);
        aggregationDesc.setGenericUDAFEvaluator(evaluator);
        aggregationDesc.setGenericUDAFName("sum");
      }
    }
  }
}
