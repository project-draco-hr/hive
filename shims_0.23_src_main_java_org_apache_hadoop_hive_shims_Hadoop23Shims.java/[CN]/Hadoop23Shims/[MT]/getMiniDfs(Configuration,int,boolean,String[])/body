{
  configureImpersonation(conf);
  MiniDFSCluster miniDFSCluster=new MiniDFSCluster(conf,numDataNodes,format,racks);
  KeyProviderCryptoExtension keyProvider=miniDFSCluster.getNameNode().getNamesystem().getProvider();
  if (keyProvider != null) {
    try {
      setKeyProvider(miniDFSCluster.getFileSystem().getClient(),keyProvider);
    }
 catch (    Exception err) {
      throw new IOException(err);
    }
  }
  cluster=new MiniDFSShim(miniDFSCluster);
  return cluster;
}
