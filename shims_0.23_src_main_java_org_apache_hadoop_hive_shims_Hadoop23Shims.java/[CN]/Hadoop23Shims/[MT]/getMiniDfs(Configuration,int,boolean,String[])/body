{
  configureImpersonation(conf);
  MiniDFSCluster miniDFSCluster=new MiniDFSCluster(conf,numDataNodes,format,racks);
  KeyProviderCryptoExtension keyProvider=miniDFSCluster.getNameNode().getNamesystem().getProvider();
  if (keyProvider != null) {
    miniDFSCluster.getFileSystem().getClient().setKeyProvider(keyProvider);
  }
  cluster=new MiniDFSShim(miniDFSCluster);
  return cluster;
}
