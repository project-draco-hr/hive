{
  boolean success=false;
  try {
    conf.set("hbase.master","local");
    tmpdir=System.getProperty("user.dir") + "/../build/ql/tmp";
    conf.set("hbase.rootdir","file://" + tmpdir + "/hbase");
    zooKeeperCluster=new MiniZooKeeperCluster();
    int clientPort=zooKeeperCluster.startup(new File(tmpdir,"zookeeper"));
    conf.set("hbase.zookeeper.property.clientPort",Integer.toString(clientPort));
    HBaseConfiguration hbaseConf=new HBaseConfiguration(conf);
    hbase=new MiniHBaseCluster(hbaseConf,NUM_REGIONSERVERS);
    conf.set("hbase.master",hbase.getHMasterAddress().toString());
    new HTable(new HBaseConfiguration(conf),HConstants.META_TABLE_NAME);
    success=true;
  }
  finally {
    if (!success) {
      if (hbase != null) {
        hbase.shutdown();
      }
      if (zooKeeperCluster != null) {
        zooKeeperCluster.shutdown();
      }
    }
  }
  String auxJars=conf.getAuxJars();
  auxJars=((auxJars == null) ? "" : (auxJars + ",")) + "file://" + new JobConf(conf,HBaseConfiguration.class).getJar();
  auxJars+=",file://" + new JobConf(conf,HBaseSerDe.class).getJar();
  auxJars+=",file://" + new JobConf(conf,Watcher.class).getJar();
  conf.setAuxJars(auxJars);
}
