{
  TaskWrapper taskWrapper=new TaskWrapper(task,this);
  TaskWrapper evictedTask;
synchronized (lock) {
    evictedTask=waitQueue.offer(taskWrapper);
    if (evictedTask != taskWrapper) {
      knownTasks.put(taskWrapper.getRequestId(),taskWrapper);
      taskWrapper.setIsInWaitQueue(true);
      if (isDebugEnabled) {
        LOG.debug("{} added to wait queue. Current wait queue size={}",task.getRequestId(),waitQueue.size());
      }
    }
 else {
      if (isInfoEnabled) {
        LOG.info("wait queue full, size={}. {} not added",waitQueue.size(),task.getRequestId());
      }
      evictedTask.getTaskRunnerCallable().killTask();
      throw new RejectedExecutionException("Wait queue full");
    }
  }
  boolean canFinish=taskWrapper.getTaskRunnerCallable().canFinish();
  taskWrapper.maybeRegisterForFinishedStateNotifications(canFinish);
  if (isDebugEnabled) {
    LOG.debug("Wait Queue: {}",waitQueue);
  }
  if (evictedTask != null) {
    knownTasks.remove(evictedTask.getRequestId());
    evictedTask.maybeUnregisterForFinishedStateNotifications();
    evictedTask.setIsInWaitQueue(false);
    evictedTask.getTaskRunnerCallable().killTask();
    if (isInfoEnabled) {
      LOG.info("{} evicted from wait queue in favor of {} because of lower priority",evictedTask.getRequestId(),task.getRequestId());
    }
  }
synchronized (lock) {
    lock.notify();
  }
}
