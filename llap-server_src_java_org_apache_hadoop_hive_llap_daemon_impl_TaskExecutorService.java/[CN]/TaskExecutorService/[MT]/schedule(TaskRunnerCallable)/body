{
  TaskWrapper taskWrapper=new TaskWrapper(task,this);
  knownTasks.put(taskWrapper.getRequestId(),taskWrapper);
  boolean canFinish=taskWrapper.getTaskRunnerCallable().canFinish();
  taskWrapper.maybeRegisterForFinishedStateNotifications(canFinish);
  TaskWrapper evictedTask;
  try {
synchronized (lock) {
      evictedTask=waitQueue.offer(taskWrapper);
      taskWrapper.setIsInWaitQueue(true);
    }
  }
 catch (  RejectedExecutionException e) {
    knownTasks.remove(taskWrapper.getRequestId());
    taskWrapper.maybeUnregisterForFinishedStateNotifications();
    throw e;
  }
  if (isInfoEnabled) {
    LOG.info("{} added to wait queue. Current wait queue size={}",task.getRequestId(),waitQueue.size());
  }
  if (isDebugEnabled) {
    LOG.debug("Wait Queue: {}",waitQueue);
  }
  if (evictedTask != null) {
    evictedTask.maybeUnregisterForFinishedStateNotifications();
    evictedTask.setIsInWaitQueue(false);
    evictedTask.getTaskRunnerCallable().killTask();
    if (isInfoEnabled) {
      LOG.info("{} evicted from wait queue in favor of {} because of lower priority",evictedTask.getRequestId(),task.getRequestId());
    }
  }
synchronized (lock) {
    lock.notify();
  }
}
