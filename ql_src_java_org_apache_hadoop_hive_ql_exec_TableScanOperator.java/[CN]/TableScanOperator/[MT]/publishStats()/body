{
  boolean isStatsReliable=conf.isStatsReliable();
  StatsPublisher statsPublisher=Utilities.getStatsPublisher(jc);
  if (!statsPublisher.connect(jc)) {
    LOG.info("StatsPublishing error: cannot connect to database.");
    if (isStatsReliable) {
      throw new HiveException(ErrorMsg.STATSPUBLISHER_CONNECTION_ERROR.getErrorCodedMsg());
    }
    return;
  }
  String key;
  String taskID=Utilities.getTaskIdFromFilename(Utilities.getTaskId(hconf));
  Map<String,String> statsToPublish=new HashMap<String,String>();
  for (  String pspecs : stats.keySet()) {
    statsToPublish.clear();
    if (pspecs.isEmpty()) {
      if (statsPublisher instanceof CounterStatsPublisher) {
        key=conf.getStatsAggPrefix();
      }
 else {
        String keyPrefix=Utilities.getHashedStatsPrefix(conf.getStatsAggPrefix(),conf.getMaxStatsKeyPrefixLength());
        key=keyPrefix + taskID;
      }
    }
 else {
      if (statsPublisher instanceof CounterStatsPublisher) {
        key=Utilities.appendPathSeparator(conf.getStatsAggPrefix() + pspecs);
      }
 else {
        String keyPrefix=Utilities.getHashedStatsPrefix(conf.getStatsAggPrefix() + pspecs,conf.getMaxStatsKeyPrefixLength());
        key=keyPrefix + taskID;
      }
    }
    for (    String statType : stats.get(pspecs).getStoredStats()) {
      statsToPublish.put(statType,Long.toString(stats.get(pspecs).getStat(statType)));
    }
    if (!statsPublisher.publishStat(key,statsToPublish)) {
      if (isStatsReliable) {
        throw new HiveException(ErrorMsg.STATSPUBLISHER_PUBLISHING_ERROR.getErrorCodedMsg());
      }
    }
    LOG.info("publishing : " + key + " : "+ statsToPublish.toString());
  }
  if (!statsPublisher.closeConnection()) {
    if (isStatsReliable) {
      throw new HiveException(ErrorMsg.STATSPUBLISHER_CLOSING_ERROR.getErrorCodedMsg());
    }
  }
}
