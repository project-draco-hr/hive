{
  boolean isStatsReliable=conf.isStatsReliable();
  StatsPublisher statsPublisher=Utilities.getStatsPublisher(jc);
  if (statsPublisher == null) {
    LOG.error("StatsPublishing error: StatsPublisher is not initialized.");
    if (isStatsReliable) {
      throw new HiveException(ErrorMsg.STATSPUBLISHER_NOT_OBTAINED.getErrorCodedMsg());
    }
    return;
  }
  StatsCollectionContext sContext=new StatsCollectionContext(hconf);
  sContext.setStatsTmpDir(conf.getStatsTmpDir());
  if (!statsPublisher.connect(sContext)) {
    LOG.error("StatsPublishing error: cannot connect to database");
    if (isStatsReliable) {
      throw new HiveException(ErrorMsg.STATSPUBLISHER_CONNECTION_ERROR.getErrorCodedMsg());
    }
    return;
  }
  String spSpec=conf.getStaticSpec();
  for (  Map.Entry<String,FSPaths> entry : valToPaths.entrySet()) {
    String fspKey=entry.getKey();
    FSPaths fspValue=entry.getValue();
    if (conf.getDpSortState().equals(DPSortState.PARTITION_BUCKET_SORTED)) {
      String taskID=Utilities.getTaskIdFromFilename(fspKey);
      fspKey=fspKey.split(taskID)[0];
    }
    String[] split=splitKey(fspKey);
    String dpSpec=split[0];
    String prefix=conf.getTableInfo().getTableName().toLowerCase();
    prefix=Utilities.join(prefix,spSpec,dpSpec);
    prefix=prefix.endsWith(Path.SEPARATOR) ? prefix : prefix + Path.SEPARATOR;
    Map<String,String> statsToPublish=new HashMap<String,String>();
    for (    String statType : fspValue.stat.getStoredStats()) {
      statsToPublish.put(statType,Long.toString(fspValue.stat.getStat(statType)));
    }
    if (!statsPublisher.publishStat(prefix,statsToPublish)) {
      if (isStatsReliable) {
        throw new HiveException(ErrorMsg.STATSPUBLISHER_PUBLISHING_ERROR.getErrorCodedMsg());
      }
    }
  }
  sContext.setIndexForTezUnion(this.getIndexForTezUnion());
  if (!statsPublisher.closeConnection(sContext)) {
    if (isStatsReliable) {
      throw new HiveException(ErrorMsg.STATSPUBLISHER_CLOSING_ERROR.getErrorCodedMsg());
    }
  }
}
