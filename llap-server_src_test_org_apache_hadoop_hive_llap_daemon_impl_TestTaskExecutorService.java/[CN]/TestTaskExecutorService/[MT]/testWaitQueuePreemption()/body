{
  MockRequest r1=createMockRequest(1,1,100,true,20000l);
  MockRequest r2=createMockRequest(2,1,200,false,20000l);
  MockRequest r3=createMockRequest(3,1,300,false,20000l);
  MockRequest r4=createMockRequest(4,1,400,false,20000l);
  MockRequest r5=createMockRequest(5,1,500,true,20000l);
  TaskExecutorServiceForTest taskExecutorService=new TaskExecutorServiceForTest(1,2,ShortestJobFirstComparator.class.getName(),true);
  taskExecutorService.init(new Configuration());
  taskExecutorService.start();
  try {
    taskExecutorService.schedule(r1);
    awaitStartAndSchedulerRun(r1,taskExecutorService);
    Scheduler.SubmissionState submissionState=taskExecutorService.schedule(r2);
    assertEquals(Scheduler.SubmissionState.ACCEPTED,submissionState);
    submissionState=taskExecutorService.schedule(r3);
    assertEquals(Scheduler.SubmissionState.ACCEPTED,submissionState);
    submissionState=taskExecutorService.schedule(r4);
    assertEquals(Scheduler.SubmissionState.REJECTED,submissionState);
    submissionState=taskExecutorService.schedule(r5);
    assertEquals(Scheduler.SubmissionState.EVICTED_OTHER,submissionState);
    assertEquals(true,r3.wasPreempted());
    TaskExecutorServiceForTest.InternalCompletionListenerForTest icl1=taskExecutorService.getInternalCompletionListenerForTest(r1.getRequestId());
    assertEquals(3,taskExecutorService.knownTasks.size());
    assertTrue(taskExecutorService.knownTasks.containsKey(r1.getRequestId()));
    assertTrue(taskExecutorService.knownTasks.containsKey(r2.getRequestId()));
    assertTrue(taskExecutorService.knownTasks.containsKey(r5.getRequestId()));
    r1.complete();
    r1.awaitEnd();
    icl1.awaitCompletion();
    assertEquals(2,taskExecutorService.knownTasks.size());
    assertTrue(taskExecutorService.knownTasks.containsKey(r2.getRequestId()));
    assertTrue(taskExecutorService.knownTasks.containsKey(r5.getRequestId()));
    awaitStartAndSchedulerRun(r5,taskExecutorService);
    TaskExecutorServiceForTest.InternalCompletionListenerForTest icl5=taskExecutorService.getInternalCompletionListenerForTest(r5.getRequestId());
    r5.complete();
    r5.awaitEnd();
    icl5.awaitCompletion();
    assertEquals(1,taskExecutorService.knownTasks.size());
    assertTrue(taskExecutorService.knownTasks.containsKey(r2.getRequestId()));
    awaitStartAndSchedulerRun(r2,taskExecutorService);
    TaskExecutorServiceForTest.InternalCompletionListenerForTest icl2=taskExecutorService.getInternalCompletionListenerForTest(r2.getRequestId());
    r2.complete();
    r2.awaitEnd();
    icl2.awaitCompletion();
    assertEquals(0,taskExecutorService.knownTasks.size());
  }
  finally {
    taskExecutorService.shutDown(false);
  }
}
