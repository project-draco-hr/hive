{
  int ix=buffer.indexInHeap;
  double priority=buffer.isLockedInHeap ? Double.MAX_VALUE : buffer.priority;
  while (true) {
    int leftIx=(ix << 1) + 1, rightIx=leftIx + 1;
    if (leftIx >= heapSize)     break;
    WeakBuffer left=heap[leftIx], right=null;
    if (rightIx < heapSize) {
      right=heap[rightIx];
    }
    double leftPri=getHeapifyPriority(left,time), rightPri=getHeapifyPriority(right,time);
    if (priority <= leftPri && priority <= rightPri)     break;
    if (leftPri <= rightPri) {
      heap[ix]=left;
      left.indexInHeap=ix;
      ix=leftIx;
    }
 else {
      heap[ix]=right;
      right.indexInHeap=ix;
      ix=rightIx;
    }
  }
  buffer.indexInHeap=ix;
  heap[ix]=buffer;
}
