{
  int port=MetaStoreUtils.findFreePort();
  hiveConf=new HiveConf(TestMetaStoreMetrics.class);
  hiveConf.setVar(HiveConf.ConfVars.METASTOREURIS,"thrift://localhost:" + port);
  hiveConf.setIntVar(HiveConf.ConfVars.METASTORETHRIFTCONNECTIONRETRIES,3);
  hiveConf.setBoolVar(HiveConf.ConfVars.METASTORE_METRICS,true);
  hiveConf.setBoolVar(HiveConf.ConfVars.HIVE_SUPPORT_CONCURRENCY,false);
  MetricsFactory.close();
  MetricsFactory.init(hiveConf);
  metrics=(CodahaleMetrics)MetricsFactory.getInstance();
  MetaStoreUtils.startMetaStore(port,ShimLoader.getHadoopThriftAuthBridge(),hiveConf);
  SessionState.start(new CliSessionState(hiveConf));
  driver=new Driver(hiveConf);
}
