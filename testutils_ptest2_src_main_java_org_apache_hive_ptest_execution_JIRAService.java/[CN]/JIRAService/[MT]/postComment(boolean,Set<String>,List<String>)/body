{
  DefaultHttpClient httpClient=new DefaultHttpClient();
  try {
    String buildTag=formatBuildTag(mBuildTag);
    List<String> comments=Lists.newArrayList();
    comments.add("");
    comments.add("");
    if (error || !failedTests.isEmpty()) {
      comments.add("{color:red}Overall{color}: -1 build exited with an error");
    }
 else {
      comments.add("{color:green}Overall{color}: +1 all checks pass");
    }
    comments.add("");
    if (!mPatch.isEmpty()) {
      comments.add("Here are the results of testing the latest attachment:");
      comments.add(mPatch);
    }
    comments.add("");
    if (failedTests.isEmpty()) {
      comments.add(formatSuccess("+1 all tests passed"));
    }
 else {
      comments.add(formatError("-1 due to " + failedTests.size() + " failed/errored test(s)"));
      comments.add("Failed tests:");
      comments.addAll(failedTests);
    }
    comments.add("");
    comments.add("Test results: " + mJenkinsURL + "/"+ buildTag+ "/testReport");
    comments.add("Console output: " + mJenkinsURL + "/"+ buildTag+ "/console");
    comments.add("");
    comments.add("Messages:");
    for (    String message : messages) {
      comments.add(message.replaceAll("\n","\\n"));
    }
    comments.add("");
    comments.add("This message is automatically generated.");
    mLogger.info("Comment: " + Joiner.on("\n").join(comments));
    String body=Joiner.on("\\n").join(comments);
    String url=String.format("%s/rest/api/2/issue/%s/comment",mUrl,mName);
    URL apiURL=new URL(mUrl);
    httpClient.getCredentialsProvider().setCredentials(new AuthScope(apiURL.getHost(),apiURL.getPort(),AuthScope.ANY_REALM),new UsernamePasswordCredentials(mUser,mPassword));
    BasicHttpContext localcontext=new BasicHttpContext();
    localcontext.setAttribute("preemptive-auth",new BasicScheme());
    httpClient.addRequestInterceptor(new PreemptiveAuth(),0);
    HttpPost request=new HttpPost(url);
    StringEntity params=new StringEntity(String.format("{\"body\": \"%s\"}",body));
    request.addHeader("Content-Type","application/json");
    request.setEntity(params);
    HttpResponse httpResponse=httpClient.execute(request,localcontext);
    StatusLine statusLine=httpResponse.getStatusLine();
    if (statusLine.getStatusCode() != 201) {
      throw new RuntimeException(statusLine.getStatusCode() + " " + statusLine.getReasonPhrase());
    }
    mLogger.info("JIRA Response Metadata: " + httpResponse);
  }
 catch (  Exception e) {
    mLogger.error("Encountered error attempting to post comment to " + mName,e);
  }
 finally {
    httpClient.getConnectionManager().shutdown();
  }
}
