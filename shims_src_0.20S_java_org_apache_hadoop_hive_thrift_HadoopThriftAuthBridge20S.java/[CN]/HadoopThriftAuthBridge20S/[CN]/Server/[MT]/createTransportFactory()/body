{
  String kerberosName=realUgi.getUserName();
  final String names[]=SaslRpcServer.splitKerberosName(kerberosName);
  if (names.length != 3) {
    throw new TTransportException("Kerberos principal should have 3 parts: " + kerberosName);
  }
  TSaslServerTransport.Factory transFactory=new TSaslServerTransport.Factory();
  transFactory.addServerDefinition(AuthMethod.KERBEROS.getMechanismName(),names[0],names[1],SaslRpcServer.SASL_PROPS,new SaslRpcServer.SaslGssCallbackHandler());
  transFactory.addServerDefinition(AuthMethod.DIGEST.getMechanismName(),null,SaslRpcServer.SASL_DEFAULT_REALM,SaslRpcServer.SASL_PROPS,new SaslDigestCallbackHandler(secretManager));
  return new TUGIAssumingTransportFactory(transFactory,realUgi);
}
