{
  OptimizeTezProcContext context=(OptimizeTezProcContext)procCtx;
  JoinOperator joinOp=(JoinOperator)nd;
  TezBucketJoinProcCtx tezBucketJoinProcCtx=new TezBucketJoinProcCtx(context.conf);
  if (!context.conf.getBoolVar(HiveConf.ConfVars.HIVECONVERTJOIN)) {
    Object retval=checkAndConvertSMBJoin(context,joinOp,tezBucketJoinProcCtx);
    if (retval == null) {
      return retval;
    }
 else {
      int pos=0;
      convertJoinSMBJoin(joinOp,context,pos,0,false);
      return null;
    }
  }
  int numBuckets=-1;
  int estimatedBuckets=-1;
  if (context.conf.getBoolVar(HiveConf.ConfVars.HIVE_CONVERT_JOIN_BUCKET_MAPJOIN_TEZ)) {
    for (    Operator<? extends OperatorDesc> parentOp : joinOp.getParentOperators()) {
      if (parentOp.getOpTraits().getNumBuckets() > 0) {
        numBuckets=(numBuckets < parentOp.getOpTraits().getNumBuckets()) ? parentOp.getOpTraits().getNumBuckets() : numBuckets;
      }
      if (parentOp instanceof ReduceSinkOperator) {
        ReduceSinkOperator rs=(ReduceSinkOperator)parentOp;
        estimatedBuckets=(estimatedBuckets < rs.getConf().getNumReducers()) ? rs.getConf().getNumReducers() : estimatedBuckets;
      }
    }
    if (numBuckets <= 0) {
      numBuckets=estimatedBuckets;
      if (numBuckets <= 0) {
        numBuckets=1;
      }
    }
  }
 else {
    numBuckets=1;
  }
  LOG.info("Estimated number of buckets " + numBuckets);
  int mapJoinConversionPos=getMapJoinConversionPos(joinOp,context,numBuckets);
  if (mapJoinConversionPos < 0) {
    Object retval=checkAndConvertSMBJoin(context,joinOp,tezBucketJoinProcCtx);
    if (retval == null) {
      return retval;
    }
 else {
      convertJoinSMBJoin(joinOp,context,0,0,false);
      return null;
    }
  }
  if (numBuckets > 1) {
    if (context.conf.getBoolVar(HiveConf.ConfVars.HIVE_CONVERT_JOIN_BUCKET_MAPJOIN_TEZ)) {
      if (convertJoinBucketMapJoin(joinOp,context,mapJoinConversionPos,tezBucketJoinProcCtx)) {
        return null;
      }
    }
  }
  LOG.info("Convert to non-bucketed map join");
  mapJoinConversionPos=getMapJoinConversionPos(joinOp,context,1);
  if (mapJoinConversionPos < 0) {
    int pos=0;
    convertJoinSMBJoin(joinOp,context,pos,0,false);
    return null;
  }
  MapJoinOperator mapJoinOp=convertJoinMapJoin(joinOp,context,mapJoinConversionPos);
  mapJoinOp.setOpTraits(new OpTraits(null,-1,null,joinOp.getOpTraits().getNumReduceSinks()));
  mapJoinOp.setStatistics(joinOp.getStatistics());
  for (  Operator<? extends OperatorDesc> childOp : mapJoinOp.getChildOperators()) {
    setAllChildrenTraitsToNull(childOp);
  }
  return null;
}
