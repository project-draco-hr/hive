{
  logger.info("Create batches for " + driver);
  List<String> qFileTestNames=Lists.newArrayList();
  for (  File test : checkNotNull(directory.listFiles(),directory.getAbsolutePath())) {
    String testName=test.getName();
    if (test.isFile() && testName.endsWith(".q") && (included.isEmpty() || included.contains(testName))) {
      qFileTestNames.add(testName);
    }
  }
  List<QFileTestBatch> testBatches=Lists.newArrayList();
  List<String> testBatch=Lists.newArrayList();
  for (  final String test : qFileTestNames) {
    if (excluded.contains(test)) {
      logger.info("Exlcuding test " + driver + " "+ test);
    }
 else     if (isolated.contains(test)) {
      logger.info("Executing isolated test " + driver + " "+ test);
      testBatches.add(new QFileTestBatch(testCasePropertyName,driver,queryFilesProperty,Sets.newHashSet(test),isParallel,getModuleName(driver)));
    }
 else {
      if (testBatch.size() >= batchSize) {
        testBatches.add(new QFileTestBatch(testCasePropertyName,driver,queryFilesProperty,Sets.newHashSet(testBatch),isParallel,getModuleName(driver)));
        testBatch=Lists.newArrayList();
      }
      testBatch.add(test);
    }
  }
  if (!testBatch.isEmpty()) {
    testBatches.add(new QFileTestBatch(testCasePropertyName,driver,queryFilesProperty,Sets.newHashSet(testBatch),isParallel,getModuleName(driver)));
  }
  return testBatches;
}
