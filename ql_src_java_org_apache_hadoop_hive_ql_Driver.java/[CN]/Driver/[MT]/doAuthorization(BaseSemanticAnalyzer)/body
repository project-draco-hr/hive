{
  HashSet<ReadEntity> inputs=sem.getInputs();
  HashSet<WriteEntity> outputs=sem.getOutputs();
  SessionState ss=SessionState.get();
  HiveOperation op=ss.getHiveOperation();
  Hive db=sem.getDb();
  if (op != null) {
    if (op.equals(HiveOperation.CREATETABLE_AS_SELECT) || op.equals(HiveOperation.CREATETABLE)) {
      ss.getAuthorizer().authorize(db.getDatabase(db.getCurrentDatabase()),null,HiveOperation.CREATETABLE_AS_SELECT.getOutputRequiredPrivileges());
    }
    if (outputs != null && outputs.size() > 0) {
      for (      WriteEntity write : outputs) {
        if (write.getType() == WriteEntity.Type.PARTITION) {
          Partition part=db.getPartition(write.getTable(),write.getPartition().getSpec(),false);
          if (part != null) {
            ss.getAuthorizer().authorize(write.getPartition(),null,op.getOutputRequiredPrivileges());
            continue;
          }
        }
        if (write.getTable() != null) {
          ss.getAuthorizer().authorize(write.getTable(),null,op.getOutputRequiredPrivileges());
        }
      }
    }
  }
  if (inputs != null && inputs.size() > 0) {
    Map<Table,List<String>> tab2Cols=new HashMap<Table,List<String>>();
    Map<Partition,List<String>> part2Cols=new HashMap<Partition,List<String>>();
    Map<String,Boolean> tableUsePartLevelAuth=new HashMap<String,Boolean>();
    for (    ReadEntity read : inputs) {
      if (read.getPartition() != null) {
        Table tbl=read.getTable();
        String tblName=tbl.getTableName();
        if (tableUsePartLevelAuth.get(tblName) == null) {
          boolean usePartLevelPriv=(tbl.getParameters().get("PARTITION_LEVEL_PRIVILEGE") != null && ("TRUE".equalsIgnoreCase(tbl.getParameters().get("PARTITION_LEVEL_PRIVILEGE"))));
          if (usePartLevelPriv) {
            tableUsePartLevelAuth.put(tblName,Boolean.TRUE);
          }
 else {
            tableUsePartLevelAuth.put(tblName,Boolean.FALSE);
          }
        }
      }
    }
    if (op.equals(HiveOperation.CREATETABLE_AS_SELECT) || op.equals(HiveOperation.QUERY)) {
      SemanticAnalyzer querySem=(SemanticAnalyzer)sem;
      ParseContext parseCtx=querySem.getParseContext();
      Map<TableScanOperator,Table> tsoTopMap=parseCtx.getTopToTable();
      for (      Map.Entry<String,Operator<? extends Serializable>> topOpMap : querySem.getParseContext().getTopOps().entrySet()) {
        Operator<? extends Serializable> topOp=topOpMap.getValue();
        if (topOp instanceof TableScanOperator && tsoTopMap.containsKey(topOp)) {
          TableScanOperator tableScanOp=(TableScanOperator)topOp;
          Table tbl=tsoTopMap.get(tableScanOp);
          List<Integer> neededColumnIds=tableScanOp.getNeededColumnIDs();
          List<FieldSchema> columns=tbl.getCols();
          List<String> cols=new ArrayList<String>();
          if (neededColumnIds != null && neededColumnIds.size() > 0) {
            for (int i=0; i < neededColumnIds.size(); i++) {
              cols.add(columns.get(neededColumnIds.get(i)).getName());
            }
          }
 else {
            for (int i=0; i < columns.size(); i++) {
              cols.add(columns.get(i).getName());
            }
          }
          if (tbl.isPartitioned() && tableUsePartLevelAuth.get(tbl.getTableName())) {
            String alias_id=topOpMap.getKey();
            PrunedPartitionList partsList=PartitionPruner.prune(parseCtx.getTopToTable().get(topOp),parseCtx.getOpToPartPruner().get(topOp),parseCtx.getConf(),alias_id,parseCtx.getPrunedPartitions());
            Set<Partition> parts=new HashSet<Partition>();
            parts.addAll(partsList.getConfirmedPartns());
            parts.addAll(partsList.getUnknownPartns());
            for (            Partition part : parts) {
              List<String> existingCols=part2Cols.get(part);
              if (existingCols == null) {
                existingCols=new ArrayList<String>();
              }
              existingCols.addAll(cols);
              part2Cols.put(part,existingCols);
            }
          }
 else {
            List<String> existingCols=tab2Cols.get(tbl);
            if (existingCols == null) {
              existingCols=new ArrayList<String>();
            }
            existingCols.addAll(cols);
            tab2Cols.put(tbl,existingCols);
          }
        }
      }
    }
    Set<String> tableAuthChecked=new HashSet<String>();
    for (    ReadEntity read : inputs) {
      Table tbl=null;
      if (read.getPartition() != null) {
        tbl=read.getPartition().getTable();
        if (tableUsePartLevelAuth.get(tbl.getTableName())) {
          List<String> cols=part2Cols.get(read.getPartition());
          if (cols != null && cols.size() > 0) {
            ss.getAuthorizer().authorize(read.getPartition().getTable(),read.getPartition(),cols,op.getInputRequiredPrivileges(),null);
          }
 else {
            ss.getAuthorizer().authorize(read.getPartition(),op.getInputRequiredPrivileges(),null);
          }
          continue;
        }
      }
 else       if (read.getTable() != null) {
        tbl=read.getTable();
      }
      if (tbl != null && !tableAuthChecked.contains(tbl.getTableName())) {
        List<String> cols=tab2Cols.get(tbl);
        if (cols != null && cols.size() > 0) {
          ss.getAuthorizer().authorize(tbl,null,cols,op.getInputRequiredPrivileges(),null);
        }
 else {
          ss.getAuthorizer().authorize(tbl,op.getInputRequiredPrivileges(),null);
        }
        tableAuthChecked.add(tbl.getTableName());
      }
    }
  }
}
