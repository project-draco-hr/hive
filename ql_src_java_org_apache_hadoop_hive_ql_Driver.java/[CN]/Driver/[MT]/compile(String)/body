{
  if (plan != null) {
    close();
    plan=null;
  }
  TaskFactory.resetId();
  try {
    ctx=new Context(conf);
    ParseDriver pd=new ParseDriver();
    ASTNode tree=pd.parse(command,ctx);
    tree=ParseUtils.findRootNonNullToken(tree);
    BaseSemanticAnalyzer sem=SemanticAnalyzerFactory.get(conf,tree);
    String hookName=HiveConf.getVar(conf,ConfVars.SEMANTIC_ANALYZER_HOOK);
    if (hookName != null) {
      AbstractSemanticAnalyzerHook hook=HiveUtils.getSemanticAnalyzerHook(conf,hookName);
      HiveSemanticAnalyzerHookContext hookCtx=new HiveSemanticAnalyzerHookContextImpl();
      hookCtx.setConf(conf);
      hook.preAnalyze(hookCtx,tree);
      sem.analyze(tree,ctx);
      hook.postAnalyze(hookCtx,sem.getRootTasks());
    }
 else {
      sem.analyze(tree,ctx);
    }
    LOG.info("Semantic Analysis Completed");
    sem.validate();
    plan=new QueryPlan(command,sem);
    if (plan.getFetchTask() != null) {
      plan.getFetchTask().initialize(conf,plan,null);
    }
    schema=getSchema(sem,conf);
    if ("true".equalsIgnoreCase(System.getProperty("test.serialize.qplan"))) {
      String queryPlanFileName=ctx.getLocalScratchDir(true) + Path.SEPARATOR_CHAR + "queryplan.xml";
      LOG.info("query plan = " + queryPlanFileName);
      queryPlanFileName=new Path(queryPlanFileName).toUri().getPath();
      FileOutputStream fos=new FileOutputStream(queryPlanFileName);
      Utilities.serializeQueryPlan(plan,fos);
      fos.close();
      FileInputStream fis=new FileInputStream(queryPlanFileName);
      QueryPlan newPlan=Utilities.deserializeQueryPlan(fis,conf);
      fis.close();
      plan=newPlan;
    }
    if (plan.getFetchTask() != null) {
      plan.getFetchTask().initialize(conf,plan,null);
    }
    return (0);
  }
 catch (  SemanticException e) {
    errorMessage="FAILED: Error in semantic analysis: " + e.getMessage();
    SQLState=ErrorMsg.findSQLState(e.getMessage());
    console.printError(errorMessage,"\n" + org.apache.hadoop.util.StringUtils.stringifyException(e));
    return (10);
  }
catch (  ParseException e) {
    errorMessage="FAILED: Parse Error: " + e.getMessage();
    SQLState=ErrorMsg.findSQLState(e.getMessage());
    console.printError(errorMessage,"\n" + org.apache.hadoop.util.StringUtils.stringifyException(e));
    return (11);
  }
catch (  Exception e) {
    errorMessage="FAILED: Hive Internal Error: " + Utilities.getNameMessage(e);
    SQLState=ErrorMsg.findSQLState(e.getMessage());
    console.printError(errorMessage + "\n" + org.apache.hadoop.util.StringUtils.stringifyException(e));
    return (12);
  }
}
