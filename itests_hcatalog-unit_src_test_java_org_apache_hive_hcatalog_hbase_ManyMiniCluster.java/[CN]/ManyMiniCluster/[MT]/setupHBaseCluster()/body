{
  final int numRegionServers=1;
  try {
    hbaseDir=new File(workDir,"hbase").getCanonicalPath();
    hbaseDir=hbaseDir.replaceAll("\\\\","/");
    hbaseRoot="file:///" + hbaseDir;
    if (hbaseConf == null)     hbaseConf=HBaseConfiguration.create();
    hbaseConf.set("hbase.rootdir",hbaseRoot);
    hbaseConf.set("hbase.master","local");
    hbaseConf.setInt(HConstants.ZOOKEEPER_CLIENT_PORT,zookeeperPort);
    hbaseConf.set(HConstants.ZOOKEEPER_QUORUM,"127.0.0.1");
    hbaseConf.setInt("hbase.master.port",findFreePort());
    hbaseConf.setInt("hbase.master.info.port",-1);
    hbaseConf.setInt("hbase.regionserver.port",findFreePort());
    hbaseConf.setInt("hbase.regionserver.info.port",-1);
    hbaseCluster=new MiniHBaseCluster(hbaseConf,numRegionServers);
    hbaseConf.set("hbase.master",hbaseCluster.getMaster().getServerName().getHostAndPort());
    new HTable(hbaseConf,HConstants.META_TABLE_NAME);
  }
 catch (  Exception e) {
    throw new IllegalStateException("Failed to setup HBase Cluster",e);
  }
}
