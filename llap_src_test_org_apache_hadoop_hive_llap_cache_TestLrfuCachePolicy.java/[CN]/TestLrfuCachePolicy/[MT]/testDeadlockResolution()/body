{
  int heapSize=4;
  LOG.info("Testing deadlock resolution");
  ArrayList<WeakBuffer> inserted=new ArrayList<WeakBuffer>(heapSize);
  LrfuCachePolicy lrfu=new LrfuCachePolicy(new HiveConf(),1,heapSize);
  for (int i=0; i < heapSize; ++i) {
    WeakBuffer buffer=BufferPool.allocateFake();
    assertNull(cache(lrfu,buffer));
    inserted.add(buffer);
  }
  WeakBuffer locked=inserted.get(0);
  lock(lrfu,locked);
  WeakBuffer evicted=lrfu.evictOneMoreBlock();
  assertNotNull(evicted);
  assertTrue(evicted.isInvalid());
  assertNotSame(locked,evicted);
  unlock(lrfu,locked);
}
