{
  StatsAggregator statsAggregator=null;
  int ret=0;
  StatsCollectionContext scc=null;
  EnvironmentContext environmentContext=null;
  try {
    Warehouse wh=new Warehouse(conf);
    if (!getWork().getNoStatsAggregator() && !getWork().isNoScanAnalyzeCommand()) {
      try {
        scc=getContext();
        statsAggregator=createStatsAggregator(scc);
      }
 catch (      HiveException e) {
        if (HiveConf.getBoolVar(conf,HiveConf.ConfVars.HIVE_STATS_RELIABLE)) {
          throw e;
        }
        console.printError(ErrorMsg.STATS_SKIPPING_BY_ERROR.getErrorCodedMsg(e.toString()));
      }
    }
    List<Partition> partitions=getPartitionsList(db);
    boolean atomic=HiveConf.getBoolVar(conf,HiveConf.ConfVars.HIVE_STATS_ATOMIC);
    String tableFullName=table.getDbName() + "." + table.getTableName();
    if (partitions == null) {
      org.apache.hadoop.hive.metastore.api.Table tTable=table.getTTable();
      Map<String,String> parameters=tTable.getParameters();
      if (work.getTableSpecs() != null || (work.getLoadTableDesc() != null && work.getLoadTableDesc().getReplace()) || (work.getLoadFileDesc() != null && !work.getLoadFileDesc().getDestinationCreateTable().isEmpty())) {
        StatsSetupConst.setBasicStatsState(parameters,StatsSetupConst.TRUE);
      }
      if (!existStats(parameters) && atomic) {
        return 0;
      }
      if (work.isClearAggregatorStats()) {
        StatsSetupConst.setBasicStatsState(parameters,StatsSetupConst.FALSE);
      }
      updateQuickStats(wh,parameters,tTable.getSd());
      if (StatsSetupConst.areBasicStatsUptoDate(parameters)) {
        if (statsAggregator != null) {
          String prefix=getAggregationPrefix(table,null);
          updateStats(statsAggregator,parameters,prefix,atomic);
        }
        if (!getWork().getNoStatsAggregator()) {
          environmentContext=new EnvironmentContext();
          environmentContext.putToProperties(StatsSetupConst.STATS_GENERATED,StatsSetupConst.TASK);
        }
      }
      getHive().alterTable(tableFullName,new Table(tTable),environmentContext);
      if (conf.getBoolVar(ConfVars.TEZ_EXEC_SUMMARY)) {
        console.printInfo("Table " + tableFullName + " stats: ["+ toString(parameters)+ ']');
      }
      LOG.info("Table " + tableFullName + " stats: ["+ toString(parameters)+ ']');
    }
 else {
      List<Partition> updates=new ArrayList<Partition>();
      for (      Partition partn : partitions) {
        org.apache.hadoop.hive.metastore.api.Partition tPart=partn.getTPartition();
        Map<String,String> parameters=tPart.getParameters();
        if (work.getTableSpecs() != null || (work.getLoadTableDesc() != null && work.getLoadTableDesc().getReplace()) || (work.getLoadFileDesc() != null && !work.getLoadFileDesc().getDestinationCreateTable().isEmpty())) {
          StatsSetupConst.setBasicStatsState(parameters,StatsSetupConst.TRUE);
        }
        if (!existStats(parameters) && atomic) {
          continue;
        }
        if (work.isClearAggregatorStats()) {
          StatsSetupConst.setBasicStatsState(parameters,StatsSetupConst.FALSE);
        }
        updateQuickStats(wh,parameters,tPart.getSd());
        if (StatsSetupConst.areBasicStatsUptoDate(parameters)) {
          if (statsAggregator != null) {
            String prefix=getAggregationPrefix(table,partn);
            updateStats(statsAggregator,parameters,prefix,atomic);
          }
          if (!getWork().getNoStatsAggregator()) {
            environmentContext=new EnvironmentContext();
            environmentContext.putToProperties(StatsSetupConst.STATS_GENERATED,StatsSetupConst.TASK);
          }
        }
        updates.add(new Partition(table,tPart));
        if (conf.getBoolVar(ConfVars.TEZ_EXEC_SUMMARY)) {
          console.printInfo("Partition " + tableFullName + partn.getSpec()+ " stats: ["+ toString(parameters)+ ']');
        }
        LOG.info("Partition " + tableFullName + partn.getSpec()+ " stats: ["+ toString(parameters)+ ']');
      }
      if (!updates.isEmpty()) {
        db.alterPartitions(tableFullName,updates,environmentContext);
      }
    }
  }
 catch (  Exception e) {
    console.printInfo("[Warning] could not update stats.","Failed with exception " + e.getMessage() + "\n"+ StringUtils.stringifyException(e));
    if (work.isStatsReliable()) {
      ret=1;
    }
  }
 finally {
    if (statsAggregator != null) {
      statsAggregator.closeConnection(scc);
    }
  }
  return ret;
}
