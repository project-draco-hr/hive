{
  try {
    OrcFileKeyWrapper k=null;
    if (key instanceof CombineHiveKey) {
      k=(OrcFileKeyWrapper)((CombineHiveKey)key).getKey();
    }
 else {
      k=(OrcFileKeyWrapper)key;
    }
    fixTmpPathAlterTable(k.getInputPath().getParent());
    if (prevPath == null) {
      prevPath=k.getInputPath();
      reader=OrcFile.createReader(fs,k.inputPath);
    }
    if (outWriter == null) {
      compression=k.getCompression();
      compressBuffSize=k.getCompressBufferSize();
      version=k.getVersionList();
      columnCount=k.getTypes().get(0).getSubtypesCount();
      rowIndexStride=k.getRowIndexStride();
      outWriter=OrcFile.createWriter(outPath,OrcFile.writerOptions(jc).compress(compression).inspector(reader.getObjectInspector()));
    }
    if ((k.getTypes().get(0).getSubtypesCount() != columnCount)) {
      throw new IOException("ORCFileMerge failed because the input files are not compatible." + " Column counts does not match.");
    }
    if (!k.compression.equals(compression)) {
      throw new IOException("ORCFileMerge failed because the input files are not compatible." + " Compression codec does not match.");
    }
    if (k.compressBufferSize != compressBuffSize) {
      throw new IOException("ORCFileMerge failed because the input files are not compatible." + " Compression buffer size does not match.");
    }
    if (!k.versionList.equals(version)) {
      throw new IOException("ORCFileMerge failed because the input files are not compatible." + " Version does not match.");
    }
    if (k.rowIndexStride != rowIndexStride) {
      throw new IOException("ORCFileMerge failed because the input files are not compatible." + " Row index stride does not match.");
    }
    if (!k.getInputPath().equals(prevPath)) {
      reader=OrcFile.createReader(fs,k.inputPath);
    }
    buffer=new byte[(int)value.stripeInformation.getLength()];
    fdis=fs.open(k.inputPath);
    fdis.readFully(value.stripeInformation.getOffset(),buffer,0,(int)value.stripeInformation.getLength());
    ((WriterImpl)outWriter).appendStripe(buffer,value.getStripeInformation(),value.getStripeStatistics());
    LOG.info("Merged stripe from file " + k.inputPath + " [ offset : "+ value.getStripeInformation().getOffset()+ " length: "+ value.getStripeInformation().getLength()+ " ]");
    if (value.isLastStripeInFile()) {
      ((WriterImpl)outWriter).appendUserMetadata(value.getUserMetadata());
    }
  }
 catch (  Throwable e) {
    this.exception=true;
    close();
    throw new IOException(e);
  }
}
