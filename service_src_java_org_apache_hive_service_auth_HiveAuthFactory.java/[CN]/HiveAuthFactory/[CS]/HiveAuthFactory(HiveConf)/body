{
  this.conf=conf;
  transportMode=conf.getVar(HiveConf.ConfVars.HIVE_SERVER2_TRANSPORT_MODE);
  authTypeStr=conf.getVar(HiveConf.ConfVars.HIVE_SERVER2_AUTHENTICATION);
  hadoopAuth=conf.get(HADOOP_SECURITY_AUTHENTICATION,"simple");
  if (authTypeStr == null) {
    if ("http".equalsIgnoreCase(transportMode)) {
      authTypeStr=AuthTypes.NOSASL.getAuthName();
    }
 else {
      authTypeStr=AuthTypes.NONE.getAuthName();
    }
  }
  if (hadoopAuth.equalsIgnoreCase("kerberos") && !authTypeStr.equalsIgnoreCase(AuthTypes.NOSASL.getAuthName())) {
    saslServer=ShimLoader.getHadoopThriftAuthBridge().createServer(conf.getVar(ConfVars.HIVE_SERVER2_KERBEROS_KEYTAB),conf.getVar(ConfVars.HIVE_SERVER2_KERBEROS_PRINCIPAL));
    delegationTokenManager=new HiveDelegationTokenManager();
    try {
      HMSHandler baseHandler=null;
      String tokenStoreClass=conf.getVar(HiveConf.ConfVars.METASTORE_CLUSTER_DELEGATION_TOKEN_STORE_CLS);
      if (tokenStoreClass.equals(DBTokenStore.class.getName())) {
        baseHandler=new HiveMetaStore.HMSHandler("New db based metastore server",conf,true);
      }
      delegationTokenManager.startDelegationTokenSecretManager(conf,baseHandler,ServerMode.HIVESERVER2);
      saslServer.setSecretManager(delegationTokenManager.getSecretManager());
    }
 catch (    MetaException|IOException e) {
      throw new ServiceException("Failed to start token manager",e);
    }
  }
}
