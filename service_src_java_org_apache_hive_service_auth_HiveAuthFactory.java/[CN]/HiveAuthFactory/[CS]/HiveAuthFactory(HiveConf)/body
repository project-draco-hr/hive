{
  this.conf=conf;
  transportMode=conf.getVar(HiveConf.ConfVars.HIVE_SERVER2_TRANSPORT_MODE);
  authTypeStr=conf.getVar(HiveConf.ConfVars.HIVE_SERVER2_AUTHENTICATION);
  if ("http".equalsIgnoreCase(transportMode)) {
    if (authTypeStr == null) {
      authTypeStr=AuthTypes.NOSASL.getAuthName();
    }
  }
 else {
    if (authTypeStr == null) {
      authTypeStr=AuthTypes.NONE.getAuthName();
    }
    if (authTypeStr.equalsIgnoreCase(AuthTypes.KERBEROS.getAuthName())) {
      saslServer=ShimLoader.getHadoopThriftAuthBridge().createServer(conf.getVar(ConfVars.HIVE_SERVER2_KERBEROS_KEYTAB),conf.getVar(ConfVars.HIVE_SERVER2_KERBEROS_PRINCIPAL));
      try {
        Object rawStore=null;
        String tokenStoreClass=conf.getVar(HiveConf.ConfVars.METASTORE_CLUSTER_DELEGATION_TOKEN_STORE_CLS);
        if (tokenStoreClass.equals(DBTokenStore.class.getName())) {
          HMSHandler baseHandler=new HiveMetaStore.HMSHandler("new db based metaserver",conf,true);
          rawStore=baseHandler.getMS();
        }
        saslServer.startDelegationTokenSecretManager(conf,rawStore,ServerMode.HIVESERVER2);
      }
 catch (      MetaException|IOException e) {
        throw new TTransportException("Failed to start token manager",e);
      }
    }
  }
}
