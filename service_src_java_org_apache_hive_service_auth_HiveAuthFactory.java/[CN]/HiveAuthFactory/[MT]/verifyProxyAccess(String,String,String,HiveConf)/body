{
  try {
    UserGroupInformation sessionUgi;
    if (ShimLoader.getHadoopShims().isSecurityEnabled()) {
      KerberosNameShim kerbName=ShimLoader.getHadoopShims().getKerberosNameShim(realUser);
      String shortPrincipalName=kerbName.getServiceName();
      sessionUgi=ShimLoader.getHadoopShims().createProxyUser(shortPrincipalName);
    }
 else {
      sessionUgi=ShimLoader.getHadoopShims().createRemoteUser(realUser,null);
    }
    if (!proxyUser.equalsIgnoreCase(realUser)) {
      ShimLoader.getHadoopShims().authorizeProxyAccess(proxyUser,sessionUgi,ipAddress,hiveConf);
    }
  }
 catch (  IOException e) {
    throw new HiveSQLException("Failed to validate proxy privilege of " + realUser + " for "+ proxyUser,e);
  }
}
