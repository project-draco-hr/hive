{
  this.timeout=timeout;
  RemovalListener<HiveClientCacheKey,CacheableHiveMetaStoreClient> removalListener=new RemovalListener<HiveClientCacheKey,CacheableHiveMetaStoreClient>(){
    @Override public void onRemoval(    RemovalNotification<HiveClientCacheKey,CacheableHiveMetaStoreClient> notification){
      CacheableHiveMetaStoreClient hiveMetaStoreClient=notification.getValue();
      if (hiveMetaStoreClient != null) {
synchronized (CACHE_TEARDOWN_LOCK) {
          hiveMetaStoreClient.setExpiredFromCache();
          hiveMetaStoreClient.tearDownIfUnused();
        }
      }
    }
  }
;
  hiveCache=CacheBuilder.newBuilder().expireAfterWrite(timeout,TimeUnit.SECONDS).removalListener(removalListener).build();
  Runnable cleanupThread=new Runnable(){
    @Override public void run(){
      hiveCache.cleanUp();
    }
  }
;
  long cleanupInterval=DEFAULT_HIVE_CACHE_EXPIRY_TIME_SECONDS;
  if (timeout > cleanupInterval) {
    cleanupInterval=timeout;
  }
  ThreadFactory daemonThreadFactory=(new ThreadFactoryBuilder()).setDaemon(true).setNameFormat("HiveClientCache-cleaner-%d").build();
  cleanupHandle=Executors.newScheduledThreadPool(1,daemonThreadFactory).scheduleWithFixedDelay(cleanupThread,timeout + 5,cleanupInterval,TimeUnit.SECONDS);
  Thread cleanupHiveClientShutdownThread=new Thread(){
    @Override public void run(){
      LOG.debug("Cleaning up hive client cache in ShutDown hook");
      cleanupHandle.cancel(false);
      closeAllClientsQuietly();
    }
  }
;
  Runtime.getRuntime().addShutdownHook(cleanupHiveClientShutdownThread);
}
