{
  if (expr == null) {
    return null;
  }
  if (expr instanceof ExprNodeConstantDesc) {
    if (((ExprNodeConstantDesc)expr).getValue() == null)     return null;
    if (!isBooleanExpr(expr)) {
      throw new IllegalStateException("Unexpected non-boolean ExprNodeConstantDesc: " + expr.getExprString());
    }
    return expr;
  }
 else   if (expr instanceof ExprNodeGenericFuncDesc) {
    GenericUDF udf=((ExprNodeGenericFuncDesc)expr).getGenericUDF();
    boolean isAnd=udf instanceof GenericUDFOPAnd;
    boolean isOr=udf instanceof GenericUDFOPOr;
    List<ExprNodeDesc> children=expr.getChildren();
    if (isAnd) {
      List<ExprNodeDesc> newChildren=new ArrayList<ExprNodeDesc>();
      boolean allTrue=true;
      for (      ExprNodeDesc child : children) {
        ExprNodeDesc compactChild=compactExpr(child);
        if (compactChild != null) {
          if (!isTrueExpr(compactChild)) {
            newChildren.add(compactChild);
            allTrue=false;
          }
          if (isFalseExpr(compactChild)) {
            return new ExprNodeConstantDesc(Boolean.FALSE);
          }
        }
 else {
          allTrue=false;
        }
      }
      if (allTrue) {
        return new ExprNodeConstantDesc(Boolean.TRUE);
      }
      if (newChildren.size() == 0) {
        return null;
      }
      if (newChildren.size() == 1) {
        return newChildren.get(0);
      }
      ((ExprNodeGenericFuncDesc)expr).setChildren(newChildren);
    }
 else     if (isOr) {
      List<ExprNodeDesc> newChildren=new ArrayList<ExprNodeDesc>();
      boolean allFalse=true;
      boolean isNull=false;
      for (      ExprNodeDesc child : children) {
        ExprNodeDesc compactChild=compactExpr(child);
        if (compactChild != null) {
          if (isTrueExpr(compactChild)) {
            return new ExprNodeConstantDesc(Boolean.TRUE);
          }
          if (!isNull && !isFalseExpr(compactChild)) {
            newChildren.add(compactChild);
            allFalse=false;
          }
        }
 else {
          isNull=true;
        }
      }
      if (isNull) {
        return null;
      }
      if (allFalse) {
        return new ExprNodeConstantDesc(Boolean.FALSE);
      }
      if (newChildren.size() == 1) {
        return newChildren.get(0);
      }
      ((ExprNodeGenericFuncDesc)expr).setChildren(newChildren);
    }
    return expr;
  }
 else {
    throw new IllegalStateException("Unexpected type of ExprNodeDesc: " + expr.getExprString());
  }
}
