{
  final HiveConf c=new HiveConf();
  LOG.debug("Creating hive metastore delegation token for user " + user);
  final UserGroupInformation ugi=UgiFactory.getUgi(user);
  UserGroupInformation real=ugi.getRealUser();
  return real.doAs(new PrivilegedExceptionAction<String>(){
    public String run() throws IOException, TException, InterruptedException {
      final HiveMetaStoreClient client=new HiveMetaStoreClient(c);
      return ugi.doAs(new PrivilegedExceptionAction<String>(){
        public String run() throws IOException, TException, InterruptedException {
          String u=ugi.getUserName();
          return client.getDelegationToken(u);
        }
      }
);
    }
  }
);
}
