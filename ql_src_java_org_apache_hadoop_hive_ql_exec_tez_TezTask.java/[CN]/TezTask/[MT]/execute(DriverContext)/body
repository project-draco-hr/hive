{
  int rc=1;
  boolean cleanContext=false;
  Context ctx=null;
  DAGClient client=null;
  TezSessionState session=null;
  try {
    ctx=driverContext.getCtx();
    if (ctx == null) {
      ctx=new Context(conf);
      cleanContext=true;
    }
    SessionState ss=SessionState.get();
    session=ss.getTezSession();
    session=TezSessionPoolManager.getInstance().getSession(session,conf,false);
    ss.setTezSession(session);
    JobConf jobConf=utils.createConfiguration(conf);
    String[] inputOutputJars=work.configureJobConfAndExtractJars(jobConf);
    Path scratchDir=ctx.getMRScratchDir();
    scratchDir=utils.createTezDir(scratchDir,conf);
    boolean hasResources=session.hasResources(inputOutputJars);
    if (ss.hasAddedResource()) {
      hasResources=false;
      ss.setAddedResource(false);
    }
    if (!hasResources && session.isOpen()) {
      LOG.info("Tez session being reopened to pass custom jars to AM");
      TezSessionPoolManager.getInstance().close(session);
      session=TezSessionPoolManager.getInstance().getSession(null,conf,false);
      ss.setTezSession(session);
    }
    if (!session.isOpen()) {
      LOG.info("Tez session hasn't been created yet. Opening session");
      session.open(conf,inputOutputJars);
    }
    List<LocalResource> additionalLr=session.getLocalizedResources();
    LocalResource appJarLr=session.getAppJarLr();
    DAG dag=build(jobConf,work,scratchDir,appJarLr,additionalLr,ctx);
    client=submit(jobConf,dag,scratchDir,appJarLr,session);
    TezJobMonitor monitor=new TezJobMonitor();
    rc=monitor.monitorExecution(client,ctx.getHiveTxnManager(),conf);
    Set<StatusGetOpts> statusGetOpts=EnumSet.of(StatusGetOpts.GET_COUNTERS);
    counters=client.getDAGStatus(statusGetOpts).getDAGCounters();
    TezSessionPoolManager.getInstance().returnSession(session);
    if (LOG.isInfoEnabled()) {
      for (      CounterGroup group : counters) {
        LOG.info(group.getDisplayName() + ":");
        for (        TezCounter counter : group) {
          LOG.info("   " + counter.getDisplayName() + ": "+ counter.getValue());
        }
      }
    }
  }
 catch (  Exception e) {
    LOG.error("Failed to execute tez graph.",e);
  }
 finally {
    Utilities.clearWork(conf);
    if (cleanContext) {
      try {
        ctx.clear();
      }
 catch (      Exception e) {
        LOG.warn("Failed to clean up after tez job");
      }
    }
    if (client != null) {
      rc=close(work,rc);
    }
  }
  return rc;
}
