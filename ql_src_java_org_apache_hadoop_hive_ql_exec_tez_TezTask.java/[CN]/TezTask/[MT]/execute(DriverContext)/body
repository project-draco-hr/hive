{
  int rc=1;
  boolean cleanContext=false;
  Context ctx=null;
  DAGClient client=null;
  TezSessionState session=null;
  try {
    ctx=driverContext.getCtx();
    if (ctx == null) {
      ctx=new Context(conf);
      cleanContext=true;
    }
    SessionState ss=SessionState.get();
    session=ss.getTezSession();
    if (!session.isOpen()) {
      session.open(ss.getSessionId(),conf);
    }
    Path scratchDir=new Path(ctx.getMRScratchDir());
    DagUtils.createTezDir(scratchDir,conf);
    JobConf jobConf=DagUtils.createConfiguration(conf);
    LocalResource appJarLr=session.getAppJarLr();
    DAG dag=build(jobConf,work,scratchDir,appJarLr,ctx);
    client=submit(jobConf,dag,scratchDir,appJarLr,session.getSession());
    TezJobMonitor monitor=new TezJobMonitor();
    rc=monitor.monitorExecution(client);
  }
 catch (  Exception e) {
    LOG.error("Failed to execute tez graph.",e);
  }
 finally {
    Utilities.clearWork(conf);
    if (cleanContext) {
      try {
        ctx.clear();
      }
 catch (      Exception e) {
        LOG.warn("Failed to clean up after tez job");
      }
    }
    if (client != null) {
      rc=close(work,rc);
    }
  }
  return rc;
}
