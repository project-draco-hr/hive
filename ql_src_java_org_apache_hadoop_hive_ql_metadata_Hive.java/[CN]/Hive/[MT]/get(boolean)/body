{
  Hive db=hiveDB.get();
  if (db != null && !db.isCurrentUserOwner()) {
    LOG.debug("Creating new db. db.isCurrentUserOwner = " + db.isCurrentUserOwner());
    db.close();
    db=null;
  }
  if (db == null) {
    SessionState session=SessionState.get();
    HiveConf conf=session == null ? new HiveConf(Hive.class) : session.getConf();
    db=new Hive(conf,doRegisterAllFns);
    hiveDB.set(db);
  }
  return db;
}
