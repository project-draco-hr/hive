{
  if (!authenticationMethod.get().equals(AuthenticationMethod.KERBEROS)) {
    throw new AuthorizationException("Delegation Token can be issued only with kerberos authentication. " + "Current AuthenticationMethod: " + authenticationMethod.get());
  }
  UserGroupInformation currUser=UserGroupInformation.getCurrentUser();
  UserGroupInformation ownerUgi=UserGroupInformation.createRemoteUser(owner);
  if (!ownerUgi.getShortUserName().equals(currUser.getShortUserName())) {
    ownerUgi=UserGroupInformation.createProxyUser(owner,UserGroupInformation.getCurrentUser());
    InetAddress remoteAddr=getRemoteAddress();
    ProxyUsers.authorize(ownerUgi,remoteAddr.getHostAddress(),null);
  }
  return ownerUgi.doAs(new PrivilegedExceptionAction<String>(){
    public String run() throws IOException {
      return secretManager.getDelegationToken(renewer);
    }
  }
);
}
