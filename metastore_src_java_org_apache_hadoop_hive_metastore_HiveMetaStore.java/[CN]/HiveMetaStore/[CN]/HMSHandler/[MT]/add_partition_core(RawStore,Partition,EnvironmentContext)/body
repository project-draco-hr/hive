{
  boolean success=false;
  Table tbl=null;
  try {
    ms.openTransaction();
    tbl=ms.getTable(part.getDbName(),part.getTableName());
    if (tbl == null) {
      throw new InvalidObjectException("Unable to add partition because table or database do not exist");
    }
    firePreEvent(new PreAddPartitionEvent(tbl,part,this));
    boolean shouldAdd=startAddPartition(ms,part,false);
    assert shouldAdd;
    boolean madeDir=createLocationForAddedPartition(tbl,part);
    try {
      initializeAddedPartition(tbl,part,madeDir);
      success=ms.addPartition(part);
    }
  finally {
      if (!success && madeDir) {
        wh.deleteDir(new Path(part.getSd().getLocation()),true);
      }
    }
    success=success && ms.commitTransaction();
  }
  finally {
    if (!success) {
      ms.rollbackTransaction();
    }
    fireMetaStoreAddPartitionEvent(tbl,Arrays.asList(part),envContext,success);
  }
  return part;
}
