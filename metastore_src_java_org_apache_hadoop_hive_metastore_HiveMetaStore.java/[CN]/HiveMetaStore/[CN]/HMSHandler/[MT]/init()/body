{
  rawStoreClassName=hiveConf.getVar(HiveConf.ConfVars.METASTORE_RAW_STORE_IMPL);
  initListeners=MetaStoreUtils.getMetaStoreListeners(MetaStoreInitListener.class,hiveConf,hiveConf.getVar(HiveConf.ConfVars.METASTORE_INIT_HOOKS));
  for (  MetaStoreInitListener singleInitListener : initListeners) {
    MetaStoreInitContext context=new MetaStoreInitContext();
    singleInitListener.onInit(context);
  }
  String alterHandlerName=hiveConf.get("hive.metastore.alter.impl",HiveAlterHandler.class.getName());
  alterHandler=(AlterHandler)ReflectionUtils.newInstance(MetaStoreUtils.getClass(alterHandlerName),hiveConf);
  wh=new Warehouse(hiveConf);
synchronized (HMSHandler.class) {
    if (currentUrl == null || !currentUrl.equals(MetaStoreInit.getConnectionURL(hiveConf))) {
      createDefaultDB();
      createDefaultRoles();
      addAdminUsers();
      currentUrl=MetaStoreInit.getConnectionURL(hiveConf);
    }
  }
  if (hiveConf.getBoolean("hive.metastore.metrics.enabled",false)) {
    try {
      Metrics.init();
    }
 catch (    Exception e) {
      LOG.error("error in Metrics init: " + e.getClass().getName() + " "+ e.getMessage(),e);
    }
  }
  preListeners=MetaStoreUtils.getMetaStoreListeners(MetaStorePreEventListener.class,hiveConf,hiveConf.getVar(HiveConf.ConfVars.METASTORE_PRE_EVENT_LISTENERS));
  listeners=MetaStoreUtils.getMetaStoreListeners(MetaStoreEventListener.class,hiveConf,hiveConf.getVar(HiveConf.ConfVars.METASTORE_EVENT_LISTENERS));
  endFunctionListeners=MetaStoreUtils.getMetaStoreListeners(MetaStoreEndFunctionListener.class,hiveConf,hiveConf.getVar(HiveConf.ConfVars.METASTORE_END_FUNCTION_LISTENERS));
  String partitionValidationRegex=hiveConf.getVar(HiveConf.ConfVars.METASTORE_PARTITION_NAME_WHITELIST_PATTERN);
  if (partitionValidationRegex != null && !partitionValidationRegex.isEmpty()) {
    partitionValidationPattern=Pattern.compile(partitionValidationRegex);
  }
 else {
    partitionValidationPattern=null;
  }
  long cleanFreq=hiveConf.getTimeVar(ConfVars.METASTORE_EVENT_CLEAN_FREQ,TimeUnit.MILLISECONDS);
  if (cleanFreq > 0) {
    Timer cleaner=new Timer("Metastore Events Cleaner Thread",true);
    cleaner.schedule(new EventCleanerTask(this),cleanFreq,cleanFreq);
  }
}
