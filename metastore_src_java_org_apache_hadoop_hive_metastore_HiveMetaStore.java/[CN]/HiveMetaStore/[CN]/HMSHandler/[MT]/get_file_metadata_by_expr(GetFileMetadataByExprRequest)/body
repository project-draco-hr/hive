{
  GetFileMetadataByExprResult result=new GetFileMetadataByExprResult();
  RawStore ms=getMS();
  if (!ms.isFileMetadataSupported()) {
    result.setIsSupported(false);
    result.setMetadata(EMPTY_MAP_FM2);
    return result;
  }
  result.setIsSupported(true);
  List<Long> fileIds=req.getFileIds();
  byte[] expr=req.getExpr();
  boolean needMetadata=req.isDoGetFooters();
  ByteBuffer[] metadatas=new ByteBuffer[fileIds.size()];
  ByteBuffer[] stripeBitsets=new ByteBuffer[fileIds.size()];
  boolean[] eliminated=new boolean[fileIds.size()];
  getMS().getFileMetadataByExpr(fileIds,expr,metadatas,stripeBitsets,eliminated);
  for (int i=0; i < metadatas.length; ++i) {
    long fileId=fileIds.get(i);
    ByteBuffer metadata=metadatas[i];
    if (metadata == null)     continue;
    metadata=(eliminated[i] || !needMetadata) ? null : handleReadOnlyBufferForThrift(metadata);
    MetadataPpdResult mpr=new MetadataPpdResult();
    ByteBuffer bitset=eliminated[i] ? null : handleReadOnlyBufferForThrift(stripeBitsets[i]);
    mpr.setMetadata(metadata);
    mpr.setIncludeBitset(bitset);
    result.putToMetadata(fileId,mpr);
  }
  if (!result.isSetMetadata()) {
    result.setMetadata(EMPTY_MAP_FM2);
  }
  return result;
}
