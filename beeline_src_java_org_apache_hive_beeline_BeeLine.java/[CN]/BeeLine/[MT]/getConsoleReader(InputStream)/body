{
  if (inputStream != null) {
    consoleReader=new ConsoleReader(inputStream,new PrintWriter(getOutputStream(),true));
  }
 else {
    consoleReader=new ConsoleReader();
  }
  ByteArrayInputStream historyBuffer=null;
  if (new File(getOpts().getHistoryFile()).isFile()) {
    try {
      FileInputStream historyIn=new FileInputStream(getOpts().getHistoryFile());
      ByteArrayOutputStream hist=new ByteArrayOutputStream();
      int n;
      while ((n=historyIn.read()) != -1) {
        hist.write(n);
      }
      historyIn.close();
      historyBuffer=new ByteArrayInputStream(hist.toByteArray());
    }
 catch (    Exception e) {
      handleException(e);
    }
  }
  try {
    PrintWriter historyOut=new PrintWriter(new FileWriter(getOpts().getHistoryFile()),true);
    consoleReader.getHistory().setOutput(historyOut);
  }
 catch (  Exception e) {
    handleException(e);
  }
  if (inputStream instanceof FileInputStream) {
    return consoleReader;
  }
  try {
    if (historyBuffer != null) {
      consoleReader.getHistory().load(historyBuffer);
    }
  }
 catch (  Exception e) {
    handleException(e);
  }
  consoleReader.addCompletor(new BeeLineCompletor(this));
  return consoleReader;
}
