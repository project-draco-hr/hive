{
  try {
    verifyHttpConfiguration(hiveConf);
    String portString=System.getenv("HIVE_SERVER2_THRIFT_HTTP_PORT");
    if (portString != null) {
      portNum=Integer.valueOf(portString);
    }
 else {
      portNum=hiveConf.getIntVar(ConfVars.HIVE_SERVER2_THRIFT_HTTP_PORT);
    }
    minWorkerThreads=hiveConf.getIntVar(ConfVars.HIVE_SERVER2_THRIFT_HTTP_MIN_WORKER_THREADS);
    maxWorkerThreads=hiveConf.getIntVar(ConfVars.HIVE_SERVER2_THRIFT_HTTP_MAX_WORKER_THREADS);
    workerKeepAliveTime=hiveConf.getTimeVar(ConfVars.HIVE_SERVER2_THRIFT_HTTP_WORKER_KEEPALIVE_TIME,TimeUnit.SECONDS);
    String httpPath=getHttpPath(hiveConf.getVar(HiveConf.ConfVars.HIVE_SERVER2_THRIFT_HTTP_PATH));
    httpServer=new org.eclipse.jetty.server.Server();
    String threadPoolName="HiveServer2-HttpHandler-Pool";
    ExecutorService executorService=new ThreadPoolExecutor(minWorkerThreads,maxWorkerThreads,workerKeepAliveTime,TimeUnit.SECONDS,new LinkedBlockingQueue<Runnable>(),new ThreadFactoryWithGarbageCleanup(threadPoolName));
    ExecutorThreadPool threadPool=new ExecutorThreadPool(executorService);
    httpServer.setThreadPool(threadPool);
    SelectChannelConnector connector=new SelectChannelConnector();
    ;
    boolean useSsl=hiveConf.getBoolVar(ConfVars.HIVE_SERVER2_USE_SSL);
    String schemeName=useSsl ? "https" : "http";
    String authType=hiveConf.getVar(ConfVars.HIVE_SERVER2_AUTHENTICATION);
    UserGroupInformation serviceUGI=cliService.getServiceUGI();
    UserGroupInformation httpUGI=cliService.getHttpUGI();
    if (useSsl) {
      String keyStorePath=hiveConf.getVar(ConfVars.HIVE_SERVER2_SSL_KEYSTORE_PATH).trim();
      String keyStorePassword=ShimLoader.getHadoopShims().getPassword(hiveConf,HiveConf.ConfVars.HIVE_SERVER2_SSL_KEYSTORE_PASSWORD.varname);
      if (keyStorePath.isEmpty()) {
        throw new IllegalArgumentException(ConfVars.HIVE_SERVER2_SSL_KEYSTORE_PATH.varname + " Not configured for SSL connection");
      }
      SslContextFactory sslContextFactory=new SslContextFactory();
      sslContextFactory.setKeyStorePath(keyStorePath);
      sslContextFactory.setKeyStorePassword(keyStorePassword);
      connector=new SslSelectChannelConnector(sslContextFactory);
    }
    connector.setPort(portNum);
    connector.setReuseAddress(!Shell.WINDOWS);
    int maxIdleTime=(int)hiveConf.getTimeVar(ConfVars.HIVE_SERVER2_THRIFT_HTTP_MAX_IDLE_TIME,TimeUnit.MILLISECONDS);
    connector.setMaxIdleTime(maxIdleTime);
    httpServer.addConnector(connector);
    hiveAuthFactory=new HiveAuthFactory(hiveConf);
    TProcessorFactory processorFactory=hiveAuthFactory.getAuthProcFactory(this);
    TProcessor processor=processorFactory.getProcessor(null);
    TProtocolFactory protocolFactory=new TBinaryProtocol.Factory();
    TServlet thriftHttpServlet=new ThriftHttpServlet(processor,protocolFactory,authType,serviceUGI,httpUGI);
    final ServletContextHandler context=new ServletContextHandler(ServletContextHandler.SESSIONS);
    context.setContextPath("/");
    httpServer.setHandler(context);
    context.addServlet(new ServletHolder(thriftHttpServlet),httpPath);
    httpServer.start();
    String msg="Started ThriftHttpCLIService in " + schemeName + " mode on port "+ portNum+ " path="+ httpPath+ " with "+ minWorkerThreads+ ".."+ maxWorkerThreads+ " worker threads";
    LOG.info(msg);
    httpServer.join();
  }
 catch (  Throwable t) {
    LOG.error("Error: ",t);
  }
}
