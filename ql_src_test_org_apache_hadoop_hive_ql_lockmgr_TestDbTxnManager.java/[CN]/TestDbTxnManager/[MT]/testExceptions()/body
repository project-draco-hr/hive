{
  WriteEntity we=addPartitionOutput(newTable(true),WriteEntity.WriteType.INSERT);
  QueryPlan qp=new MockQueryPlan(this);
  txnMgr.acquireLocks(qp,ctx,"PeterI");
  txnMgr.openTxn("NicholasII");
  Thread.sleep(1000);
  txnMgr.getValidTxns();
  LockException exception=null;
  try {
    txnMgr.commitTxn();
  }
 catch (  LockException ex) {
    exception=ex;
  }
  Assert.assertNotNull("Expected exception1",exception);
  Assert.assertEquals("Wrong Exception1",ErrorMsg.TXN_ABORTED,exception.getCanonicalErrorMsg());
  exception=null;
  txnMgr.openTxn("AlexanderIII");
  Thread.sleep(1000);
  txnMgr.getValidTxns();
  try {
    txnMgr.rollbackTxn();
  }
 catch (  LockException ex) {
    exception=ex;
  }
  Assert.assertNotNull("Expected exception2",exception);
  Assert.assertEquals("Wrong Exception2",ErrorMsg.TXN_NO_SUCH_TRANSACTION,exception.getCanonicalErrorMsg());
  exception=null;
  txnMgr.openTxn("PeterI");
  txnMgr.acquireLocks(qp,ctx,"PeterI");
  List<HiveLock> locks=ctx.getHiveLocks();
  Assert.assertThat("Unexpected lock count",locks.size(),is(1));
  Thread.sleep(1000);
  txnMgr.getValidTxns();
  try {
    txnMgr.heartbeat();
  }
 catch (  LockException ex) {
    exception=ex;
  }
  Assert.assertNotNull("Expected exception3",exception);
  Assert.assertEquals("Wrong Exception3",ErrorMsg.LOCK_NO_SUCH_LOCK,exception.getCanonicalErrorMsg());
}
