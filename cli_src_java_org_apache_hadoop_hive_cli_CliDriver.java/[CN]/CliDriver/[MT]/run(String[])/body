{
  OptionsProcessor oproc=new OptionsProcessor();
  if (!oproc.process_stage1(args)) {
    return 1;
  }
  boolean logInitFailed=false;
  String logInitDetailMessage;
  try {
    logInitDetailMessage=LogUtils.initHiveLog4j();
  }
 catch (  LogInitializationException e) {
    logInitFailed=true;
    logInitDetailMessage=e.getMessage();
  }
  CliSessionState ss=new CliSessionState(new HiveConf(SessionState.class));
  ss.in=System.in;
  try {
    ss.out=new PrintStream(System.out,true,"UTF-8");
    ss.info=new PrintStream(System.err,true,"UTF-8");
    ss.err=new CachingPrintStream(System.err,true,"UTF-8");
  }
 catch (  UnsupportedEncodingException e) {
    return 3;
  }
  if (!oproc.process_stage2(ss)) {
    return 2;
  }
  if (!ss.getIsSilent()) {
    if (logInitFailed) {
      System.err.println(logInitDetailMessage);
    }
 else {
      SessionState.getConsole().printInfo(logInitDetailMessage);
    }
  }
  HiveConf conf=ss.getConf();
  for (  Map.Entry<Object,Object> item : ss.cmdProperties.entrySet()) {
    conf.set((String)item.getKey(),(String)item.getValue());
    ss.getOverriddenConfigurations().put((String)item.getKey(),(String)item.getValue());
  }
  prompt=conf.getVar(HiveConf.ConfVars.CLIPROMPT);
  prompt=new VariableSubstitution().substitute(conf,prompt);
  prompt2=spacesForString(prompt);
  SessionState.start(ss);
  if (ss.getHost() != null) {
    ss.connect();
    if (ss.isRemoteMode()) {
      prompt="[" + ss.host + ':'+ ss.port+ "] "+ prompt;
      char[] spaces=new char[prompt.length()];
      Arrays.fill(spaces,' ');
      prompt2=new String(spaces);
    }
  }
  if (!ss.isRemoteMode() && !ShimLoader.getHadoopShims().usesJobShell()) {
    ClassLoader loader=conf.getClassLoader();
    String auxJars=HiveConf.getVar(conf,HiveConf.ConfVars.HIVEAUXJARS);
    if (StringUtils.isNotBlank(auxJars)) {
      loader=Utilities.addToClassPath(loader,StringUtils.split(auxJars,","));
    }
    conf.setClassLoader(loader);
    Thread.currentThread().setContextClassLoader(loader);
  }
  CliDriver cli=new CliDriver();
  cli.setHiveVariables(oproc.getHiveVariables());
  cli.processSelectDatabase(ss);
  cli.processInitFiles(ss);
  if (ss.execString != null) {
    return cli.processLine(ss.execString);
  }
  try {
    if (ss.fileName != null) {
      return cli.processFile(ss.fileName);
    }
  }
 catch (  FileNotFoundException e) {
    System.err.println("Could not open input file for reading. (" + e.getMessage() + ")");
    return 3;
  }
  ConsoleReader reader=new ConsoleReader();
  reader.setBellEnabled(false);
  for (  Completor completor : getCommandCompletor()) {
    reader.addCompletor(completor);
  }
  String line;
  final String HISTORYFILE=".hivehistory";
  String historyDirectory=System.getProperty("user.home");
  try {
    if ((new File(historyDirectory)).exists()) {
      String historyFile=historyDirectory + File.separator + HISTORYFILE;
      reader.setHistory(new History(new File(historyFile)));
    }
 else {
      System.err.println("WARNING: Directory for Hive history file: " + historyDirectory + " does not exist.   History will not be available during this session.");
    }
  }
 catch (  Exception e) {
    System.err.println("WARNING: Encountered an error while trying to initialize Hive's " + "history file.  History will not be available during this session.");
    System.err.println(e.getMessage());
  }
  int ret=0;
  String prefix="";
  String curDB=getFormattedDb(conf,ss);
  String curPrompt=prompt + curDB;
  String dbSpaces=spacesForString(curDB);
  while ((line=reader.readLine(curPrompt + "> ")) != null) {
    if (!prefix.equals("")) {
      prefix+='\n';
    }
    if (prefix.equals("") && line.startsWith("--")) {
      continue;
    }
    if (line.trim().endsWith(";") && !line.trim().endsWith("\\;")) {
      line=prefix + line;
      ret=cli.processLine(line,true);
      prefix="";
      curDB=getFormattedDb(conf,ss);
      curPrompt=prompt + curDB;
      dbSpaces=dbSpaces.length() == curDB.length() ? dbSpaces : spacesForString(curDB);
    }
 else {
      prefix=prefix + line;
      curPrompt=prompt2 + dbSpaces;
      continue;
    }
  }
  ss.close();
  return ret;
}
