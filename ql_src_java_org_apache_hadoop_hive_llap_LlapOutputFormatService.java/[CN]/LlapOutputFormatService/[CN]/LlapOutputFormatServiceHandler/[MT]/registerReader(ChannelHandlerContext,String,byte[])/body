{
  if (sm != null) {
    try {
      sm.verifyToken(tokenBytes);
    }
 catch (    SecurityException|IOException ex) {
      failChannel(ctx,id,ex.getMessage());
      return;
    }
  }
  LOG.debug("registering socket for: " + id);
  int maxPendingWrites=HiveConf.getIntVar(conf,HiveConf.ConfVars.LLAP_DAEMON_OUTPUT_SERVICE_MAX_PENDING_WRITES);
  @SuppressWarnings("rawtypes") LlapRecordWriter writer=new LlapRecordWriter(new ChannelOutputStream(ctx,id,sendBufferSize,maxPendingWrites));
  boolean isFailed=true;
synchronized (lock) {
    if (!writers.containsKey(id)) {
      isFailed=false;
      writers.put(id,writer);
      ctx.channel().closeFuture().addListener(new LlapOutputFormatChannelCloseListener(id));
      lock.notifyAll();
    }
  }
  if (isFailed) {
    failChannel(ctx,id,"Writer already registered for " + id);
  }
}
