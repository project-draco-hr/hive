{
  if (root.children != null) {
    for (int i=0; i < root.children.size(); ++i) {
      ExpressionTree child=flatten(root.children.get(i));
      if (child.operator == root.operator && child.operator != ExpressionTree.Operator.NOT) {
        boolean first=true;
        for (        ExpressionTree grandkid : child.children) {
          if (first) {
            first=false;
            root.children.set(i,grandkid);
          }
 else {
            root.children.add(++i,grandkid);
          }
        }
      }
 else {
        root.children.set(i,child);
      }
    }
    if ((root.operator == ExpressionTree.Operator.OR || root.operator == ExpressionTree.Operator.AND) && root.children.size() == 1) {
      return root.children.get(0);
    }
  }
  return root;
}
