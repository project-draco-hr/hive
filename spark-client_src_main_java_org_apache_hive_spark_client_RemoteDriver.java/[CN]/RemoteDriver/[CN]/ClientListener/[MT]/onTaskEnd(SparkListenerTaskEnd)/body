{
  if (taskEnd.reason() instanceof org.apache.spark.Success$ && !taskEnd.taskInfo().speculative()) {
    Metrics metrics=new Metrics(taskEnd.taskMetrics());
    Integer jobId;
synchronized (stageToJobId) {
      jobId=stageToJobId.get(taskEnd.stageId());
    }
    String clientId=getClientId(jobId);
    if (clientId != null) {
      protocol.sendMetrics(clientId,jobId,taskEnd.stageId(),taskEnd.taskInfo().taskId(),metrics);
    }
  }
}
