{
  setState(OperationState.PENDING);
  final HiveConf opConfig=getConfigForOperation();
  prepare(opConfig);
  if (!shouldRunAsync()) {
    runQuery(opConfig);
  }
 else {
    final SessionState parentSessionState=SessionState.get();
    final Hive parentHive=getSessionHive();
    final UserGroupInformation currentUGI=getCurrentUGI(opConfig);
    Runnable backgroundOperation=new Runnable(){
      @Override public void run(){
        PrivilegedExceptionAction<Object> doAsAction=new PrivilegedExceptionAction<Object>(){
          @Override public Object run() throws HiveSQLException {
            Hive.set(parentHive);
            SessionState.setCurrentSessionState(parentSessionState);
            registerCurrentOperationLog();
            try {
              runQuery(opConfig);
            }
 catch (            HiveSQLException e) {
              setOperationException(e);
              LOG.error("Error running hive query: ",e);
            }
 finally {
              unregisterOperationLog();
            }
            return null;
          }
        }
;
        try {
          ShimLoader.getHadoopShims().doAs(currentUGI,doAsAction);
        }
 catch (        Exception e) {
          setOperationException(new HiveSQLException(e));
          LOG.error("Error running hive query as user : " + currentUGI.getShortUserName(),e);
        }
 finally {
          if (ThreadWithGarbageCleanup.currentThread() instanceof ThreadWithGarbageCleanup) {
            ThreadWithGarbageCleanup currentThread=(ThreadWithGarbageCleanup)ThreadWithGarbageCleanup.currentThread();
            currentThread.cacheThreadLocalRawStore();
          }
        }
      }
    }
;
    try {
      Future<?> backgroundHandle=getParentSession().getSessionManager().submitBackgroundOperation(backgroundOperation);
      setBackgroundHandle(backgroundHandle);
    }
 catch (    RejectedExecutionException rejected) {
      setState(OperationState.ERROR);
      throw new HiveSQLException("The background threadpool cannot accept" + " new task for execution, please retry the operation",rejected);
    }
  }
}
