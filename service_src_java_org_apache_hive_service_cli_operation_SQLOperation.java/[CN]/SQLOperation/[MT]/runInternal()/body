{
  setState(OperationState.PENDING);
  boolean runAsync=shouldRunAsync();
  final boolean asyncPrepare=runAsync && HiveConf.getBoolVar(queryState.getConf(),HiveConf.ConfVars.HIVE_SERVER2_ASYNC_EXEC_ASYNC_COMPILE);
  if (!asyncPrepare) {
    prepare(queryState);
  }
  if (!runAsync) {
    runQuery();
  }
 else {
    Runnable work=new BackgroundWork(getCurrentUGI(),parentSession.getSessionHive(),SessionState.getPerfLogger(),SessionState.get(),asyncPrepare);
    try {
      Future<?> backgroundHandle=getParentSession().submitBackgroundOperation(work);
      setBackgroundHandle(backgroundHandle);
    }
 catch (    RejectedExecutionException rejected) {
      setState(OperationState.ERROR);
      throw new HiveSQLException("The background threadpool cannot accept" + " new task for execution, please retry the operation",rejected);
    }
  }
}
