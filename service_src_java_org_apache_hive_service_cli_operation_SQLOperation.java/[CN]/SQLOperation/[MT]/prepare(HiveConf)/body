{
  setState(OperationState.RUNNING);
  try {
    driver=new Driver(sqlOperationConf,getParentSession().getUserName());
    String guid64=Base64.encodeBase64URLSafeString(getHandle().getHandleIdentifier().toTHandleIdentifier().getGuid()).trim();
    driver.setOperationId(guid64);
    driver.setTryCount(Integer.MAX_VALUE);
    String subStatement=new VariableSubstitution(new HiveVariableSource(){
      @Override public Map<String,String> getHiveVariable(){
        return SessionState.get().getHiveVariables();
      }
    }
).substitute(sqlOperationConf,statement);
    response=driver.compileAndRespond(subStatement);
    if (0 != response.getResponseCode()) {
      throw toSQLException("Error while compiling statement",response);
    }
    mResultSchema=driver.getSchema();
    if (driver.getPlan().getFetchTask() != null) {
      if (mResultSchema == null || !mResultSchema.isSetFieldSchemas()) {
        throw new HiveSQLException("Error compiling query: Schema and FieldSchema " + "should be set when query plan has a FetchTask");
      }
      resultSchema=new TableSchema(mResultSchema);
      setHasResultSet(true);
    }
 else {
      setHasResultSet(false);
    }
    for (    Task<? extends Serializable> task : driver.getPlan().getRootTasks()) {
      if (task.getClass() == ExplainTask.class) {
        resultSchema=new TableSchema(mResultSchema);
        setHasResultSet(true);
        break;
      }
    }
  }
 catch (  HiveSQLException e) {
    setState(OperationState.ERROR);
    throw e;
  }
catch (  Exception e) {
    setState(OperationState.ERROR);
    throw new HiveSQLException("Error running query: " + e.toString(),e);
  }
}
