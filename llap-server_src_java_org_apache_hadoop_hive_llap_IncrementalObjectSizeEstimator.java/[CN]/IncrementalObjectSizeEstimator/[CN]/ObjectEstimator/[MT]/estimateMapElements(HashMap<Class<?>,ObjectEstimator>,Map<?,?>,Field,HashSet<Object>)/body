{
  ObjectEstimator keyEstimator=null, valueEstimator=null;
  Class<?> lastKeyClass=null, lastValueClass=null;
  int result=0;
  for (  Map.Entry<?,?> element : m.entrySet()) {
    Object key=element.getKey(), value=element.getValue();
    if (!uniqueObjects.add(key))     continue;
    Class<?> keyClass=key.getClass();
    if (lastKeyClass != keyClass) {
      lastKeyClass=keyClass;
      keyEstimator=parent.get(lastKeyClass);
      if (keyEstimator == null) {
        throw new AssertionError("Don't know how to measure key " + lastKeyClass.getName() + " from "+ field);
      }
    }
    result+=keyEstimator.estimate(element,parent,uniqueObjects);
    if (value == null)     continue;
    if (!uniqueObjects.add(value))     continue;
    Class<?> valueClass=value.getClass();
    if (lastValueClass != valueClass) {
      lastValueClass=valueClass;
      valueEstimator=parent.get(lastValueClass);
      if (valueEstimator == null) {
        throw new AssertionError("Don't know how to measure value " + lastValueClass.getName() + " from "+ field);
      }
    }
    result+=valueEstimator.estimate(element,parent,uniqueObjects);
  }
  return result;
}
