{
  DN dn=new DN("dc=example, dc=com");
  config=new InMemoryDirectoryServerConfig(dn);
  config.setSchema(null);
  config.addAdditionalBindCredentials("cn=user1,ou=People,dc=example,dc=com","user1");
  config.addAdditionalBindCredentials("cn=user2,ou=People,dc=example,dc=com","user2");
  config.setListenerConfigs(new InMemoryListenerConfig("myListener",null,serverPort,null,null,null));
  server=new InMemoryDirectoryServer(config);
  server.startListening();
  File ldifFile=new File(Thread.currentThread().getContextClassLoader().getResource("org/apache/hive/service/auth/ldapdata.ldif").getFile());
  LDIFReader ldifReader=new LDIFReader(ldifFile);
  server.importFromLDIF(true,ldifReader);
  LDAPConnection conn=server.getConnection();
  int port=server.getListenPort();
  ldapUrl=new String("ldap://localhost:" + port);
  hiveConf=new HiveConf();
  ByteArrayOutputStream baos=new ByteArrayOutputStream();
  hiveConf.writeXml(baos);
  baos.close();
  hiveConfBackup=baos.toByteArray();
  hiveConf.set("hive.root.logger","TRACE,console");
  hiveConf.set("hive.server2.authentication.ldap.url",ldapUrl);
  hiveConf.set("hive.server2.authentication.ldap.baseDN","dc=example,dc=com");
  hiveConf.set("hive.server2.authentication.ldap.userDNPattern","cn=%s,ou=People,dc=example,dc=com");
  FileOutputStream fos=new FileOutputStream(new File(hiveConf.getHiveSiteLocation().toURI()));
  hiveConf.writeXml(fos);
  fos.close();
  ldapProvider=new LdapAuthenticationProviderImpl();
}
