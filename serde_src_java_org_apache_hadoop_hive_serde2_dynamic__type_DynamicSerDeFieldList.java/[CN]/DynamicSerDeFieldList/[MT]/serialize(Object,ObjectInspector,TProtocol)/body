{
  assert(oi instanceof StructObjectInspector);
  StructObjectInspector soi=(StructObjectInspector)oi;
  boolean writeNulls=oprot instanceof org.apache.hadoop.hive.serde2.thrift.WriteNullsProtocol;
  List<? extends StructField> fields=soi.getAllStructFieldRefs();
  if (fields.size() != ordered_types.length) {
    throw new SerDeException("Trying to serialize " + fields.size() + " fields into a struct with "+ ordered_types.length+ " object="+ o+ " objectinspector="+ oi.getTypeName());
  }
  for (int i=0; i < fields.size(); i++) {
    Object f=soi.getStructFieldData(o,fields.get(i));
    DynamicSerDeTypeBase mt=ordered_types[i];
    if (f == null && !writeNulls) {
      continue;
    }
    if (thrift_mode) {
      field.name=mt.name;
      field.type=mt.getType();
      field.id=(short)mt.fieldid;
      oprot.writeFieldBegin(field);
    }
    if (f == null) {
      ((org.apache.hadoop.hive.serde2.thrift.WriteNullsProtocol)oprot).writeNull();
    }
 else {
      mt.serialize(f,fields.get(i).getFieldObjectInspector(),oprot);
    }
    if (thrift_mode) {
      oprot.writeFieldEnd();
    }
  }
  if (thrift_mode) {
    oprot.writeFieldStop();
  }
}
