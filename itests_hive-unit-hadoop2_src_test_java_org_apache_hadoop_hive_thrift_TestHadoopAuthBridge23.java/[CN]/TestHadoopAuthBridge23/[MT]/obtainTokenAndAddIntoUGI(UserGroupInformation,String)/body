{
  String tokenStrForm=getDelegationTokenStr(clientUgi,clientUgi);
  Token<DelegationTokenIdentifier> t=new Token<DelegationTokenIdentifier>();
  t.decodeFromUrlString(tokenStrForm);
  DelegationTokenIdentifier d=new DelegationTokenIdentifier();
  d.readFields(new DataInputStream(new ByteArrayInputStream(t.getIdentifier())));
  Assert.assertTrue("Usernames don't match",clientUgi.getShortUserName().equals(d.getUser().getShortUserName()));
  if (tokenSig != null) {
    conf.setVar(HiveConf.ConfVars.METASTORE_TOKEN_SIGNATURE,tokenSig);
    t.setService(new Text(tokenSig));
  }
  clientUgi.addToken(t);
  HiveMetaStoreClient hiveClient=clientUgi.doAs(new PrivilegedExceptionAction<HiveMetaStoreClient>(){
    public HiveMetaStoreClient run() throws Exception {
      HiveMetaStoreClient hiveClient=new HiveMetaStoreClient(conf);
      return hiveClient;
    }
  }
);
  Assert.assertTrue("Couldn't connect to metastore",hiveClient != null);
  createDBAndVerifyExistence(hiveClient);
  hiveClient.close();
  HiveMetaStore.cancelDelegationToken(tokenStrForm);
  hiveClient=clientUgi.doAs(new PrivilegedExceptionAction<HiveMetaStoreClient>(){
    public HiveMetaStoreClient run(){
      try {
        return new HiveMetaStoreClient(conf);
      }
 catch (      MetaException e) {
        return null;
      }
    }
  }
);
  Assert.assertTrue("Expected metastore operations to fail",hiveClient == null);
}
