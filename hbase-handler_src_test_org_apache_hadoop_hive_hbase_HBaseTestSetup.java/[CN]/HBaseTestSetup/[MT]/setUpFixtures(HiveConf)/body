{
  int zkPort=conf.getInt("hive.zookeeper.client.port",-1);
  if ((zkPort == zooKeeperPort) && (hbaseCluster != null)) {
    return;
  }
  zooKeeperPort=zkPort;
  String tmpdir=System.getProperty("user.dir") + "/../build/ql/tmp";
  this.tearDown();
  conf.set("hbase.master","local");
  hbaseRoot="file:///" + tmpdir + "/hbase";
  conf.set("hbase.rootdir",hbaseRoot);
  conf.set("hbase.zookeeper.property.clientPort",Integer.toString(zooKeeperPort));
  Configuration hbaseConf=HBaseConfiguration.create(conf);
  hbaseConf.setInt("hbase.master.port",findFreePort());
  hbaseConf.setInt("hbase.master.info.port",-1);
  hbaseConf.setInt("hbase.regionserver.port",findFreePort());
  hbaseConf.setInt("hbase.regionserver.info.port",-1);
  hbaseCluster=new MiniHBaseCluster(hbaseConf,NUM_REGIONSERVERS);
  conf.set("hbase.master",hbaseCluster.getMaster().getServerName().getHostAndPort());
  new HTable(hbaseConf,HConstants.META_TABLE_NAME);
  createHBaseTable(hbaseConf);
}
