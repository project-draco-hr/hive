{
  Table t=newTable("default","bblp",true);
  Partition p=newPartition(t,"today");
  HiveConf conf=new HiveConf();
  addBaseFile(conf,t,p,20L,20);
  addDeltaFile(conf,t,p,21L,22L,2);
  addDeltaFile(conf,t,p,23L,24L,2);
  addDeltaFile(conf,t,p,21L,24L,4);
  burnThroughTransactions(25);
  CompactionRequest rqst=new CompactionRequest("default","bblp",CompactionType.MINOR);
  rqst.setPartitionname("ds=today");
  txnHandler.compact(rqst);
  CompactionInfo ci=txnHandler.findNextToCompact("fred");
  txnHandler.markCompacted(ci);
  txnHandler.setRunAs(ci.id,System.getProperty("user.name"));
  LockComponent comp=new LockComponent(LockType.SHARED_WRITE,LockLevel.TABLE,"default");
  comp.setTablename("bblp");
  comp.setPartitionname("ds=today");
  List<LockComponent> components=new ArrayList<LockComponent>(1);
  components.add(comp);
  LockRequest req=new LockRequest(components,"me","localhost");
  LockResponse res=txnHandler.lock(req);
  startCleaner(conf);
  ShowCompactResponse rsp=txnHandler.showCompact(new ShowCompactRequest());
  List<ShowCompactResponseElement> compacts=rsp.getCompacts();
  Assert.assertEquals(1,compacts.size());
  Assert.assertEquals("ready for cleaning",compacts.get(0).getState());
  Assert.assertEquals("bblp",compacts.get(0).getTablename());
  Assert.assertEquals("ds=today",compacts.get(0).getPartitionname());
  Assert.assertEquals(CompactionType.MINOR,compacts.get(0).getType());
}
