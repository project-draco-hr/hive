{
  conf.setVar(HiveConf.ConfVars.HIVE_SERVER2_PLAIN_LDAP_USERDNPATTERN,"cn=%s,ou=Users,dc=mycorp,dc=com:cn=%s,ou=PowerUsers,dc=mycorp,dc=com");
  DirSearchFactory factory=mock(DirSearchFactory.class);
  when(search.findUserDn("user1")).thenReturn("cn=user1,ou=PowerUsers,dc=mycorp,dc=com");
  when(factory.getInstance(conf,"cn=user1,ou=PowerUsers,dc=mycorp,dc=com","Blah")).thenReturn(search);
  when(factory.getInstance(conf,"cn=user1,ou=Users,dc=mycorp,dc=com","Blah")).thenThrow(AuthenticationException.class);
  auth=new LdapAuthenticationProviderImpl(conf,factory);
  auth.Authenticate("user1","Blah");
  verify(factory,times(2)).getInstance(isA(HiveConf.class),anyString(),eq("Blah"));
  verify(search,atLeastOnce()).close();
}
