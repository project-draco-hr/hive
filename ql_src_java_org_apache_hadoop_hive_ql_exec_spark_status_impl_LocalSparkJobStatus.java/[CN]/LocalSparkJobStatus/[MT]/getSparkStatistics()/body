{
  SparkStatisticsBuilder sparkStatisticsBuilder=new SparkStatisticsBuilder();
  sparkStatisticsBuilder.add(sparkCounters);
  String jobIdentifier="Spark Job[" + jobId + "] Metrics";
  Map<String,List<TaskMetrics>> jobMetric=jobMetricsListener.getJobMetric(jobId);
  if (jobMetric == null) {
    return null;
  }
  MetricsCollection metricsCollection=new MetricsCollection();
  Set<String> stageIds=jobMetric.keySet();
  for (  String stageId : stageIds) {
    List<TaskMetrics> taskMetrics=jobMetric.get(stageId);
    for (    TaskMetrics taskMetric : taskMetrics) {
      Metrics metrics=new Metrics(taskMetric);
      metricsCollection.addMetrics(jobId,Integer.parseInt(stageId),0,metrics);
    }
  }
  SparkJobUtils sparkJobUtils=new SparkJobUtils();
  Map<String,Long> flatJobMetric=sparkJobUtils.collectMetrics(metricsCollection.getAllMetrics());
  for (  Map.Entry<String,Long> entry : flatJobMetric.entrySet()) {
    sparkStatisticsBuilder.add(jobIdentifier,entry.getKey(),Long.toString(entry.getValue()));
  }
  return sparkStatisticsBuilder.build();
}
