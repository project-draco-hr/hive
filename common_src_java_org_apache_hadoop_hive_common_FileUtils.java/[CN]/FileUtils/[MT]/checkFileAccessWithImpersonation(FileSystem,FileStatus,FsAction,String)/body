{
  UserGroupInformation ugi=ShimLoader.getHadoopShims().getUGIForConf(fs.getConf());
  String currentUser=ShimLoader.getHadoopShims().getShortUserName(ugi);
  if (user == null || currentUser.equals(user)) {
    ShimLoader.getHadoopShims().checkFileAccess(fs,stat,action);
    return;
  }
  UserGroupInformation proxyUser=ShimLoader.getHadoopShims().createProxyUser(user);
  ShimLoader.getHadoopShims().doAs(proxyUser,new PrivilegedExceptionAction<Object>(){
    @Override public Object run() throws Exception {
      FileSystem fsAsUser=FileSystem.get(fs.getUri(),fs.getConf());
      ShimLoader.getHadoopShims().checkFileAccess(fsAsUser,stat,action);
      return null;
    }
  }
);
}
