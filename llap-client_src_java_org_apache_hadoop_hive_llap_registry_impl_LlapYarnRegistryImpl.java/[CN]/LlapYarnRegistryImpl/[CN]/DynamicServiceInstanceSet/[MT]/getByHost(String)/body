{
  readLock.lock();
  Set<ServiceInstance> byHost=new HashSet<ServiceInstance>();
  try {
    for (    ServiceInstance i : instances.values()) {
      if (host.equals(i.getHost())) {
        byHost.add(i);
      }
      if (LOG.isDebugEnabled()) {
        LOG.debug("Locality comparing " + host + " to "+ i.getHost());
      }
    }
    if (LOG.isDebugEnabled()) {
      LOG.debug("Returning " + byHost.size() + " hosts for locality allocation on "+ host);
    }
    return byHost;
  }
  finally {
    readLock.unlock();
  }
}
