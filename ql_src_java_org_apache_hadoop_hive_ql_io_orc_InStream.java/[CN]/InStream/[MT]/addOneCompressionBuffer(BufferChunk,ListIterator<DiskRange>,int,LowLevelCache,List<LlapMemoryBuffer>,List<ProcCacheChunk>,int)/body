{
  ByteBuffer slice=null;
  ByteBuffer compressed=current.chunk;
  if (nextCbOffsetExpected >= 0 && nextCbOffsetExpected != compressed.position()) {
    throw new AssertionError("We don't know what we are doing anymore");
  }
  long cbStartOffset=current.offset + compressed.position();
  int b0=compressed.get() & 0xff;
  int b1=compressed.get() & 0xff;
  int b2=compressed.get() & 0xff;
  int chunkLength=(b2 << 15) | (b1 << 7) | (b0 >> 1);
  if (chunkLength > bufferSize) {
    throw new IllegalArgumentException("Buffer size too small. size = " + bufferSize + " needed = "+ chunkLength);
  }
  boolean isUncompressed=((b0 & 0x01) == 1);
  if (compressed.remaining() >= chunkLength) {
    slice=compressed.slice();
    slice.limit(chunkLength);
    addOneCompressionBlockByteBuffer(slice,isUncompressed,ranges,cache,compressed,cbStartOffset,chunkLength,toDecompress,cacheBuffers);
    return chunkLength;
  }
  ByteBuffer copy=allocateBuffer(chunkLength,compressed.isDirect());
  int remaining=chunkLength - compressed.remaining();
  copy.put(compressed);
  ranges.remove();
  while (ranges.hasNext()) {
    DiskRange range=ranges.next();
    if (!(range instanceof BufferChunk)) {
      throw new IOException("Trying to extend compressed block into uncompressed block");
    }
    compressed=range.getData();
    if (compressed.remaining() >= remaining) {
      slice=compressed.slice();
      slice.limit(remaining);
      copy.put(slice);
      addOneCompressionBlockByteBuffer(copy,isUncompressed,ranges,cache,compressed,cbStartOffset,chunkLength,toDecompress,cacheBuffers);
      return chunkLength;
    }
    remaining-=compressed.remaining();
    copy.put(compressed);
    ranges.remove();
  }
  throw new IOException("EOF in while trying to read " + chunkLength + " bytes at "+ cbStartOffset);
}
