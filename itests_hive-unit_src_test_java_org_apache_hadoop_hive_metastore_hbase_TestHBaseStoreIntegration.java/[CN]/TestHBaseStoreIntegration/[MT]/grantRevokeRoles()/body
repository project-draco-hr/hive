{
  int now=(int)(System.currentTimeMillis() / 1000);
  String roleName1="role1";
  store.addRole(roleName1,"me");
  String roleName2="role2";
  store.addRole(roleName2,"me");
  Role role1=store.getRole(roleName1);
  Role role2=store.getRole(roleName2);
  store.grantRole(role1,"fred",PrincipalType.USER,"bob",PrincipalType.USER,false);
  store.grantRole(role2,roleName1,PrincipalType.ROLE,"admin",PrincipalType.ROLE,true);
  store.grantRole(role2,"fred",PrincipalType.USER,"admin",PrincipalType.ROLE,false);
  List<Role> roles=store.listRoles("fred",PrincipalType.USER);
  Assert.assertEquals(3,roles.size());
  boolean sawRole1=false, sawRole2=false, sawPublic=false;
  for (  Role role : roles) {
    if (role.getRoleName().equals(roleName1)) {
      sawRole1=true;
    }
 else     if (role.getRoleName().equals(roleName2)) {
      sawRole2=true;
    }
 else     if (role.getRoleName().equals(HiveMetaStore.PUBLIC)) {
      sawPublic=true;
    }
 else {
      Assert.fail("Unknown role name " + role.getRoleName());
    }
  }
  Assert.assertTrue(sawRole1 && sawRole2 && sawPublic);
  roles=store.listRoles("fred",PrincipalType.ROLE);
  Assert.assertEquals(0,roles.size());
  roles=store.listRoles(roleName1,PrincipalType.ROLE);
  Assert.assertEquals(1,roles.size());
  Role role=roles.get(0);
  Assert.assertEquals(roleName2,role.getRoleName());
  List<RolePrincipalGrant> grants=store.listRoleMembers(roleName1);
  Assert.assertEquals(1,grants.size());
  Assert.assertEquals("fred",grants.get(0).getPrincipalName());
  Assert.assertEquals(PrincipalType.USER,grants.get(0).getPrincipalType());
  Assert.assertTrue("Expected grant time of " + now + " got "+ grants.get(0).getGrantTime(),grants.get(0).getGrantTime() >= now);
  Assert.assertEquals("bob",grants.get(0).getGrantorName());
  Assert.assertEquals(PrincipalType.USER,grants.get(0).getGrantorPrincipalType());
  Assert.assertFalse(grants.get(0).isGrantOption());
  grants=store.listRoleMembers(roleName2);
  Assert.assertEquals(2,grants.size());
  boolean sawFred=false;
  sawRole1=false;
  for (  RolePrincipalGrant m : grants) {
    if ("fred".equals(m.getPrincipalName()))     sawFred=true;
 else     if (roleName1.equals(m.getPrincipalName()))     sawRole1=true;
 else     Assert.fail("Unexpected principal " + m.getPrincipalName());
  }
  Assert.assertTrue(sawFred && sawRole1);
  store.revokeRole(role2,roleName1,PrincipalType.ROLE,true);
  roles=store.listRoles(roleName1,PrincipalType.ROLE);
  Assert.assertEquals(1,roles.size());
  Assert.assertEquals(roleName2,roles.get(0).getRoleName());
  grants=store.listRoleMembers(roleName1);
  Assert.assertFalse(grants.get(0).isGrantOption());
  store.removeRole(roleName1);
  roles=store.listRoles("fred",PrincipalType.USER);
  Assert.assertEquals(2,roles.size());
  sawRole2=sawPublic=false;
  for (  Role m : roles) {
    if (m.getRoleName().equals(roleName2))     sawRole2=true;
 else     if (m.getRoleName().equals(HiveMetaStore.PUBLIC))     sawPublic=true;
 else     Assert.fail("Unknown role " + m.getRoleName());
  }
  Assert.assertTrue(sawRole2 && sawPublic);
  roles=store.listRoles(roleName1,PrincipalType.ROLE);
  Assert.assertEquals(0,roles.size());
  store.revokeRole(role2,"fred",PrincipalType.USER,false);
  roles=store.listRoles("fred",PrincipalType.USER);
  Assert.assertEquals(1,roles.size());
  Assert.assertEquals(HiveMetaStore.PUBLIC,roles.get(0).getRoleName());
}
