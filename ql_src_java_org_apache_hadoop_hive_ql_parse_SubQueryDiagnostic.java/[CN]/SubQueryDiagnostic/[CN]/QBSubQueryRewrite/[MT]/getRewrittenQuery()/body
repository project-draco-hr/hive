{
  ASTNode sqAST=subQuery.getSubQueryAST();
  if (whereClause != null) {
    ASTNode whereAST=(ASTNode)sqAST.getChild(1).getChild(2);
    stream.replace(subQuery.getAlias(),whereAST.getTokenStartIndex(),whereAST.getTokenStopIndex(),whereClause);
  }
  if (selectClauseAdditions != null) {
    ASTNode selectClause=(ASTNode)sqAST.getChild(1).getChild(1);
    stream.insertAfter(subQuery.getAlias(),selectClause.getTokenStopIndex(),selectClauseAdditions);
  }
  if (gByClauseAdditions != null) {
    if (!addGroupByClause) {
      ASTNode groupBy=(ASTNode)sqAST.getChild(1).getChild(3);
      stream.insertAfter(subQuery.getAlias(),groupBy.getTokenStopIndex(),gByClauseAdditions);
    }
 else {
      gByClauseAdditions=" group by " + gByClauseAdditions;
      stream.insertAfter(subQuery.getAlias(),sqAST.getTokenStopIndex() - 1,gByClauseAdditions);
    }
  }
  try {
    return stream.toString(subQuery.getAlias(),sqAST.getTokenStartIndex(),sqAST.getTokenStopIndex()) + " " + subQuery.getAlias();
  }
  finally {
    stream.deleteProgram(subQuery.getAlias());
  }
}
