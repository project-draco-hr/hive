{
  if (myagg.nusedbins <= myagg.nbins) {
    return;
  }
  StdAgg.Coord[] histogram=myagg.hist;
  while (myagg.nusedbins > myagg.nbins) {
    double smallestdiff=histogram[1].x - histogram[0].x;
    int smallestdiffloc=0, smallestdiffcount=1;
    for (int i=1; i < myagg.nusedbins - 1; i++) {
      double diff=histogram[i + 1].x - histogram[i].x;
      if (diff < smallestdiff) {
        smallestdiff=diff;
        smallestdiffloc=i;
        smallestdiffcount=1;
      }
 else {
        if (diff == smallestdiff && prng.nextDouble() <= (1.0 / ++smallestdiffcount)) {
          smallestdiffloc=i;
        }
      }
    }
    double d=histogram[smallestdiffloc].y + histogram[smallestdiffloc + 1].y;
    histogram[smallestdiffloc].x*=histogram[smallestdiffloc].y / d;
    histogram[smallestdiffloc].x+=histogram[smallestdiffloc + 1].x / d * histogram[smallestdiffloc + 1].y;
    histogram[smallestdiffloc].y=d;
    for (int i=smallestdiffloc + 1; i < myagg.nusedbins - 1; i++) {
      histogram[i].x=histogram[i + 1].x;
      histogram[i].y=histogram[i + 1].y;
    }
    myagg.nusedbins--;
  }
}
