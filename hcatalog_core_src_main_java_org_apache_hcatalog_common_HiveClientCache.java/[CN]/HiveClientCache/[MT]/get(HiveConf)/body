{
  final HiveClientCacheKey cacheKey=HiveClientCacheKey.fromHiveConf(hiveConf,getThreadId());
  CacheableHiveMetaStoreClient hiveMetaStoreClient=null;
synchronized (CACHE_TEARDOWN_LOCK) {
    hiveMetaStoreClient=getOrCreate(cacheKey);
    hiveMetaStoreClient.acquire();
  }
  if (!hiveMetaStoreClient.isOpen()) {
synchronized (CACHE_TEARDOWN_LOCK) {
      hiveCache.invalidate(cacheKey);
      hiveMetaStoreClient.close();
      hiveMetaStoreClient=getOrCreate(cacheKey);
      hiveMetaStoreClient.acquire();
    }
  }
  return hiveMetaStoreClient;
}
