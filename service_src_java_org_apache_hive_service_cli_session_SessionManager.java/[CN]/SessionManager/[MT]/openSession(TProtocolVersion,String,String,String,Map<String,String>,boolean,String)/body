{
  HiveSession session;
  if (withImpersonation) {
    HiveSessionImplwithUGI sessionWithUGI=new HiveSessionImplwithUGI(protocol,username,password,hiveConf,ipAddress,delegationToken);
    session=HiveSessionProxy.getProxy(sessionWithUGI,sessionWithUGI.getSessionUgi());
    sessionWithUGI.setProxySession(session);
  }
 else {
    session=new HiveSessionImpl(protocol,username,password,hiveConf,ipAddress);
  }
  session.setSessionManager(this);
  session.setOperationManager(operationManager);
  try {
    session.open(sessionConf);
  }
 catch (  Exception e) {
    throw new HiveSQLException("Failed to open new session: " + e,e);
  }
  if (isOperationLogEnabled) {
    session.setOperationLogSessionDir(operationLogRootDir);
  }
  try {
    executeSessionHooks(session);
  }
 catch (  Exception e) {
    throw new HiveSQLException("Failed to execute session hooks",e);
  }
  handleToSession.put(session.getSessionHandle(),session);
  return session.getSessionHandle();
}
