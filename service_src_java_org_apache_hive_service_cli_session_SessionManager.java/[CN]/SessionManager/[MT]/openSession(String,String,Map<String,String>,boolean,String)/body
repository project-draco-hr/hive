{
  HiveSession session;
  if (username == null) {
    username=threadLocalUserName.get();
  }
  if (withImpersonation) {
    HiveSessionImplwithUGI hiveSessionUgi=new HiveSessionImplwithUGI(username,password,sessionConf,delegationToken);
    session=(HiveSession)HiveSessionProxy.getProxy(hiveSessionUgi,hiveSessionUgi.getSessionUgi());
    hiveSessionUgi.setProxySession(session);
  }
 else {
    session=new HiveSessionImpl(username,password,sessionConf);
  }
  session.setSessionManager(this);
  session.setOperationManager(operationManager);
synchronized (sessionMapLock) {
    handleToSession.put(session.getSessionHandle(),session);
  }
  return session.getSessionHandle();
}
