{
  hiveConf.setIntVar(HiveConf.ConfVars.HIVE_MAX_OPEN_TXNS,3);
  hiveConf.setTimeVar(HiveConf.ConfVars.HIVE_COUNT_OPEN_TXNS_INTERVAL,10,TimeUnit.MILLISECONDS);
  TxnStore txnHandler=TxnUtils.getTxnStore(hiveConf);
  OpenTxnsResponse openTxnsResponse=txnHandler.openTxns(new OpenTxnRequest(3,"me","localhost"));
  AcidOpenTxnsCounterService openTxnsCounterService=new AcidOpenTxnsCounterService();
  runHouseKeeperService(openTxnsCounterService,hiveConf);
  MetaException exception=null;
  try {
    txnHandler.openTxns(new OpenTxnRequest(1,"you","localhost"));
  }
 catch (  MetaException e) {
    exception=e;
  }
  Assert.assertNotNull("Opening new transaction shouldn't be allowed",exception);
  Assert.assertTrue(exception.getMessage().equals("Maximum allowed number of open transactions has been reached. See hive.max.open.txns."));
  for (  long txnid : openTxnsResponse.getTxn_ids()) {
    txnHandler.commitTxn(new CommitTxnRequest(txnid));
  }
  runHouseKeeperService(openTxnsCounterService,hiveConf);
  exception=null;
  try {
    txnHandler.openTxns(new OpenTxnRequest(1,"him","localhost"));
  }
 catch (  MetaException e) {
    exception=e;
  }
  Assert.assertNull(exception);
}
