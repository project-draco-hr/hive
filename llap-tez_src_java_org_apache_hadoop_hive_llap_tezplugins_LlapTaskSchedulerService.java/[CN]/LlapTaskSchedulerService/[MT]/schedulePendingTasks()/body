{
  writeLock.lock();
  try {
    Iterator<Entry<Priority,List<TaskInfo>>> pendingIterator=pendingTasks.entrySet().iterator();
    while (pendingIterator.hasNext()) {
      Entry<Priority,List<TaskInfo>> entry=pendingIterator.next();
      List<TaskInfo> taskListAtPriority=entry.getValue();
      Iterator<TaskInfo> taskIter=taskListAtPriority.iterator();
      boolean scheduledAllAtPriority=true;
      while (taskIter.hasNext()) {
        TaskInfo taskInfo=taskIter.next();
        if (taskInfo.getNumPreviousAssignAttempts() == 1) {
          dagStats.registerDelayedAllocation();
        }
        taskInfo.triedAssigningTask();
        ScheduleResult scheduleResult=scheduleTask(taskInfo);
        if (LOG.isDebugEnabled()) {
          LOG.debug("ScheduleResult for Task: {} = {}",taskInfo,scheduleResult);
        }
        if (scheduleResult == ScheduleResult.SCHEDULED) {
          taskIter.remove();
        }
 else {
          if (scheduleResult == ScheduleResult.INADEQUATE_TOTAL_RESOURCES) {
            LOG.info("Inadequate total resources before scheduling pending tasks." + " Signalling scheduler timeout monitor thread to start timer.");
            startTimeoutMonitor();
          }
          String[] potentialHosts;
          if (scheduleResult == ScheduleResult.DELAYED_LOCALITY) {
            maybeAddToDelayedTaskQueue(taskInfo);
            potentialHosts=taskInfo.requestedHosts;
            if (potentialHosts == null || potentialHosts.length == 0) {
              potentialHosts=null;
            }
          }
 else {
            potentialHosts=null;
          }
          if (potentialHosts != null) {
            boolean shouldPreempt=true;
            for (            String host : potentialHosts) {
              MutableInt pendingHostPreemptions=pendingPreemptionsPerHost.get(host);
              if (pendingHostPreemptions != null && pendingHostPreemptions.intValue() > 0) {
                shouldPreempt=false;
                break;
              }
            }
            if (shouldPreempt) {
              LOG.info("Attempting to preempt for {}, pendingPreemptions={} on hosts={}",taskInfo.task,pendingPreemptions.get(),Arrays.toString(potentialHosts));
              preemptTasks(entry.getKey().getPriority(),1,potentialHosts);
            }
          }
 else {
            if (pendingPreemptions.get() == 0) {
              LOG.info("Attempting to preempt for {}, pendingPreemptions={} on any host",taskInfo.task,pendingPreemptions.get());
              preemptTasks(entry.getKey().getPriority(),1,null);
            }
          }
          scheduledAllAtPriority=false;
          if (scheduleResult != ScheduleResult.DELAYED_LOCALITY) {
            break;
          }
        }
      }
      if (taskListAtPriority.isEmpty()) {
        pendingIterator.remove();
      }
      if (!scheduledAllAtPriority) {
        break;
      }
    }
  }
  finally {
    writeLock.unlock();
  }
}
