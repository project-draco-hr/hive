{
  if (getTemplatePath().equals("")) {
    throw new BuildException("No templatePath attribute specified");
  }
  if (template == null) {
    throw new BuildException("No template attribute specified");
  }
  if (outputDirectory == null) {
    throw new BuildException("No outputDirectory specified");
  }
  if (queryDirectory == null && queryFile == null) {
    throw new BuildException("No queryDirectory or queryFile specified");
  }
  if (logDirectory == null) {
    throw new BuildException("No logDirectory specified");
  }
  if (resultsDirectory == null) {
    throw new BuildException("No resultsDirectory specified");
  }
  if (className == null) {
    throw new BuildException("No className specified");
  }
  Set<String> includeOnly=null;
  if (includeQueryFile != null && !includeQueryFile.isEmpty()) {
    includeOnly=new HashSet<String>(Arrays.asList(includeQueryFile.split(",")));
  }
  List<File> qFiles=new ArrayList<File>();
  HashMap<String,String> qFilesMap=new HashMap<String,String>();
  File hiveRootDir=null;
  File queryDir=null;
  File outDir=null;
  File resultsDir=null;
  File logDir=null;
  try {
    if (queryDirectory != null) {
      queryDir=new File(queryDirectory);
    }
    if (queryFile != null && !queryFile.equals("")) {
      for (      String qFile : queryFile.split(",")) {
        if (includeOnly != null && !includeOnly.contains(qFile)) {
          continue;
        }
        if (null != queryDir) {
          qFiles.add(new File(queryDir,qFile));
        }
 else {
          qFiles.add(new File(qFile));
        }
      }
    }
 else     if (queryFileRegex != null && !queryFileRegex.equals("")) {
      qFiles.addAll(Arrays.asList(queryDir.listFiles(new QFileRegexFilter(queryFileRegex,includeOnly))));
    }
 else     if (runDisabled != null && runDisabled.equals("true")) {
      qFiles.addAll(Arrays.asList(queryDir.listFiles(new DisabledQFileFilter(includeOnly))));
    }
 else {
      qFiles.addAll(Arrays.asList(queryDir.listFiles(new QFileFilter(includeOnly))));
    }
    if (excludeQueryFile != null && !excludeQueryFile.equals("")) {
      for (      String qFile : excludeQueryFile.split(",")) {
        if (null != queryDir) {
          qFiles.remove(new File(queryDir,qFile));
        }
 else {
          qFiles.remove(new File(qFile));
        }
      }
    }
    hiveRootDir=new File(hiveRootDirectory);
    if (!hiveRootDir.exists()) {
      throw new BuildException("Hive Root Directory " + hiveRootDir.getCanonicalPath() + " does not exist");
    }
    Collections.sort(qFiles);
    for (    File qFile : qFiles) {
      qFilesMap.put(qFile.getName(),relativePath(hiveRootDir,qFile));
    }
    outDir=new File(outputDirectory);
    if (!outDir.exists()) {
      outDir.mkdirs();
    }
    logDir=new File(logDirectory);
    if (!logDir.exists()) {
      throw new BuildException("Log Directory " + logDir.getCanonicalPath() + " does not exist");
    }
    resultsDir=new File(resultsDirectory);
    if (!resultsDir.exists()) {
      throw new BuildException("Results Directory " + resultsDir.getCanonicalPath() + " does not exist");
    }
  }
 catch (  Exception e) {
    throw new BuildException(e);
  }
  VelocityEngine ve=new VelocityEngine();
  try {
    ve.setProperty(RuntimeConstants.FILE_RESOURCE_LOADER_PATH,getTemplatePath());
    if (logFile != null) {
      File lf=new File(logFile);
      if (lf.exists()) {
        if (!lf.delete()) {
          throw new Exception("Could not delete log file " + lf.getCanonicalPath());
        }
      }
      ve.setProperty(RuntimeConstants.RUNTIME_LOG,logFile);
    }
    ve.init();
    Template t=ve.getTemplate(template);
    if (clusterMode == null) {
      clusterMode=new String("");
    }
    if (hadoopVersion == null) {
      hadoopVersion="";
    }
    VelocityContext ctx=new VelocityContext();
    ctx.put("className",className);
    ctx.put("hiveRootDir",escapePath(hiveRootDir.getCanonicalPath()));
    ctx.put("queryDir",relativePath(hiveRootDir,queryDir));
    ctx.put("qfiles",qFiles);
    ctx.put("qfilesMap",qFilesMap);
    ctx.put("resultsDir",relativePath(hiveRootDir,resultsDir));
    ctx.put("logDir",relativePath(hiveRootDir,logDir));
    ctx.put("clusterMode",clusterMode);
    ctx.put("hadoopVersion",hadoopVersion);
    File outFile=new File(outDir,className + ".java");
    FileWriter writer=new FileWriter(outFile);
    t.merge(ctx,writer);
    writer.close();
    System.out.println("Generated " + outFile.getCanonicalPath() + " from template "+ template);
  }
 catch (  BuildException e) {
    throw e;
  }
catch (  MethodInvocationException e) {
    throw new BuildException("Exception thrown by '" + e.getReferenceName() + "."+ e.getMethodName()+ "'",e.getWrappedThrowable());
  }
catch (  ParseErrorException e) {
    throw new BuildException("Velocity syntax error",e);
  }
catch (  ResourceNotFoundException e) {
    throw new BuildException("Resource not found",e);
  }
catch (  Exception e) {
    throw new BuildException("Generation failed",e);
  }
}
