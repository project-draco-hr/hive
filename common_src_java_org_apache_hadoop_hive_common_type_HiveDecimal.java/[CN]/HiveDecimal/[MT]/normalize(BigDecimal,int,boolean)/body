{
  if (d == null) {
    return null;
  }
  d=trim(d);
  int valuePrecision=d.precision() + Math.max(0,1 + d.scale() - d.precision());
  if (valuePrecision > precision) {
    if (allowRounding) {
      int adjustedScale=d.scale() - (valuePrecision - precision);
      if (adjustedScale >= 0) {
        d=d.setScale(adjustedScale,RoundingMode.HALF_UP);
        d=trim(d);
      }
 else {
        d=null;
      }
    }
 else {
      d=null;
    }
  }
  return d;
}
