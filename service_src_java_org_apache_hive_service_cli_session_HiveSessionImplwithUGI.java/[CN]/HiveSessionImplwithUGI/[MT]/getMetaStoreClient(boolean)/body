{
  try {
    return Hive.get(getHiveConf()).getMSC();
  }
 catch (  HiveException e) {
    throw new HiveSQLException("Failed to get metastore connection: " + e,e);
  }
catch (  MetaException e1) {
    if (hmsDelegationTokenStr != null && retryInCaseOfTokenExpiration) {
      LOG.info("Retrying failed metastore connection: " + e1,e1);
      Hive.closeCurrent();
      try {
        setDelegationToken(Hive.get(getHiveConf()).getDelegationToken(sessionUgi.getUserName(),getUserName()));
      }
 catch (      HiveException e2) {
        throw new HiveSQLException("Error connect metastore to setup impersonation: " + e2,e2);
      }
      return getMetaStoreClient(false);
    }
 else {
      throw new HiveSQLException("Failed to get metastore connection: " + e1,e1);
    }
  }
}
