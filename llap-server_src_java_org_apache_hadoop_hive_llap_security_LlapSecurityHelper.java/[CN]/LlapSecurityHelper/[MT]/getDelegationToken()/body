{
  if (!UserGroupInformation.isSecurityEnabled())   return null;
  if (llapUgi == null) {
    llapUgi=UserGroupInformation.getCurrentUser();
  }
  Iterator<ServiceInstance> llaps=null;
  ServiceInstance someLlap=null;
  if (client == null) {
    llaps=getLlapServices(false);
    someLlap=llaps.next();
  }
  ByteString tokenBytes=null;
  boolean hasRefreshed=false;
  while (true) {
    try {
      tokenBytes=getTokenBytes(someLlap);
      break;
    }
 catch (    InterruptedException ie) {
      throw new RuntimeException(ie);
    }
catch (    IOException ex) {
      LOG.error("Cannot get a token, trying a different instance",ex);
      client=null;
    }
    if (llaps == null || !llaps.hasNext()) {
      if (hasRefreshed) {
        throw new RuntimeException("Cannot find any LLAPs to get the token from");
      }
      llaps=getLlapServices(true);
      hasRefreshed=true;
    }
    someLlap=llaps.next();
  }
  Token<LlapTokenIdentifier> token=new Token<>();
  DataInputByteBuffer in=new DataInputByteBuffer();
  in.reset(tokenBytes.asReadOnlyByteBuffer());
  token.readFields(in);
  return token;
}
