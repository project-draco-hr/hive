{
  String ip=System.getenv("SPARK_LOCAL_IP");
  if (ip == null) {
    InetAddress address=InetAddress.getLocalHost();
    if (address.isLoopbackAddress()) {
      Enumeration<NetworkInterface> ifaces=NetworkInterface.getNetworkInterfaces();
      while (ifaces.hasMoreElements()) {
        NetworkInterface ni=ifaces.nextElement();
        Enumeration<InetAddress> addrs=ni.getInetAddresses();
        while (addrs.hasMoreElements()) {
          InetAddress addr=addrs.nextElement();
          if (!addr.isLinkLocalAddress() && !addr.isLoopbackAddress() && addr instanceof Inet4Address) {
            LOG.warn("Your hostname, {}, resolves to a loopback address; using {} " + " instead (on interface {})",address.getHostName(),addr.getHostAddress(),ni.getName());
            LOG.warn("Set SPARK_LOCAL_IP if you need to bind to another address");
            return addr.getHostAddress();
          }
        }
      }
      LOG.warn("Your hostname, {}, resolves to, but we couldn't find any external IP address!",address.getHostName());
      LOG.warn("Set SPARK_LOCAL_IP if you need to bind to another address");
    }
    return address.getHostAddress();
  }
  return ip;
}
