{
  if (!finalEventQueued.getAndSet(true)) {
    TezEvent statusUpdateEvent=new TezEvent(getStatusUpdateEvent(true),updateEventMetadata);
    if (diagnostics == null) {
      diagnostics=ExceptionUtils.getStackTrace(t);
    }
 else {
      diagnostics=diagnostics + ":" + ExceptionUtils.getStackTrace(t);
    }
    TezEvent taskAttemptFailedEvent=new TezEvent(new TaskAttemptFailedEvent(diagnostics),srcMeta == null ? updateEventMetadata : srcMeta);
    return !heartbeat(Lists.newArrayList(statusUpdateEvent,taskAttemptFailedEvent)).shouldDie;
  }
 else {
    LOG.warn("A final task state event has already been sent. Not sending again");
    return askedToDie.get();
  }
}
