{
  if (eventsArg != null) {
    eventsToSend.addAll(eventsArg);
  }
  TezEvent updateEvent=null;
  List<TezEvent> events=new ArrayList<TezEvent>();
  eventsToSend.drainTo(events);
  if (!task.isTaskDone() && !task.wasErrorReported()) {
    boolean sendCounters=false;
    if ((nonOobHeartbeatCounter.get() - prevCounterSendHeartbeatNum) * pollInterval >= sendCounterInterval) {
      sendCounters=true;
      prevCounterSendHeartbeatNum=nonOobHeartbeatCounter.get();
    }
    updateEvent=new TezEvent(getStatusUpdateEvent(sendCounters),updateEventMetadata);
    events.add(updateEvent);
  }
  long requestId=requestCounter.incrementAndGet();
  int fromEventId=task.getNextFromEventId();
  int fromPreRoutedEventId=task.getNextPreRoutedEventId();
  int maxEvents=Math.min(maxEventsToGet,task.getMaxEventsToHandle());
  TezHeartbeatRequest request=new TezHeartbeatRequest(requestId,events,fromPreRoutedEventId,containerIdStr,task.getTaskAttemptID(),fromEventId,maxEvents);
  if (LOG.isDebugEnabled()) {
    LOG.debug("Sending heartbeat to AM, request=" + request);
  }
  maybeLogCounters();
  TezHeartbeatResponse response=umbilical.heartbeat(request);
  if (LOG.isDebugEnabled()) {
    LOG.debug("Received heartbeat response from AM, response=" + response);
  }
  if (response.shouldDie()) {
    LOG.info("Received should die response from AM");
    askedToDie.set(true);
    return new ResponseWrapper(true,1);
  }
  if (response.getLastRequestId() != requestId) {
    throw new TezException("AM and Task out of sync" + ", responseReqId=" + response.getLastRequestId() + ", expectedReqId="+ requestId);
  }
  int numEventsReceived=0;
  if (task.isTaskDone() || task.wasErrorReported()) {
    if (response.getEvents() != null && !response.getEvents().isEmpty()) {
      LOG.warn("Current task already complete, Ignoring all event in" + " heartbeat response, eventCount=" + response.getEvents().size());
    }
  }
 else {
    task.setNextFromEventId(response.getNextFromEventId());
    task.setNextPreRoutedEventId(response.getNextPreRoutedEventId());
    List<TezEvent> taskEvents=null;
    if (response.getEvents() != null && !response.getEvents().isEmpty()) {
      if (LOG.isDebugEnabled()) {
        LOG.debug("Routing events from heartbeat response to task" + ", currentTaskAttemptId=" + task.getTaskAttemptID() + ", eventCount="+ response.getEvents().size()+ " fromEventId="+ fromEventId+ " nextFromEventId="+ response.getNextFromEventId());
      }
      numEventsReceived=response.getEvents().size();
      taskEvents=response.getEvents();
    }
    if (initialEvent != null) {
      List<TezEvent> oldEvents=taskEvents;
      taskEvents=new ArrayList<>(1 + (taskEvents == null ? 0 : taskEvents.size()));
      taskEvents.add(initialEvent);
      initialEvent=null;
      if (oldEvents != null) {
        taskEvents.addAll(oldEvents);
      }
    }
    if (taskEvents != null) {
      task.handleEvents(taskEvents);
    }
  }
  return new ResponseWrapper(false,numEventsReceived);
}
