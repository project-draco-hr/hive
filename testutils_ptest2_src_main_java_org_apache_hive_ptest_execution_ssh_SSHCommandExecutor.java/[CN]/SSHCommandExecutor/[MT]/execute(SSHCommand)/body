{
  CollectPolicy collector=new CollectPolicy();
  try {
    String commandText=String.format("ssh -v -i %s %s -l %s %s '%s'",command.getPrivateKey(),mSshOpts,command.getUser(),command.getHost(),command.getCommand());
    int attempts=0;
    boolean retry;
    LocalCommand cmd;
    do {
      retry=false;
      cmd=mLocalCommandFactory.create(collector,commandText);
      if (mShutdown) {
        mLogger.warn("Shutting down command " + command);
        cmd.kill();
        command.setExitCode(Constants.EXIT_CODE_UNKNOWN);
        return;
      }
      if (command.isReportErrors() && attempts++ <= 3 && cmd.getExitCode() == Constants.EXIT_CODE_UNKNOWN) {
        mLogger.warn("Command exited with " + cmd.getExitCode() + ", will retry: "+ command);
        retry=true;
        TimeUnit.SECONDS.sleep(5);
      }
    }
 while (!mShutdown && retry);
    command.setExitCode(cmd.getExitCode());
  }
 catch (  Exception e) {
    if (command.getExitCode() == Constants.EXIT_CODE_SUCCESS) {
      command.setExitCode(Constants.EXIT_CODE_EXCEPTION);
    }
    command.setException(e);
  }
 finally {
    command.setOutput(collector.getOutput());
  }
}
