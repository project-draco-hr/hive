{
  RelOptPlanner planner=HiveVolcanoPlanner.createPlanner();
  final RelOptQuery query=new RelOptQuery(planner);
  final RexBuilder rexBuilder=cluster.getRexBuilder();
  cluster=query.createCluster(rexBuilder.getTypeFactory(),rexBuilder);
  List<RelMetadataProvider> list=Lists.newArrayList();
  list.add(HiveDefaultRelMetadataProvider.INSTANCE);
  planner.registerMetadataProviders(list);
  RelMetadataProvider chainedProvider=ChainedRelMetadataProvider.of(list);
  cluster.setMetadataProvider(new CachingRelMetadataProvider(chainedProvider,planner));
  RelNode opTreeInOptiq=RelNodeConverter.convert(m_sinkOp,cluster,relOptSchema,m_semanticAnalyzer,m_ParseContext);
  planner.clearRules();
  planner.addRule(HiveSwapJoinRule.INSTANCE);
  planner.addRule(HivePushJoinThroughJoinRule.LEFT);
  planner.addRule(HivePushJoinThroughJoinRule.RIGHT);
  if (HiveConf.getBoolVar(m_ParseContext.getConf(),HiveConf.ConfVars.HIVE_CBO_PULLPROJECTABOVEJOIN_RULE)) {
    planner.addRule(HivePullUpProjectsAboveJoinRule.BOTH_PROJECT);
    planner.addRule(HivePullUpProjectsAboveJoinRule.LEFT_PROJECT);
    planner.addRule(HivePullUpProjectsAboveJoinRule.RIGHT_PROJECT);
    planner.addRule(HiveMergeProjectRule.INSTANCE);
  }
  RelTraitSet desiredTraits=cluster.traitSetOf(HiveRel.CONVENTION,RelCollationImpl.EMPTY);
  RelNode rootRel=opTreeInOptiq;
  if (!rootRel.getTraitSet().equals(desiredTraits)) {
    rootRel=planner.changeTraits(opTreeInOptiq,desiredTraits);
  }
  planner.setRoot(rootRel);
  return planner.findBestExp();
}
