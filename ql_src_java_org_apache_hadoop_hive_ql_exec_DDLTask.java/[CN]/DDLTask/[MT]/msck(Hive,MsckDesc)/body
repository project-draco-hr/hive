{
  CheckResult result=new CheckResult();
  List<String> repairOutput=new ArrayList<String>();
  try {
    HiveMetaStoreChecker checker=new HiveMetaStoreChecker(db);
    checker.checkMetastore(db.getCurrentDatabase(),msckDesc.getTableName(),msckDesc.getPartSpecs(),result);
    if (msckDesc.isRepairPartitions()) {
      Table table=db.getTable(msckDesc.getTableName());
      for (      CheckResult.PartitionResult part : result.getPartitionsNotInMs()) {
        try {
          db.createPartition(table,Warehouse.makeSpecFromName(part.getPartitionName()));
          repairOutput.add("Repair: Added partition to metastore " + msckDesc.getTableName() + ':'+ part.getPartitionName());
        }
 catch (        Exception e) {
          LOG.warn("Repair error, could not add partition to metastore: ",e);
        }
      }
    }
  }
 catch (  HiveException e) {
    LOG.warn("Failed to run metacheck: ",e);
    return 1;
  }
catch (  IOException e) {
    LOG.warn("Failed to run metacheck: ",e);
    return 1;
  }
 finally {
    BufferedWriter resultOut=null;
    try {
      Path resFile=new Path(msckDesc.getResFile());
      FileSystem fs=resFile.getFileSystem(conf);
      resultOut=new BufferedWriter(new OutputStreamWriter(fs.create(resFile)));
      boolean firstWritten=false;
      firstWritten|=writeMsckResult(result.getTablesNotInMs(),"Tables not in metastore:",resultOut,firstWritten);
      firstWritten|=writeMsckResult(result.getTablesNotOnFs(),"Tables missing on filesystem:",resultOut,firstWritten);
      firstWritten|=writeMsckResult(result.getPartitionsNotInMs(),"Partitions not in metastore:",resultOut,firstWritten);
      firstWritten|=writeMsckResult(result.getPartitionsNotOnFs(),"Partitions missing from filesystem:",resultOut,firstWritten);
      for (      String rout : repairOutput) {
        if (firstWritten) {
          resultOut.write(terminator);
        }
 else {
          firstWritten=true;
        }
        resultOut.write(rout);
      }
    }
 catch (    IOException e) {
      LOG.warn("Failed to save metacheck output: ",e);
      return 1;
    }
 finally {
      if (resultOut != null) {
        try {
          resultOut.close();
        }
 catch (        IOException e) {
          LOG.warn("Failed to close output file: ",e);
          return 1;
        }
      }
    }
  }
  return 0;
}
