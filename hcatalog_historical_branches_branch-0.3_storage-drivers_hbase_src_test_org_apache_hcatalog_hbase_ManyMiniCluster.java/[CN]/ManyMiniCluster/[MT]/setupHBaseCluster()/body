{
  final int numRegionServers=1;
  try {
    hbaseDir=new File(workDir,"hbase").getAbsolutePath();
    hbaseRoot="file://" + hbaseDir;
    if (hbaseConf == null)     hbaseConf=HBaseConfiguration.create();
    hbaseConf.set("hbase.rootdir",hbaseRoot);
    hbaseConf.set("hbase.master","local");
    hbaseConf.setInt("hbase.zookeeper.property.clientPort",zookeeperPort);
    hbaseConf.set("hbase.zookeeper.quorum","127.0.0.1");
    hbaseConf.setInt("hbase.master.port",findFreePort());
    hbaseConf.setInt("hbase.master.info.port",-1);
    hbaseConf.setInt("hbase.regionserver.port",findFreePort());
    hbaseConf.setInt("hbase.regionserver.info.port",-1);
    hbaseCluster=new MiniHBaseCluster(hbaseConf,numRegionServers);
    hbaseConf.set("hbase.master",hbaseCluster.getHMasterAddress().toString());
    new HTable(hbaseConf,HConstants.META_TABLE_NAME);
  }
 catch (  Exception e) {
    throw new IllegalStateException("Failed to setup HBase Cluster",e);
  }
}
