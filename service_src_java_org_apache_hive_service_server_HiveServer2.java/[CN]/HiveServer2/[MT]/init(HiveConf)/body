{
  cliService=new CLIService(this);
  addService(cliService);
  final HiveServer2 hiveServer2=this;
  Runnable oomHook=new Runnable(){
    @Override public void run(){
      hiveServer2.stop();
    }
  }
;
  if (isHTTPTransportMode(hiveConf)) {
    thriftCLIService=new ThriftHttpCLIService(cliService,oomHook);
  }
 else {
    thriftCLIService=new ThriftBinaryCLIService(cliService,oomHook);
  }
  addService(thriftCLIService);
  super.init(hiveConf);
  try {
    hiveConf.set(HiveConf.ConfVars.HIVE_SERVER2_THRIFT_BIND_HOST.varname,getServerHost());
  }
 catch (  Throwable t) {
    throw new Error("Unable to intitialize HiveServer2",t);
  }
  try {
    if (hiveConf.getBoolVar(ConfVars.HIVE_IN_TEST)) {
      LOG.info("Web UI is disabled since in test mode");
    }
 else {
      int webUIPort=hiveConf.getIntVar(ConfVars.HIVE_SERVER2_WEBUI_PORT);
      if (webUIPort <= 0) {
        LOG.info("Web UI is disabled since port is set to " + webUIPort);
      }
 else {
        HttpServer.Builder builder=new HttpServer.Builder();
        builder.setName("hiveserver2").setPort(webUIPort).setConf(hiveConf);
        builder.setHost(hiveConf.getVar(ConfVars.HIVE_SERVER2_WEBUI_BIND_HOST));
        builder.setMaxThreads(hiveConf.getIntVar(ConfVars.HIVE_SERVER2_WEBUI_MAX_THREADS));
        builder.setAdmins(hiveConf.getVar(ConfVars.USERS_IN_ADMIN_ROLE));
        builder.setContextAttribute("hive.sm",cliService.getSessionManager());
        hiveConf.set("startcode",String.valueOf(System.currentTimeMillis()));
        if (hiveConf.getBoolVar(ConfVars.HIVE_SERVER2_WEBUI_USE_SSL)) {
          String keyStorePath=hiveConf.getVar(ConfVars.HIVE_SERVER2_WEBUI_SSL_KEYSTORE_PATH);
          if (Strings.isBlank(keyStorePath)) {
            throw new IllegalArgumentException(ConfVars.HIVE_SERVER2_WEBUI_SSL_KEYSTORE_PATH.varname + " Not configured for SSL connection");
          }
          builder.setKeyStorePassword(ShimLoader.getHadoopShims().getPassword(hiveConf,ConfVars.HIVE_SERVER2_WEBUI_SSL_KEYSTORE_PASSWORD.varname));
          builder.setKeyStorePath(keyStorePath);
          builder.setUseSSL(true);
        }
        if (hiveConf.getBoolVar(ConfVars.HIVE_SERVER2_WEBUI_USE_SPNEGO)) {
          String spnegoPrincipal=hiveConf.getVar(ConfVars.HIVE_SERVER2_WEBUI_SPNEGO_PRINCIPAL);
          String spnegoKeytab=hiveConf.getVar(ConfVars.HIVE_SERVER2_WEBUI_SPNEGO_KEYTAB);
          if (Strings.isBlank(spnegoPrincipal) || Strings.isBlank(spnegoKeytab)) {
            throw new IllegalArgumentException(ConfVars.HIVE_SERVER2_WEBUI_SPNEGO_PRINCIPAL.varname + "/" + ConfVars.HIVE_SERVER2_WEBUI_SPNEGO_KEYTAB.varname+ " Not configured for SPNEGO authentication");
          }
          builder.setSPNEGOPrincipal(spnegoPrincipal);
          builder.setSPNEGOKeytab(spnegoKeytab);
          builder.setUseSPNEGO(true);
        }
        webServer=builder.build();
      }
    }
  }
 catch (  IOException ie) {
    throw new ServiceException(ie);
  }
  Runtime.getRuntime().addShutdownHook(new Thread(){
    @Override public void run(){
      hiveServer2.stop();
    }
  }
);
}
