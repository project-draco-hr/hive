{
  if (proxyUser == null || proxyUser.trim().isEmpty()) {
    return newConnectionImpl(System.getProperty("user.name"),null,createPartIfNotExists,conf);
  }
  final UserGroupInformation ugi=getUserGroupInfo(proxyUser);
  try {
    return ugi.doAs(new PrivilegedExceptionAction<StreamingConnection>(){
      @Override public StreamingConnection run() throws ConnectionError, InvalidPartition, InvalidTable, PartitionCreationFailed {
        return newConnectionImpl(proxyUser,ugi,createPartIfNotExists,conf);
      }
    }
);
  }
 catch (  IOException e) {
    throw new ImpersonationFailed("Failed to impersonate '" + proxyUser + "' when acquiring connection",e);
  }
}
