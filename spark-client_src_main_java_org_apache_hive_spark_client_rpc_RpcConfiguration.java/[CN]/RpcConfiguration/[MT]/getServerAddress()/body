{
  String value=config.get(SERVER_LISTEN_ADDRESS_KEY);
  if (value != null) {
    return value;
  }
  InetAddress address=InetAddress.getLocalHost();
  if (address.isLoopbackAddress()) {
    Enumeration<NetworkInterface> ifaces=NetworkInterface.getNetworkInterfaces();
    while (ifaces.hasMoreElements()) {
      NetworkInterface ni=ifaces.nextElement();
      Enumeration<InetAddress> addrs=ni.getInetAddresses();
      while (addrs.hasMoreElements()) {
        InetAddress addr=addrs.nextElement();
        if (!addr.isLinkLocalAddress() && !addr.isLoopbackAddress() && addr instanceof Inet4Address) {
          LOG.warn("Your hostname, {}, resolves to a loopback address; using {} " + " instead (on interface {})",address.getHostName(),addr.getHostAddress(),ni.getName());
          LOG.warn("Set '{}' if you need to bind to another address.",SERVER_LISTEN_ADDRESS_KEY);
          return addr.getHostAddress();
        }
      }
    }
  }
  LOG.warn("Your hostname, {}, resolves to a loopback address, but we couldn't find " + " any external IP address!",address.getHostName());
  LOG.warn("Set {} if you need to bind to another address.",SERVER_LISTEN_ADDRESS_KEY);
  return address.getHostName();
}
