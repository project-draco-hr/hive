{
  if (miniHS2.isStarted()) {
    miniHS2.stop();
  }
  HiveConf conf=new HiveConf();
  String userName;
  Path scratchDirPath;
  conf.setBoolean("hive.server2.enable.doAs",false);
  conf.set("hive.exec.scratchdir",tmpDir + "/hs2");
  String fsPermissionStr="700";
  conf.set("hive.scratch.dir.permission",fsPermissionStr);
  miniHS2=new MiniHS2(conf);
  Map<String,String> confOverlay=new HashMap<String,String>();
  miniHS2.start(confOverlay);
  userName=System.getProperty("user.name");
  hs2Conn=getConnection(miniHS2.getJdbcURL(),userName,"password");
  FileSystem fs=miniHS2.getLocalFS();
  FsPermission expectedFSPermission=new FsPermission(HiveConf.getVar(conf,HiveConf.ConfVars.SCRATCHDIRPERMISSION));
  scratchDirPath=new Path(HiveConf.getVar(conf,HiveConf.ConfVars.SCRATCHDIR) + "/" + userName);
  verifyScratchDir(conf,fs,scratchDirPath,expectedFSPermission,userName,false);
  scratchDirPath=new Path(HiveConf.getVar(conf,HiveConf.ConfVars.LOCALSCRATCHDIR));
  verifyScratchDir(conf,fs,scratchDirPath,expectedFSPermission,userName,true);
  scratchDirPath=new Path(HiveConf.getVar(conf,HiveConf.ConfVars.DOWNLOADED_RESOURCES_DIR));
  verifyScratchDir(conf,fs,scratchDirPath,expectedFSPermission,userName,true);
  hs2Conn.close();
  if (miniHS2.isStarted()) {
    miniHS2.stop();
  }
  conf.setBoolean("hive.server2.enable.doAs",true);
  miniHS2=new MiniHS2(conf);
  miniHS2.start(confOverlay);
  userName="neo";
  hs2Conn=getConnection(miniHS2.getJdbcURL(),userName,"the-one");
  scratchDirPath=new Path(HiveConf.getVar(conf,HiveConf.ConfVars.SCRATCHDIR) + "/" + userName);
  verifyScratchDir(conf,fs,scratchDirPath,expectedFSPermission,userName,false);
  scratchDirPath=new Path(HiveConf.getVar(conf,HiveConf.ConfVars.LOCALSCRATCHDIR));
  verifyScratchDir(conf,fs,scratchDirPath,expectedFSPermission,userName,true);
  scratchDirPath=new Path(HiveConf.getVar(conf,HiveConf.ConfVars.DOWNLOADED_RESOURCES_DIR));
  verifyScratchDir(conf,fs,scratchDirPath,expectedFSPermission,userName,true);
  hs2Conn.close();
  userName="trinity";
  hs2Conn=getConnection(miniHS2.getJdbcURL(),userName,"the-one");
  scratchDirPath=new Path(HiveConf.getVar(conf,HiveConf.ConfVars.SCRATCHDIR) + "/" + userName);
  verifyScratchDir(conf,fs,scratchDirPath,expectedFSPermission,userName,false);
  scratchDirPath=new Path(HiveConf.getVar(conf,HiveConf.ConfVars.LOCALSCRATCHDIR));
  verifyScratchDir(conf,fs,scratchDirPath,expectedFSPermission,userName,true);
  scratchDirPath=new Path(HiveConf.getVar(conf,HiveConf.ConfVars.DOWNLOADED_RESOURCES_DIR));
  verifyScratchDir(conf,fs,scratchDirPath,expectedFSPermission,userName,true);
}
