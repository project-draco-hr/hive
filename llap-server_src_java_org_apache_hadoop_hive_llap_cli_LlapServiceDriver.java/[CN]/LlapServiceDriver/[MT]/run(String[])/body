{
  LlapOptionsProcessor optionsProcessor=new LlapOptionsProcessor();
  LlapOptions options=optionsProcessor.processOptions(args);
  if (options == null) {
    return 0;
  }
  Path tmpDir=new Path(options.getDirectory());
  if (conf == null) {
    LOG.warn("Cannot load any configuration to run command");
    return 1;
  }
  FileSystem fs=FileSystem.get(conf);
  FileSystem lfs=FileSystem.getLocal(conf).getRawFileSystem();
  String[] neededConfig={"tez-site.xml","hive-site.xml","llap-daemon-site.xml","core-site.xml"};
  for (  String f : neededConfig) {
    conf.addResource(f);
    if (conf.getResource(f) == null) {
      LOG.warn("Unable to find required config file: " + f);
      return 2;
    }
  }
  conf.reloadConfiguration();
  if (options.getName() != null) {
    conf.set(LlapConfiguration.LLAP_DAEMON_SERVICE_HOSTS,"@" + options.getName());
  }
  if (options.getSize() != -1) {
    if (options.getCache() != -1) {
      Preconditions.checkArgument(options.getCache() < options.getSize(),"Cache has to be smaller than the container sizing");
    }
    if (options.getXmx() != -1) {
      Preconditions.checkArgument(options.getXmx() < options.getSize(),"Working memory has to be smaller than the container sizing");
    }
    if (HiveConf.getBoolVar(conf,HiveConf.ConfVars.LLAP_ORC_CACHE_ALLOCATE_DIRECT)) {
      Preconditions.checkArgument(options.getXmx() + options.getCache() < options.getSize(),"Working memory + cache has to be smaller than the containing sizing ");
    }
  }
  final long minAlloc=conf.getInt(YarnConfiguration.RM_SCHEDULER_MINIMUM_ALLOCATION_MB,-1);
  if (options.getSize() != -1) {
    final long containerSize=options.getSize() / (1024 * 1024);
    Preconditions.checkArgument(containerSize >= minAlloc,"Container size should be greater than minimum allocation(%s)",minAlloc + "m");
    conf.setLong(LlapConfiguration.LLAP_DAEMON_YARN_CONTAINER_MB,containerSize);
  }
  if (options.getExecutors() != -1) {
    conf.setLong(LlapConfiguration.LLAP_DAEMON_NUM_EXECUTORS,options.getExecutors());
  }
  if (options.getCache() != -1) {
    conf.setLong(HiveConf.ConfVars.LLAP_ORC_CACHE_MAX_SIZE.varname,options.getCache());
  }
  if (options.getXmx() != -1) {
    conf.setLong(LlapConfiguration.LLAP_DAEMON_MEMORY_PER_INSTANCE_MB,(long)(options.getXmx()) / (1024 * 1024));
  }
  URL logger=conf.getResource("llap-daemon-log4j.properties");
  if (null == logger) {
    LOG.warn("Unable to find required config file: llap-daemon-log4j.properties");
    return 3;
  }
  Path home=new Path(System.getenv("HIVE_HOME"));
  Path scripts=new Path(new Path(new Path(home,"scripts"),"llap"),"bin");
  if (!lfs.exists(home)) {
    LOG.warn("Unable to find HIVE_HOME:" + home);
    return 3;
  }
 else   if (!lfs.exists(scripts)) {
    LOG.warn("Unable to find llap scripts:" + scripts);
  }
  Path libDir=new Path(tmpDir,"lib");
  String tezLibs=conf.get("tez.lib.uris");
  if (tezLibs == null) {
    LOG.warn("Missing tez.lib.uris in tez-site.xml");
  }
  if (LOG.isDebugEnabled()) {
    LOG.debug("Copying tez libs from " + tezLibs);
  }
  lfs.mkdirs(libDir);
  fs.copyToLocalFile(new Path(tezLibs),new Path(libDir,"tez.tar.gz"));
  CompressionUtils.unTar(new Path(libDir,"tez.tar.gz").toString(),libDir.toString(),true);
  lfs.delete(new Path(libDir,"tez.tar.gz"),false);
  lfs.copyFromLocalFile(new Path(Utilities.jarFinderGetJar(LlapInputFormat.class)),libDir);
  lfs.copyFromLocalFile(new Path(Utilities.jarFinderGetJar(HiveInputFormat.class)),libDir);
  Path confPath=new Path(tmpDir,"conf");
  lfs.mkdirs(confPath);
  for (  String f : neededConfig) {
    if (f.equals("llap-daemon-site.xml")) {
      FSDataOutputStream confStream=lfs.create(new Path(confPath,f));
      Configuration copy=resolve(conf,"llap-daemon-site.xml");
      copy.writeXml(confStream);
      confStream.close();
    }
 else {
      lfs.copyFromLocalFile(new Path(conf.getResource(f).toString()),confPath);
    }
  }
  lfs.copyFromLocalFile(new Path(logger.toString()),confPath);
  JSONObject configs=new JSONObject();
  configs.put(LlapConfiguration.LLAP_DAEMON_YARN_CONTAINER_MB,conf.getInt(LlapConfiguration.LLAP_DAEMON_YARN_CONTAINER_MB,LlapConfiguration.LLAP_DAEMON_YARN_CONTAINER_MB_DEFAULT));
  configs.put(HiveConf.ConfVars.LLAP_ORC_CACHE_MAX_SIZE.varname,HiveConf.getLongVar(conf,HiveConf.ConfVars.LLAP_ORC_CACHE_MAX_SIZE));
  configs.put(HiveConf.ConfVars.LLAP_ORC_CACHE_ALLOCATE_DIRECT.varname,HiveConf.getBoolVar(conf,HiveConf.ConfVars.LLAP_ORC_CACHE_ALLOCATE_DIRECT));
  configs.put(LlapConfiguration.LLAP_DAEMON_MEMORY_PER_INSTANCE_MB,conf.getInt(LlapConfiguration.LLAP_DAEMON_MEMORY_PER_INSTANCE_MB,LlapConfiguration.LLAP_DAEMON_MEMORY_PER_INSTANCE_MB_DEFAULT));
  configs.put(LlapConfiguration.LLAP_DAEMON_VCPUS_PER_INSTANCE,conf.getInt(LlapConfiguration.LLAP_DAEMON_VCPUS_PER_INSTANCE,LlapConfiguration.LLAP_DAEMON_VCPUS_PER_INSTANCE_DEFAULT));
  configs.put(LlapConfiguration.LLAP_DAEMON_NUM_EXECUTORS,conf.getInt(LlapConfiguration.LLAP_DAEMON_NUM_EXECUTORS,LlapConfiguration.LLAP_DAEMON_NUM_EXECUTORS_DEFAULT));
  configs.put(YarnConfiguration.RM_SCHEDULER_MINIMUM_ALLOCATION_MB,conf.getInt(YarnConfiguration.RM_SCHEDULER_MINIMUM_ALLOCATION_MB,-1));
  configs.put(YarnConfiguration.RM_SCHEDULER_MINIMUM_ALLOCATION_VCORES,conf.getInt(YarnConfiguration.RM_SCHEDULER_MINIMUM_ALLOCATION_VCORES,-1));
  FSDataOutputStream os=lfs.create(new Path(tmpDir,"config.json"));
  OutputStreamWriter w=new OutputStreamWriter(os);
  configs.write(w);
  w.close();
  os.close();
  lfs.close();
  fs.close();
  if (LOG.isDebugEnabled()) {
    LOG.debug("Exiting successfully");
  }
  return 0;
}
