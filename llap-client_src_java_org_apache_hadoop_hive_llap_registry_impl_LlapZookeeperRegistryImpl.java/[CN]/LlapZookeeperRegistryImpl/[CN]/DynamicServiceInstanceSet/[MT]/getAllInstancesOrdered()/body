{
  Map<String,String> slotByWorker=new HashMap<String,String>();
  List<ServiceInstance> unsorted=new LinkedList<ServiceInstance>();
  for (  ChildData childData : instancesCache.getCurrentData()) {
    if (childData == null)     continue;
    byte[] data=childData.getData();
    if (data == null)     continue;
    String nodeName=extractNodeName(childData);
    if (nodeName.startsWith(WORKER_PREFIX)) {
      try {
        ServiceRecord srv=encoder.fromBytes(childData.getPath(),data);
        ServiceInstance instance=new DynamicServiceInstance(srv);
        unsorted.add(instance);
      }
 catch (      IOException e) {
        LOG.error("Unable to decode data for zkpath: {}." + " Ignoring from current instances list..",childData.getPath());
      }
    }
 else     if (nodeName.startsWith(SLOT_PREFIX)) {
      slotByWorker.put(extractWorkerIdFromSlot(childData),nodeName);
    }
 else {
      LOG.info("Ignoring unknown node {}",childData.getPath());
    }
  }
  TreeMap<String,ServiceInstance> sorted=new TreeMap<>();
  for (  ServiceInstance worker : unsorted) {
    String slot=slotByWorker.get(worker.getWorkerIdentity());
    if (slot == null) {
      LOG.info("Unknown slot for {}",worker.getWorkerIdentity());
      continue;
    }
    sorted.put(slot,worker);
  }
  return sorted.values();
}
