{
  if (!(topSelparentPair.getKey() instanceof Sort) || !HiveCalciteUtil.orderRelNode(topSelparentPair.getKey())) {
    return;
  }
  HiveSort obRel=(HiveSort)topSelparentPair.getKey();
  Project obChild=(Project)topSelparentPair.getValue();
  if (obChild.getRowType().getFieldCount() <= resultSchema.size()) {
    return;
  }
  RelDataType rt=obChild.getRowType();
  @SuppressWarnings({"unchecked","rawtypes"}) Set<Integer> collationInputRefs=new HashSet(RelCollations.ordinals(obRel.getCollation()));
  ImmutableMap.Builder<Integer,RexNode> inputRefToCallMapBldr=ImmutableMap.builder();
  for (int i=resultSchema.size(); i < rt.getFieldCount(); i++) {
    if (collationInputRefs.contains(i)) {
      RexNode obyExpr=obChild.getChildExps().get(i);
      if (obyExpr instanceof RexCall) {
        LOG.debug("Old RexCall : " + obyExpr);
        obyExpr=adjustOBSchema((RexCall)obyExpr,obChild,resultSchema);
        LOG.debug("New RexCall : " + obyExpr);
      }
      inputRefToCallMapBldr.put(i,obyExpr);
    }
  }
  ImmutableMap<Integer,RexNode> inputRefToCallMap=inputRefToCallMapBldr.build();
  if ((obChild.getRowType().getFieldCount() - inputRefToCallMap.size()) != resultSchema.size()) {
    LOG.error(generateInvalidSchemaMessage(obChild,resultSchema,inputRefToCallMap.size()));
    throw new CalciteSemanticException("Result Schema didn't match Optimized Op Tree Schema");
  }
  if (replaceProject) {
    HiveProject replacementProjectRel=HiveProject.create(obChild.getInput(),obChild.getChildExps().subList(0,resultSchema.size()),obChild.getRowType().getFieldNames().subList(0,resultSchema.size()));
    obRel.replaceInput(0,replacementProjectRel);
  }
  obRel.setInputRefToCallMap(inputRefToCallMap);
}
