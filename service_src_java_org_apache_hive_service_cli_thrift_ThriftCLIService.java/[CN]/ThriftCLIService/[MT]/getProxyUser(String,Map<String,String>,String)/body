{
  if (sessionConf == null || !sessionConf.containsKey(HiveAuthFactory.HS2_PROXY_USER)) {
    return realUser;
  }
  String proxyUser=sessionConf.get(HiveAuthFactory.HS2_PROXY_USER);
  if (!hiveConf.getBoolVar(HiveConf.ConfVars.HIVE_SERVER2_ALLOW_USER_SUBSTITUTION)) {
    throw new HiveSQLException("Proxy user substitution is not allowed");
  }
  if (HiveAuthFactory.AuthTypes.NONE.toString().equalsIgnoreCase(hiveConf.getVar(ConfVars.HIVE_SERVER2_AUTHENTICATION))) {
    return proxyUser;
  }
  HiveAuthFactory.verifyProxyAccess(realUser,proxyUser,ipAddress,hiveConf);
  return proxyUser;
}
