{
  String proxyUser=SessionManager.getProxyUserName();
  LOG.debug("Proxy user from query string: " + proxyUser);
  if (proxyUser == null && sessionConf != null && sessionConf.containsKey(HiveAuthFactory.HS2_PROXY_USER)) {
    String proxyUserFromThriftBody=sessionConf.get(HiveAuthFactory.HS2_PROXY_USER);
    LOG.debug("Proxy user from thrift body: " + proxyUserFromThriftBody);
    proxyUser=proxyUserFromThriftBody;
  }
  if (proxyUser == null) {
    return realUser;
  }
  if (!hiveConf.getBoolVar(HiveConf.ConfVars.HIVE_SERVER2_ALLOW_USER_SUBSTITUTION)) {
    throw new HiveSQLException("Proxy user substitution is not allowed");
  }
  if (HiveAuthFactory.AuthTypes.NONE.toString().equalsIgnoreCase(hiveConf.getVar(ConfVars.HIVE_SERVER2_AUTHENTICATION))) {
    return proxyUser;
  }
  HiveAuthFactory.verifyProxyAccess(realUser,proxyUser,ipAddress,hiveConf);
  LOG.debug("Verified proxy user: " + proxyUser);
  return proxyUser;
}
