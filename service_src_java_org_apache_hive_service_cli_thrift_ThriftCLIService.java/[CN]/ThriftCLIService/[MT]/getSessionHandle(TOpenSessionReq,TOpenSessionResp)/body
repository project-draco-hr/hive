{
  String userName=getUserName(req);
  TProtocolVersion protocol=getMinVersion(CLIService.SERVER_VERSION,req.getClient_protocol());
  SessionHandle sessionHandle;
  if (cliService.getHiveConf().getVar(ConfVars.HIVE_SERVER2_AUTHENTICATION).equals(HiveAuthFactory.AuthTypes.KERBEROS.toString()) && cliService.getHiveConf().getBoolVar(ConfVars.HIVE_SERVER2_ENABLE_DOAS)) {
    String delegationTokenStr=null;
    try {
      delegationTokenStr=cliService.getDelegationTokenFromMetaStore(userName);
    }
 catch (    UnsupportedOperationException e) {
    }
    sessionHandle=cliService.openSessionWithImpersonation(protocol,userName,req.getPassword(),req.getConfiguration(),delegationTokenStr);
  }
 else {
    sessionHandle=cliService.openSession(protocol,userName,req.getPassword(),req.getConfiguration());
  }
  res.setServerProtocolVersion(protocol);
  return sessionHandle;
}
