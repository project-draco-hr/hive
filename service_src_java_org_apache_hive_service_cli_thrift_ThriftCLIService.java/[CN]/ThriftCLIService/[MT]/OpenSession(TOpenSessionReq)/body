{
  TOpenSessionResp resp=new TOpenSessionResp();
  try {
    String userName;
    if (hiveAuthFactory != null && hiveAuthFactory.getRemoteUser() != null) {
      userName=hiveAuthFactory.getRemoteUser();
    }
 else {
      userName=req.getUsername();
    }
    SessionHandle sessionHandle=null;
    if (cliService.getHiveConf().getBoolVar(HiveConf.ConfVars.HIVE_SERVER2_KERBEROS_IMPERSONATION)) {
      String delegationTokenStr=null;
      try {
        delegationTokenStr=cliService.getDelegationTokenFromMetaStore(userName);
      }
 catch (      UnsupportedOperationException e) {
      }
      sessionHandle=cliService.openSessionWithImpersonation(userName,req.getPassword(),req.getConfiguration(),delegationTokenStr);
    }
 else {
      sessionHandle=cliService.openSession(userName,req.getPassword(),req.getConfiguration());
    }
    resp.setSessionHandle(sessionHandle.toTSessionHandle());
    resp.setConfiguration(new HashMap<String,String>());
    resp.setStatus(OK_STATUS);
  }
 catch (  Exception e) {
    e.printStackTrace();
    resp.setStatus(HiveSQLException.toTStatus(e));
  }
  return resp;
}
