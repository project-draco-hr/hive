{
  FileStatus fStatus=sourceStatus.getFileStatus();
  String group=fStatus.getGroup();
  boolean aclEnabled=Objects.equal(conf.get("dfs.namenode.acls.enabled"),"true");
  FsPermission sourcePerm=fStatus.getPermission();
  List<AclEntry> aclEntries=null;
  AclStatus aclStatus;
  if (aclEnabled) {
    aclStatus=sourceStatus.getAclStatus();
    if (aclStatus != null) {
      LOG.trace(aclStatus.toString());
      aclEntries=aclStatus.getEntries();
      removeBaseAclEntries(aclEntries);
      aclEntries.add(newAclEntry(AclEntryScope.ACCESS,AclEntryType.USER,sourcePerm.getUserAction()));
      aclEntries.add(newAclEntry(AclEntryScope.ACCESS,AclEntryType.GROUP,sourcePerm.getGroupAction()));
      aclEntries.add(newAclEntry(AclEntryScope.ACCESS,AclEntryType.OTHER,sourcePerm.getOtherAction()));
    }
  }
  if (recursion) {
    FsShell fsShell=new FsShell();
    fsShell.setConf(conf);
    try {
      if (group != null && !group.isEmpty()) {
        run(fsShell,new String[]{"-chgrp","-R",group,target.toString()});
      }
      if (aclEnabled) {
        if (null != aclEntries) {
          try {
            String aclEntry=Joiner.on(",").join(aclEntries);
            run(fsShell,new String[]{"-setfacl","-R","--set",aclEntry,target.toString()});
          }
 catch (          Exception e) {
            LOG.info("Skipping ACL inheritance: File system for path " + target + " "+ "does not support ACLs but dfs.namenode.acls.enabled is set to true. ");
            LOG.debug("The details are: " + e,e);
          }
        }
      }
 else {
        String permission=Integer.toString(sourcePerm.toShort(),8);
        run(fsShell,new String[]{"-chmod","-R",permission,target.toString()});
      }
    }
 catch (    Exception e) {
      throw new IOException("Unable to set permissions of " + target,e);
    }
  }
 else {
    if (group != null && !group.isEmpty()) {
      if (targetGroup == null || !group.equals(targetGroup)) {
        fs.setOwner(target,null,group);
      }
    }
    if (aclEnabled) {
      if (null != aclEntries) {
        fs.setAcl(target,aclEntries);
      }
    }
 else {
      fs.setPermission(target,sourcePerm);
    }
  }
}
