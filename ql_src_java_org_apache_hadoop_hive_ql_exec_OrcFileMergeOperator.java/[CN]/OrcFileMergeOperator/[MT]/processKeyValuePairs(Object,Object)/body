{
  try {
    OrcFileValueWrapper v;
    OrcFileKeyWrapper k;
    if (key instanceof CombineHiveKey) {
      k=(OrcFileKeyWrapper)((CombineHiveKey)key).getKey();
    }
 else {
      k=(OrcFileKeyWrapper)key;
    }
    fixTmpPath(k.getInputPath().getParent());
    v=(OrcFileValueWrapper)value;
    if (prevPath == null) {
      prevPath=k.getInputPath();
      reader=OrcFile.createReader(fs,k.getInputPath());
      LOG.info("ORC merge file input path: " + k.getInputPath());
    }
    if (outWriter == null) {
      compression=k.getCompression();
      compressBuffSize=k.getCompressBufferSize();
      version=k.getVersionList();
      columnCount=k.getTypes().get(0).getSubtypesCount();
      rowIndexStride=k.getRowIndexStride();
      outWriter=OrcFile.createWriter(outPath,OrcFile.writerOptions(jc).compress(compression).inspector(reader.getObjectInspector()));
      LOG.info("ORC merge file output path: " + outPath);
    }
    if (!checkCompatibility(k)) {
      incompatFileSet.add(k.getInputPath());
      return;
    }
    if (!k.getInputPath().equals(prevPath)) {
      reader=OrcFile.createReader(fs,k.getInputPath());
    }
    byte[] buffer=new byte[(int)v.getStripeInformation().getLength()];
    fdis=fs.open(k.getInputPath());
    fdis.readFully(v.getStripeInformation().getOffset(),buffer,0,(int)v.getStripeInformation().getLength());
    outWriter.appendStripe(buffer,0,buffer.length,v.getStripeInformation(),v.getStripeStatistics());
    LOG.info("Merged stripe from file " + k.getInputPath() + " [ offset : "+ v.getStripeInformation().getOffset()+ " length: "+ v.getStripeInformation().getLength()+ " ]");
    if (v.isLastStripeInFile()) {
      outWriter.appendUserMetadata(v.getUserMetadata());
    }
  }
 catch (  Throwable e) {
    this.exception=true;
    closeOp(true);
    throw new HiveException(e);
  }
}
