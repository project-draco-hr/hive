{
  int readBufIndex=getBufferIndex(offset);
  byte[] readBuffer=writeBuffers.get(readBufIndex);
  int readBufOffset=getOffset(offset);
  int srcOffset=0;
  while (srcOffset < length) {
    if (readBufOffset == wbSize) {
      ++readBufIndex;
      readBuffer=writeBuffers.get(readBufIndex);
      readBufOffset=0;
    }
    if (currentWriteOffset == wbSize) {
      nextBufferToWrite();
    }
    int toRead=Math.min(length - srcOffset,wbSize - readBufOffset);
    int toWrite=Math.min(toRead,wbSize - currentWriteOffset);
    System.arraycopy(readBuffer,readBufOffset,currentWriteBuffer,currentWriteOffset,toWrite);
    currentWriteOffset+=toWrite;
    readBufOffset+=toWrite;
    srcOffset+=toWrite;
    if (toRead > toWrite) {
      nextBufferToWrite();
      toRead-=toWrite;
      System.arraycopy(readBuffer,readBufOffset,currentWriteBuffer,currentWriteOffset,toRead);
      currentWriteOffset+=toRead;
      readBufOffset+=toRead;
      srcOffset+=toRead;
    }
  }
}
