{
  int readBufIndex=getBufferIndex(offset);
  byte[] readBuffer=writeBuffers.get(readBufIndex);
  int readBufOffset=getOffset(offset);
  int srcOffset=0;
  while (srcOffset < length) {
    if (readBufOffset == wbSize) {
      ++readBufIndex;
      readBuffer=writeBuffers.get(readBufIndex);
      readBufOffset=0;
    }
    if (writePos.offset == wbSize) {
      nextBufferToWrite();
    }
    int toRead=Math.min(length - srcOffset,wbSize - readBufOffset);
    int toWrite=Math.min(toRead,wbSize - writePos.offset);
    System.arraycopy(readBuffer,readBufOffset,writePos.buffer,writePos.offset,toWrite);
    writePos.offset+=toWrite;
    readBufOffset+=toWrite;
    srcOffset+=toWrite;
    if (toRead > toWrite) {
      nextBufferToWrite();
      toRead-=toWrite;
      System.arraycopy(readBuffer,readBufOffset,writePos.buffer,writePos.offset,toRead);
      writePos.offset+=toRead;
      readBufOffset+=toRead;
      srcOffset+=toRead;
    }
  }
}
