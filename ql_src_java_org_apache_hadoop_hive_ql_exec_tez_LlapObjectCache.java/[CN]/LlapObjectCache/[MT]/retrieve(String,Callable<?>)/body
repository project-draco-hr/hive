{
  Object o=null;
  ReentrantLock objectLock=null;
  lock.lock();
  try {
    o=registry.getIfPresent(key);
    if (o != null) {
      if (isLogInfoEnabled) {
        LOG.info("Found " + key + " in cache");
      }
      return o;
    }
    if (locks.containsKey(key)) {
      objectLock=locks.get(key);
    }
 else {
      objectLock=new ReentrantLock();
      locks.put(key,objectLock);
    }
  }
  finally {
    lock.unlock();
  }
  objectLock.lock();
  try {
    lock.lock();
    try {
      o=registry.getIfPresent(key);
      if (o != null) {
        if (isLogInfoEnabled) {
          LOG.info("Found " + key + " in cache");
        }
        return o;
      }
    }
  finally {
      lock.unlock();
    }
    try {
      o=fn.call();
    }
 catch (    Exception e) {
      throw new HiveException(e);
    }
    lock.lock();
    try {
      if (isLogInfoEnabled) {
        LOG.info("Caching new object for key: " + key);
      }
      registry.put(key,o);
      locks.remove(key);
    }
  finally {
      lock.unlock();
    }
  }
  finally {
    objectLock.unlock();
  }
  return o;
}
