{
  final Union union=call.rel(0);
  final int count=union.getRowType().getFieldCount();
  if (count == 1) {
    return;
  }
  final RexBuilder rexBuilder=union.getCluster().getRexBuilder();
  final RelMetadataQuery mq=RelMetadataQuery.instance();
  final RelOptPredicateList predicates=mq.getPulledUpPredicates(union);
  if (predicates == null) {
    return;
  }
  Map<RexNode,RexNode> conditionsExtracted=HiveReduceExpressionsRule.predicateConstants(RexNode.class,rexBuilder,predicates);
  Map<RexNode,RexNode> constants=new HashMap<>();
  for (int i=0; i < count; i++) {
    RexNode expr=rexBuilder.makeInputRef(union,i);
    if (conditionsExtracted.containsKey(expr)) {
      constants.put(expr,conditionsExtracted.get(expr));
    }
  }
  if (constants.isEmpty()) {
    return;
  }
  List<RelDataTypeField> fields=union.getRowType().getFieldList();
  List<RexNode> topChildExprs=new ArrayList<>();
  List<String> topChildExprsFields=new ArrayList<>();
  List<RexNode> refs=new ArrayList<>();
  ImmutableBitSet.Builder refsIndexBuilder=ImmutableBitSet.builder();
  for (int i=0; i < count; i++) {
    RexNode expr=rexBuilder.makeInputRef(union,i);
    RelDataTypeField field=fields.get(i);
    if (constants.containsKey(expr)) {
      topChildExprs.add(constants.get(expr));
      topChildExprsFields.add(field.getName());
    }
 else {
      topChildExprs.add(expr);
      topChildExprsFields.add(field.getName());
      refs.add(expr);
      refsIndexBuilder.set(i);
    }
  }
  ImmutableBitSet refsIndex=refsIndexBuilder.build();
  final Mappings.TargetMapping mapping=RelOptUtil.permutation(refs,union.getInput(0).getRowType()).inverse();
  topChildExprs=ImmutableList.copyOf(RexUtil.apply(mapping,topChildExprs));
  final RelBuilder relBuilder=call.builder();
  for (int i=0; i < union.getInputs().size(); i++) {
    RelNode input=union.getInput(i);
    List<Pair<RexNode,String>> newChildExprs=new ArrayList<>();
    for (int j=0; j < refsIndex.cardinality(); j++) {
      int pos=refsIndex.nth(j);
      newChildExprs.add(Pair.<RexNode,String>of(rexBuilder.makeInputRef(input,pos),input.getRowType().getFieldList().get(pos).getName()));
    }
    if (newChildExprs.isEmpty()) {
      newChildExprs.add(Pair.<RexNode,String>of(topChildExprs.get(0),topChildExprsFields.get(0)));
    }
    relBuilder.push(input);
    relBuilder.project(Pair.left(newChildExprs),Pair.right(newChildExprs));
  }
  relBuilder.union(union.all,union.getInputs().size());
  relBuilder.project(topChildExprs,topChildExprsFields);
  relBuilder.convert(union.getRowType(),false);
  call.transformTo(relBuilder.build());
}
