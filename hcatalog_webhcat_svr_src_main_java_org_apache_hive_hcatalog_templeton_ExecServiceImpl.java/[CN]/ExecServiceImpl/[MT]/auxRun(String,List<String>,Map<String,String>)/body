{
  DefaultExecutor executor=new DefaultExecutor();
  executor.setExitValues(null);
  int nbytes=appConf.getInt(AppConfig.EXEC_MAX_BYTES_NAME,-1);
  ByteArrayOutputStream outStream=new MaxByteArrayOutputStream(nbytes);
  ByteArrayOutputStream errStream=new MaxByteArrayOutputStream(nbytes);
  executor.setStreamHandler(new PumpStreamHandler(outStream,errStream));
  int timeout=appConf.getInt(AppConfig.EXEC_TIMEOUT_NAME,0);
  ExecuteWatchdog watchdog=new ExecuteWatchdog(timeout);
  executor.setWatchdog(watchdog);
  CommandLine cmd=makeCommandLine(program,args);
  LOG.info("Running: " + cmd);
  ExecBean res=new ExecBean();
  if (Shell.WINDOWS) {
    env=execEnv(env);
    String[] envVals=new String[env.size()];
    int i=0;
    for (    Entry<String,String> kv : env.entrySet()) {
      envVals[i++]=kv.getKey() + "=" + kv.getValue();
      LOG.info("Setting " + kv.getKey() + "="+ kv.getValue());
    }
    Process proc;
synchronized (WindowsProcessLaunchLock) {
      proc=Runtime.getRuntime().exec(cmd.toStrings(),envVals);
    }
    StreamOutputWriter errorGobbler=new StreamOutputWriter(proc.getErrorStream(),"ERROR",errStream);
    StreamOutputWriter outputGobbler=new StreamOutputWriter(proc.getInputStream(),"OUTPUT",outStream);
    errorGobbler.start();
    outputGobbler.start();
    try {
      res.exitcode=proc.waitFor();
    }
 catch (    InterruptedException e) {
      throw new IOException(e);
    }
    errorGobbler.out.flush();
    outputGobbler.out.flush();
  }
 else {
    res.exitcode=executor.execute(cmd,execEnv(env));
  }
  String enc=appConf.get(AppConfig.EXEC_ENCODING_NAME);
  res.stdout=outStream.toString(enc);
  res.stderr=errStream.toString(enc);
  try {
    watchdog.checkException();
  }
 catch (  Exception ex) {
    LOG.error("Command: " + cmd + " failed:",ex);
  }
  if (watchdog.killedProcess()) {
    String msg=" was terminated due to timeout(" + timeout + "ms).  See "+ AppConfig.EXEC_TIMEOUT_NAME+ " property";
    LOG.warn("Command: " + cmd + msg);
    res.stderr+=" Command " + msg;
  }
  return res;
}
