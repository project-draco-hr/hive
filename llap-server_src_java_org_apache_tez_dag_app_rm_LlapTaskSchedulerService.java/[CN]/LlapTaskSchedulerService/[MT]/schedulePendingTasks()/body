{
  writeLock.lock();
  try {
    Iterator<Entry<Priority,List<TaskInfo>>> pendingIterator=pendingTasks.entrySet().iterator();
    while (pendingIterator.hasNext()) {
      Entry<Priority,List<TaskInfo>> entry=pendingIterator.next();
      List<TaskInfo> taskListAtPriority=entry.getValue();
      Iterator<TaskInfo> taskIter=taskListAtPriority.iterator();
      boolean scheduledAllAtPriority=true;
      while (taskIter.hasNext()) {
        TaskInfo taskInfo=taskIter.next();
        if (taskInfo.getNumPreviousAssignAttempts() == 1) {
          dagStats.registerDelayedAllocation();
        }
        taskInfo.triedAssigningTask();
        boolean scheduled=scheduleTask(taskInfo);
        if (scheduled) {
          taskIter.remove();
        }
 else {
          LOG.info("Attempting to preempt for {}, pendingPreemptions={}",taskInfo.task,pendingPreemptions.get());
          if (pendingPreemptions.get() == 0) {
            preemptTasks(entry.getKey().getPriority(),1);
          }
          scheduledAllAtPriority=false;
          break;
        }
      }
      if (taskListAtPriority.isEmpty()) {
        pendingIterator.remove();
      }
      if (!scheduledAllAtPriority) {
        break;
      }
    }
  }
  finally {
    writeLock.unlock();
  }
}
