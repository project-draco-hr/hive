{
  assert(hookContext.getHookType() == HookContext.HookType.PRE_EXEC_HOOK);
  SessionState sess=SessionState.get();
  HiveConf conf=sess.getConf();
  String commandType=StringEscapeUtils.escapeJava(sess.getCommandType());
  if ((commandType == null) || (!commandType.equals("QUERY") && !commandType.equals("CREATETABLE_AS_SELECT"))) {
    return;
  }
  Set<ReadEntity> inputs=hookContext.getInputs();
  if ((inputs == null) || (inputs.isEmpty())) {
    return;
  }
  String inputString=getInputs(inputs);
  if ((inputString == null) || (inputString.isEmpty())) {
    return;
  }
  ConnectionUrlFactory urlFactory=HookUtils.getUrlFactory(conf,FBHiveConf.CONNECTION_FACTORY,FBHiveConf.QUERYDROPPED_PARTITIONS_CONNECTION_FACTORY,FBHiveConf.QUERYDROPPED_PARTITIONS_MYSQL_TIER_VAR_NAME,FBHiveConf.QUERYPLAN_HOST_DATABASE_VAR_NAME);
  if ((FBHiveConf.QUERYDROPPED_PARTITIONS_MYSQL_TIER_VAR_NAME == null) || FBHiveConf.QUERYDROPPED_PARTITIONS_MYSQL_TIER_VAR_NAME.isEmpty()) {
    LOG.warn(FBHiveConf.QUERYPLAN_MYSQL_TIER_VAR_NAME + " is null");
    return;
  }
  if (urlFactory == null) {
    LOG.warn("unable to access " + conf.get(FBHiveConf.QUERYPLAN_MYSQL_TIER_VAR_NAME));
    return;
  }
  List<Object> sqlParams=new ArrayList<Object>();
  sqlParams.add(inputString);
  LOG.info("QueryDroppedPartitionsHook input string: " + inputString);
  String sql="select count(*) from 0114_dropped_parts3 " + "where (recovered is null or recovered != 1) and ?";
  List<List<Object>> result=HookUtils.runInsertSelect(conf,urlFactory,sql,sqlParams,false);
  Long numberDroppedPartitions=null;
  if (!result.isEmpty() && result.get(0).get(0) != null) {
    numberDroppedPartitions=(Long)result.get(0).get(0);
  }
  if ((numberDroppedPartitions != null) && (numberDroppedPartitions > 0)) {
    String exception="You cannot select from " + inputString + ".";
    exception+="Look at ";
    exception+="https://our.intern.facebook.com/intern/sevmanager/prod/sev/137261279725248";
    exception+=" for details ";
    throw new Exception(exception);
  }
}
