{
  int stageId=taskEnd.stageId();
  int stageAttemptId=taskEnd.stageAttemptId();
  String stageIdentifier=stageId + "_" + stageAttemptId;
  Integer jobId=stageIdToJobId.get(stageId);
  if (jobId == null) {
    LOG.warn("Can not find job id for stage[" + stageId + "].");
  }
 else {
    Map<String,List<TaskMetrics>> jobMetrics=allJobMetrics.get(jobId);
    if (jobMetrics == null) {
      jobMetrics=Maps.newHashMap();
      allJobMetrics.put(jobId,jobMetrics);
    }
    List<TaskMetrics> stageMetrics=jobMetrics.get(stageIdentifier);
    if (stageMetrics == null) {
      stageMetrics=Lists.newLinkedList();
      jobMetrics.put(stageIdentifier,stageMetrics);
    }
    stageMetrics.add(taskEnd.taskMetrics());
  }
}
