{
  CommandProcessorResponse cpr=driver.run("create table if not exists tab1 (a int, b int) partitioned by (p string) " + "clustered by (a) into 2  buckets stored as orc TBLPROPERTIES ('transactional'='true')");
  checkCmdOnDriver(cpr);
  checkCmdOnDriver(driver.run("insert into tab1 partition(p)(a,b,p) values(1,1,'one'),(2,2,'two')"));
  HiveTxnManager txnMgr2=TxnManagerFactory.getTxnManagerFactory().getTxnManager(conf);
  txnMgr2.openTxn("T2");
  checkCmdOnDriver(driver.compileAndRespond("delete from tab1 where b=2"));
  txnMgr2.acquireLocks(driver.getPlan(),ctx,"T2");
  List<ShowLocksResponseElement> locks=getLocks(txnMgr2);
  Assert.assertEquals("Unexpected lock count",2,locks.size());
  checkLock(LockType.SHARED_WRITE,LockState.ACQUIRED,"default","TAB1","p=two",locks.get(0));
  checkLock(LockType.SHARED_WRITE,LockState.ACQUIRED,"default","TAB1","p=one",locks.get(1));
  txnMgr.openTxn("T3");
  checkCmdOnDriver(driver.compileAndRespond("delete from tab1 where p='two' and b=2"));
  ((DbTxnManager)txnMgr).acquireLocks(driver.getPlan(),ctx,"T3",false);
  locks=getLocks(txnMgr);
  Assert.assertEquals("Unexpected lock count",3,locks.size());
  checkLock(LockType.SHARED_WRITE,LockState.ACQUIRED,"default","TAB1","p=two",locks.get(0));
  checkLock(LockType.SHARED_WRITE,LockState.ACQUIRED,"default","TAB1","p=one",locks.get(1));
  checkLock(LockType.SHARED_WRITE,LockState.WAITING,"default","TAB1","p=two",locks.get(2));
  txnHandler.addDynamicPartitions(new AddDynamicPartitions(txnMgr2.getCurrentTxnId(),"default","tab1",Collections.singletonList("p=two")));
  txnMgr2.commitTxn();
  ((DbLockManager)txnMgr.getLockManager()).checkLock(locks.get(2).getLockid());
  locks=getLocks(txnMgr);
  Assert.assertEquals("Unexpected lock count",1,locks.size());
  checkLock(LockType.SHARED_WRITE,LockState.ACQUIRED,"default","TAB1","p=two",locks.get(0));
  txnHandler.addDynamicPartitions(new AddDynamicPartitions(txnMgr.getCurrentTxnId(),"default","tab1",Collections.singletonList("p=two")));
  LockException exception=null;
  try {
    txnMgr.commitTxn();
  }
 catch (  LockException e) {
    exception=e;
  }
  Assert.assertNotEquals("Expected exception",null,exception);
  Assert.assertEquals("Exception msg doesn't match","Aborting [txnid:3,3] due to a write conflict on default/tab1/p=two committed by [txnid:2,3]",exception.getCause().getMessage());
  Assert.assertEquals("WRITE_SET mismatch: " + TxnDbUtil.queryToString("select * from WRITE_SET"),1,TxnDbUtil.countQueryAgent("select count(*) from WRITE_SET where ws_partition='p=two' and ws_operation_type='d' and ws_table='tab1'"));
  Assert.assertEquals("WRITE_SET mismatch: " + TxnDbUtil.queryToString("select * from WRITE_SET"),1,TxnDbUtil.countQueryAgent("select count(*) from WRITE_SET where ws_partition='p=two' and ws_operation_type='d' and ws_table='tab1'"));
  Assert.assertEquals("COMPLETED_TXN_COMPONENTS mismatch: " + TxnDbUtil.queryToString("select * from COMPLETED_TXN_COMPONENTS"),4,TxnDbUtil.countQueryAgent("select count(*) from COMPLETED_TXN_COMPONENTS where ctc_table='tab1' and ctc_partition is not null"));
}
