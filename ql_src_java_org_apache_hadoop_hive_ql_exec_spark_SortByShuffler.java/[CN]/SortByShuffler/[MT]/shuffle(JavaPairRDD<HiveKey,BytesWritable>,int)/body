{
  JavaPairRDD<HiveKey,BytesWritable> rdd;
  if (totalOrder) {
    if (numPartitions > 0) {
      if (numPartitions > 1 && input.getStorageLevel() == StorageLevel.NONE()) {
        input.persist(StorageLevel.DISK_ONLY());
        sparkPlan.addCachedRDDId(input.id());
      }
      rdd=input.sortByKey(true,numPartitions);
    }
 else {
      rdd=input.sortByKey(true);
    }
  }
 else {
    Partitioner partitioner=new HashPartitioner(numPartitions);
    rdd=input.repartitionAndSortWithinPartitions(partitioner);
  }
  return rdd.mapPartitionsToPair(new ShuffleFunction());
}
