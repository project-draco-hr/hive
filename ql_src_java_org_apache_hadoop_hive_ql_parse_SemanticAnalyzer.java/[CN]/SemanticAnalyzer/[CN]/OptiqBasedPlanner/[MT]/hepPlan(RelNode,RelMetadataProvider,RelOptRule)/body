{
  HepProgramBuilder programBuilder=new HepProgramBuilder();
  for (  RelOptRule rule : rules) {
    programBuilder.addRuleInstance(rule);
  }
  HepPlanner planner=new HepPlanner(programBuilder.build());
  List<RelMetadataProvider> list=Lists.newArrayList();
  list.add(mdProvider);
  planner.registerMetadataProviders(list);
  RelMetadataProvider chainedProvider=ChainedRelMetadataProvider.of(list);
  basePlan.getCluster().setMetadataProvider(new CachingRelMetadataProvider(chainedProvider,planner));
  planner.setRoot(basePlan);
  return planner.findBestExp();
}
