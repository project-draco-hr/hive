{
  String currDB=SessionState.get().getCurrentDatabase();
  if (currDB != null && cteName.startsWith(currDB) && cteName.length() > currDB.length() && cteName.charAt(currDB.length()) == '.') {
    cteName=cteName.substring(currDB.length() + 1);
  }
  StringBuffer qId=new StringBuffer();
  if (qb.getId() != null) {
    qId.append(qb.getId());
  }
  while (qId.length() > 0) {
    String nm=qId + ":" + cteName;
    if (aliasToCTEs.containsKey(nm)) {
      return aliasToCTEs.get(nm);
    }
    int lastIndex=qId.lastIndexOf(":");
    lastIndex=lastIndex < 0 ? 0 : lastIndex;
    qId.setLength(lastIndex);
  }
  return aliasToCTEs.get(cteName);
}
