{
  QBParseInfo qbp=qb.getParseInfo();
  if (qbp.getHavingForClause(dest) != null) {
    if (getGroupByForClause(qbp,dest).size() == 0) {
      throw new SemanticException("HAVING specified without GROUP BY");
    }
    curr=genHavingPlan(dest,qb,curr,aliasToOpInfo);
  }
  if (queryProperties.hasWindowing() && qb.getWindowingSpec(dest) != null) {
    curr=genWindowingPlan(qb.getWindowingSpec(dest),curr);
  }
  curr=genSelectPlan(dest,qb,curr);
  Integer limit=qbp.getDestLimit(dest);
  boolean genReduceSink=false;
  if (qbp.getClusterByForClause(dest) != null) {
    genReduceSink=true;
  }
  if (qbp.getDistributeByForClause(dest) != null) {
    genReduceSink=true;
  }
  if (qbp.getOrderByForClause(dest) != null) {
    genReduceSink=true;
  }
  if (qbp.getSortByForClause(dest) != null) {
    genReduceSink=true;
  }
  if (genReduceSink) {
    int numReducers=-1;
    if (qbp.getOrderByForClause(dest) != null) {
      numReducers=1;
    }
    curr=genReduceSinkPlan(dest,qb,curr,numReducers);
  }
  if (qbp.getIsSubQ()) {
    if (limit != null) {
      curr=genLimitMapRedPlan(dest,qb,curr,limit.intValue(),qbp.getOrderByForClause(dest) != null ? false : true);
    }
  }
 else {
    curr=genConversionOps(dest,qb,curr);
    if (limit != null) {
      boolean extraMRStep=true;
      if (qbp.getOrderByForClause(dest) != null || qb.getIsQuery() && qbp.getClusterByForClause(dest) == null && qbp.getSortByForClause(dest) == null) {
        extraMRStep=false;
      }
      curr=genLimitMapRedPlan(dest,qb,curr,limit.intValue(),extraMRStep);
      qb.getParseInfo().setOuterQueryLimit(limit.intValue());
    }
    if (!SessionState.get().getHiveOperation().equals(HiveOperation.CREATEVIEW)) {
      curr=genFileSinkPlan(dest,qb,curr);
    }
  }
  return curr;
}
