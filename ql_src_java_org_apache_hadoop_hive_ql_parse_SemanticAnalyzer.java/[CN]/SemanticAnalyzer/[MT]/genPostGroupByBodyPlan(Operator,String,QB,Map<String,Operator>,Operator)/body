{
  QBParseInfo qbp=qb.getParseInfo();
  if (qbp.getHavingForClause(dest) != null) {
    if (getGroupByForClause(qbp,dest).size() == 0) {
      throw new SemanticException("HAVING specified without GROUP BY");
    }
    curr=genHavingPlan(dest,qb,curr,aliasToOpInfo);
  }
  if (queryProperties.hasWindowing() && qb.getWindowingSpec(dest) != null) {
    curr=genWindowingPlan(qb.getWindowingSpec(dest),curr);
  }
  curr=genSelectPlan(dest,qb,curr,gbySource);
  Integer limit=qbp.getDestLimit(dest);
  Integer offset=(qbp.getDestLimitOffset(dest) == null) ? 0 : qbp.getDestLimitOffset(dest);
  boolean genReduceSink=false;
  boolean hasOrderBy=false;
  if (qbp.getClusterByForClause(dest) != null) {
    genReduceSink=true;
  }
  if (qbp.getDistributeByForClause(dest) != null) {
    genReduceSink=true;
  }
  if (qbp.getOrderByForClause(dest) != null) {
    genReduceSink=true;
    hasOrderBy=true;
  }
  if (qbp.getSortByForClause(dest) != null) {
    genReduceSink=true;
  }
  if (genReduceSink) {
    int numReducers=-1;
    if (hasOrderBy) {
      numReducers=1;
    }
    curr=genReduceSinkPlan(dest,qb,curr,numReducers,hasOrderBy);
  }
  if (qbp.getIsSubQ()) {
    if (limit != null) {
      curr=genLimitMapRedPlan(dest,qb,curr,offset.intValue(),limit.intValue(),!hasOrderBy);
    }
  }
 else {
    if (limit != null) {
      boolean extraMRStep=true;
      if (hasOrderBy || qb.getIsQuery() && qbp.getClusterByForClause(dest) == null && qbp.getSortByForClause(dest) == null) {
        extraMRStep=false;
      }
      curr=genLimitMapRedPlan(dest,qb,curr,offset.intValue(),limit.intValue(),extraMRStep);
      qb.getParseInfo().setOuterQueryLimit(limit.intValue());
    }
    if (!SessionState.get().getHiveOperation().equals(HiveOperation.CREATEVIEW)) {
      curr=genFileSinkPlan(dest,qb,curr);
    }
  }
  return curr;
}
