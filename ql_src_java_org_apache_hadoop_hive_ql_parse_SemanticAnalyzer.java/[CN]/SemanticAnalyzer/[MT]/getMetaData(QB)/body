{
  try {
    LOG.info("Get metadata for source tables");
    List<String> tabAliases=new ArrayList<String>(qb.getTabAliases());
    for (    String alias : tabAliases) {
      String tab_name=qb.getTabNameForAlias(alias);
      Table tab=null;
      try {
        tab=db.getTable(MetaStoreUtils.DEFAULT_DATABASE_NAME,tab_name);
      }
 catch (      InvalidTableException ite) {
        throw new SemanticException(ErrorMsg.INVALID_TABLE.getMsg(qb.getParseInfo().getSrcForAlias(alias)));
      }
      if (tab.isView()) {
        replaceViewReferenceWithDefinition(qb,tab,tab_name,alias);
        continue;
      }
      if (!InputFormat.class.isAssignableFrom(tab.getInputFormatClass())) {
        throw new SemanticException(ErrorMsg.INVALID_INPUT_FORMAT_TYPE.getMsg(qb.getParseInfo().getSrcForAlias(alias)));
      }
      qb.getMetaData().setSrcForAlias(alias,tab);
    }
    LOG.info("Get metadata for subqueries");
    for (    String alias : qb.getSubqAliases()) {
      QBExpr qbexpr=qb.getSubqForAlias(alias);
      getMetaData(qbexpr);
    }
    LOG.info("Get metadata for destination tables");
    QBParseInfo qbp=qb.getParseInfo();
    for (    String name : qbp.getClauseNamesForDest()) {
      ASTNode ast=qbp.getDestForClause(name);
switch (ast.getToken().getType()) {
case HiveParser.TOK_TAB:
{
          tableSpec ts=new tableSpec(db,conf,ast);
          if (ts.tableHandle.isView()) {
            throw new SemanticException(ErrorMsg.DML_AGAINST_VIEW.getMsg());
          }
          if (!HiveOutputFormat.class.isAssignableFrom(ts.tableHandle.getOutputFormatClass())) {
            throw new SemanticException(ErrorMsg.INVALID_OUTPUT_FORMAT_TYPE.getMsg(ast));
          }
          if (ts.partSpec == null) {
            qb.getMetaData().setDestForAlias(name,ts.tableHandle);
          }
 else {
            qb.getMetaData().setDestForAlias(name,ts.partHandle);
          }
          break;
        }
case HiveParser.TOK_LOCAL_DIR:
case HiveParser.TOK_DIR:
{
        String fname=stripQuotes(ast.getChild(0).getText());
        if ((!qb.getParseInfo().getIsSubQ()) && (((ASTNode)ast.getChild(0)).getToken().getType() == HiveParser.TOK_TMP_FILE)) {
          fname=ctx.getMRTmpFileURI();
          ctx.setResDir(new Path(fname));
          if (qb.isCTAS()) {
            qb.setIsQuery(false);
          }
 else {
            qb.setIsQuery(true);
          }
        }
        qb.getMetaData().setDestForAlias(name,fname,(ast.getToken().getType() == HiveParser.TOK_DIR));
        break;
      }
default :
    throw new SemanticException("Unknown Token Type " + ast.getToken().getType());
}
}
}
 catch (HiveException e) {
LOG.error(org.apache.hadoop.util.StringUtils.stringifyException(e));
throw new SemanticException(e.getMessage(),e);
}
}
