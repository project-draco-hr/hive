{
  try {
    LOG.info("Get metadata for source tables");
    List<String> tabAliases=new ArrayList<String>(qb.getTabAliases());
    for (    String alias : tabAliases) {
      String tab_name=qb.getTabNameForAlias(alias);
      Table tab=null;
      try {
        tab=db.getTable(tab_name);
      }
 catch (      InvalidTableException ite) {
        throw new SemanticException(ErrorMsg.INVALID_TABLE.getMsg(qb.getParseInfo().getSrcForAlias(alias)));
      }
      if (tab.isOffline()) {
        throw new SemanticException(ErrorMsg.OFFLINE_TABLE_OR_PARTITION.getMsg("Table " + qb.getParseInfo().getSrcForAlias(alias)));
      }
      if (tab.isView()) {
        replaceViewReferenceWithDefinition(qb,tab,tab_name,alias);
        continue;
      }
      if (!InputFormat.class.isAssignableFrom(tab.getInputFormatClass())) {
        throw new SemanticException(ErrorMsg.INVALID_INPUT_FORMAT_TYPE.getMsg(qb.getParseInfo().getSrcForAlias(alias)));
      }
      qb.getMetaData().setSrcForAlias(alias,tab);
      if (qb.getParseInfo().isAnalyzeCommand()) {
        tableSpec ts=new tableSpec(db,conf,(ASTNode)ast.getChild(0));
        qb.getParseInfo().addTableSpec(alias,ts);
      }
    }
    LOG.info("Get metadata for subqueries");
    for (    String alias : qb.getSubqAliases()) {
      QBExpr qbexpr=qb.getSubqForAlias(alias);
      getMetaData(qbexpr);
    }
    LOG.info("Get metadata for destination tables");
    QBParseInfo qbp=qb.getParseInfo();
    for (    String name : qbp.getClauseNamesForDest()) {
      ASTNode ast=qbp.getDestForClause(name);
switch (ast.getToken().getType()) {
case HiveParser.TOK_TAB:
{
          tableSpec ts=new tableSpec(db,conf,ast);
          if (ts.tableHandle.isView()) {
            throw new SemanticException(ErrorMsg.DML_AGAINST_VIEW.getMsg());
          }
          Class<?> outputFormatClass=ts.tableHandle.getOutputFormatClass();
          if (!HiveOutputFormat.class.isAssignableFrom(outputFormatClass)) {
            throw new SemanticException(ErrorMsg.INVALID_OUTPUT_FORMAT_TYPE.getMsg(ast,"The class is " + outputFormatClass.toString()));
          }
          if (ts.partHandle == null) {
            qb.getMetaData().setDestForAlias(name,ts.tableHandle);
            if (ts.partSpec != null && ts.partSpec.size() > 0) {
              qb.getMetaData().setPartSpecForAlias(name,ts.partSpec);
            }
          }
 else {
            qb.getMetaData().setDestForAlias(name,ts.partHandle);
          }
          if (HiveConf.getBoolVar(conf,HiveConf.ConfVars.HIVESTATSAUTOGATHER)) {
            qb.getParseInfo().setIsInsertToTable(true);
            qb.getParseInfo().addTableSpec(ts.tableName.toLowerCase(),ts);
          }
          break;
        }
case HiveParser.TOK_LOCAL_DIR:
case HiveParser.TOK_DIR:
{
        String fname=stripQuotes(ast.getChild(0).getText());
        if ((!qb.getParseInfo().getIsSubQ()) && (((ASTNode)ast.getChild(0)).getToken().getType() == HiveParser.TOK_TMP_FILE)) {
          if (qb.isCTAS()) {
            qb.setIsQuery(false);
            String location=conf.getVar(HiveConf.ConfVars.METASTOREWAREHOUSE);
            try {
              fname=ctx.getExternalTmpFileURI(FileUtils.makeQualified(new Path(location),conf).toUri());
            }
 catch (            Exception e) {
              throw new SemanticException("Error creating temporary folder on: " + location,e);
            }
          }
 else {
            qb.setIsQuery(true);
            fname=ctx.getMRTmpFileURI();
          }
          ctx.setResDir(new Path(fname));
        }
        qb.getMetaData().setDestForAlias(name,fname,(ast.getToken().getType() == HiveParser.TOK_DIR));
        break;
      }
default :
    throw new SemanticException("Unknown Token Type " + ast.getToken().getType());
}
}
}
 catch (HiveException e) {
LOG.error(stringifyException(e));
throw new SemanticException(e.getMessage(),e);
}
}
