{
  long deadline=System.currentTimeMillis() + timeout;
synchronized (monitor) {
    while (!completed && !cancelled.get()) {
      if (timeout >= 0) {
        monitor.wait(timeout);
      }
 else {
        monitor.wait();
      }
      if (timeout >= 0 && System.currentTimeMillis() >= deadline) {
        throw new TimeoutException();
      }
    }
  }
  if (error != null) {
    throw new ExecutionException(error);
  }
  return result;
}
