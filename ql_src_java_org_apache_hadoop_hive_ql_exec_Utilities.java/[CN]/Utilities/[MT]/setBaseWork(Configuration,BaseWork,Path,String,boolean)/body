{
  try {
    setPlanPath(conf,hiveScratchDir);
    Path planPath=getPlanPath(conf,name);
    OutputStream out;
    if (HiveConf.getBoolVar(conf,ConfVars.HIVE_RPC_QUERY_PLAN)) {
      ByteArrayOutputStream byteOut=new ByteArrayOutputStream();
      out=new DeflaterOutputStream(byteOut,new Deflater(Deflater.BEST_SPEED));
      serializePlan(w,out,conf);
      LOG.info("Setting plan: " + planPath.toUri().getPath());
      conf.set(planPath.toUri().getPath(),Base64.encodeBase64String(byteOut.toByteArray()));
    }
 else {
      FileSystem fs=planPath.getFileSystem(conf);
      out=fs.create(planPath);
      serializePlan(w,out,conf);
      if (useCache && !ShimLoader.getHadoopShims().isLocalMode(conf)) {
        if (!DistributedCache.getSymlink(conf)) {
          DistributedCache.createSymlink(conf);
        }
        String uriWithLink=planPath.toUri().toString() + "#" + name;
        DistributedCache.addCacheFile(new URI(uriWithLink),conf);
        short replication=(short)conf.getInt("mapred.submit.replication",10);
        fs.setReplication(planPath,replication);
      }
    }
    gWorkMap.put(planPath,w);
    return planPath;
  }
 catch (  Exception e) {
    e.printStackTrace();
    throw new RuntimeException(e);
  }
}
