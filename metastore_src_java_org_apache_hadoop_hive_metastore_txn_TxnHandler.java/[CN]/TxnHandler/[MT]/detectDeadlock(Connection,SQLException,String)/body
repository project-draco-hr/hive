{
  if (dbProduct == null) {
    determineDatabaseProduct(conn);
  }
  if (e instanceof SQLTransactionRollbackException || ((dbProduct == DatabaseProduct.MYSQL || dbProduct == DatabaseProduct.POSTGRES || dbProduct == DatabaseProduct.SQLSERVER) && e.getSQLState().equals("40001")) || (dbProduct == DatabaseProduct.POSTGRES && e.getSQLState().equals("40P01"))|| (dbProduct == DatabaseProduct.ORACLE && (e.getMessage().contains("deadlock detected") || e.getMessage().contains("can't serialize access for this transaction")))) {
    if (deadlockCnt++ < ALLOWED_REPEATED_DEADLOCKS) {
      LOG.warn("Deadlock detected in " + caller + ", trying again.");
      throw new DeadlockException();
    }
 else {
      LOG.error("Too many repeated deadlocks in " + caller + ", giving up.");
      deadlockCnt=0;
    }
  }
}
