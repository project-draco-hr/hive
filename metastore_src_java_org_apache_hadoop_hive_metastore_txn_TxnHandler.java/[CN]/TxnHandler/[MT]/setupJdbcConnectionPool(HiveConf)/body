{
  if (connPool != null)   return;
  String driverUrl=HiveConf.getVar(conf,HiveConf.ConfVars.METASTORECONNECTURLKEY);
  String user=getMetastoreJdbcUser(conf);
  String passwd=getMetastoreJdbcPasswd(conf);
  String connectionPooler=conf.getVar(HiveConf.ConfVars.METASTORE_CONNECTION_POOLING_TYPE).toLowerCase();
  if ("bonecp".equals(connectionPooler)) {
    BoneCPConfig config=new BoneCPConfig();
    config.setJdbcUrl(driverUrl);
    config.setConnectionTimeoutInMs(60000);
    config.setMaxConnectionsPerPartition(10);
    config.setPartitionCount(1);
    config.setUser(user);
    config.setPassword(passwd);
    connPool=new BoneCPDataSource(config);
    doRetryOnConnPool=true;
  }
 else   if ("dbcp".equals(connectionPooler)) {
    ObjectPool objectPool=new GenericObjectPool();
    ConnectionFactory connFactory=new DriverManagerConnectionFactory(driverUrl,user,passwd);
    PoolableConnectionFactory poolConnFactory=new PoolableConnectionFactory(connFactory,objectPool,null,null,false,true);
    connPool=new PoolingDataSource(objectPool);
  }
 else   if ("none".equals(connectionPooler)) {
    LOG.info("Choosing not to pool JDBC connections");
    connPool=new NoPoolConnectionPool(conf);
  }
 else {
    throw new RuntimeException("Unknown JDBC connection pooling " + connectionPooler);
  }
}
