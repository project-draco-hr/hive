{
  if (connPool != null)   return;
  String driverUrl=HiveConf.getVar(conf,HiveConf.ConfVars.METASTORECONNECTURLKEY);
  String user=HiveConf.getVar(conf,HiveConf.ConfVars.METASTORE_CONNECTION_USER_NAME);
  String passwd;
  try {
    passwd=ShimLoader.getHadoopShims().getPassword(conf,HiveConf.ConfVars.METASTOREPWD.varname);
  }
 catch (  IOException err) {
    throw new SQLException("Error getting metastore password",err);
  }
  String connectionPooler=HiveConf.getVar(conf,HiveConf.ConfVars.METASTORE_CONNECTION_POOLING_TYPE).toLowerCase();
  if ("bonecp".equals(connectionPooler)) {
    BoneCPConfig config=new BoneCPConfig();
    config.setJdbcUrl(driverUrl);
    config.setConnectionTimeoutInMs(60000);
    config.setMaxConnectionsPerPartition(10);
    config.setPartitionCount(1);
    config.setUser(user);
    config.setPassword(passwd);
    connPool=new BoneCPDataSource(config);
    doRetryOnConnPool=true;
  }
 else   if ("dbcp".equals(connectionPooler)) {
    ObjectPool objectPool=new GenericObjectPool();
    ConnectionFactory connFactory=new DriverManagerConnectionFactory(driverUrl,user,passwd);
    PoolableConnectionFactory poolConnFactory=new PoolableConnectionFactory(connFactory,objectPool,null,null,false,true);
    connPool=new PoolingDataSource(objectPool);
  }
 else {
    throw new RuntimeException("Unknown JDBC connection pooling " + connectionPooler);
  }
}
